<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preset Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600;700&display=swap');
:root{
  --bg:#080b0f;--surface:#0d1117;--surface2:#141b24;--border:#1c2432;--border2:#263040;
  --accent:#00e5ff;--accent2:#39ff14;--warn:#ffb347;--danger:#ff2d55;--purple:#a855f7;
  --text:#c8d6e5;--muted:#4a5568;--muted2:#2d3748;
  --ag:0 0 20px rgba(0,229,255,.22);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 15% 50%,rgba(0,229,255,.03) 0%,transparent 55%),radial-gradient(ellipse at 85% 15%,rgba(57,255,20,.025) 0%,transparent 55%);pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.07) 2px,rgba(0,0,0,.07) 4px);pointer-events:none;z-index:0;}

.app{max-width:1000px;margin:0 auto;padding:24px 20px;position:relative;z-index:1;}

.header{margin-bottom:28px;}
.header h1{font-family:'Share Tech Mono',monospace;font-size:1.1rem;color:var(--accent);text-shadow:0 0 16px rgba(0,229,255,.4);letter-spacing:4px;text-transform:uppercase;}
.header p{color:var(--muted);font-size:.68rem;letter-spacing:2px;text-transform:uppercase;margin-top:4px;}

.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:18px 20px;margin-bottom:16px;}
.card-title{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.card-title::after{content:'';flex:1;height:1px;background:var(--border);}

.drop-zone{border:2px dashed var(--border2);border-radius:8px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.drop-zone:hover,.drop-zone.drag-over{border-color:rgba(0,229,255,.4);background:rgba(0,229,255,.03);}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;}
.drop-icon{font-size:2rem;opacity:.3;margin-bottom:10px;}
.drop-title{font-family:'Share Tech Mono',monospace;font-size:.76rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.drop-sub{font-size:.66rem;color:var(--muted);opacity:.6;}
.drop-zone.has-file .drop-icon{opacity:1;}
.drop-zone.has-file{border-color:rgba(57,255,20,.3);background:rgba(57,255,20,.02);}
.drop-zone.has-file .drop-title{color:var(--accent2);}

.mapper-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.mapper-field{display:flex;flex-direction:column;gap:5px;}
.map-label{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.map-label span{color:var(--accent);margin-right:3px;}
.map-select{width:100%;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.7rem;padding:7px 9px;outline:none;transition:border-color .15s;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='%234a5568' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;}
.map-select:focus{border-color:var(--accent);}
.map-select.mapped{border-color:rgba(0,229,255,.3);}

.sheet-tabs{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px;}
.sheet-tab{font-family:'Share Tech Mono',monospace;font-size:.62rem;letter-spacing:1.5px;padding:4px 10px;border-radius:5px;border:1px solid var(--border);cursor:pointer;transition:all .15s;color:var(--muted);}
.sheet-tab:hover{border-color:var(--border2);color:var(--text);}
.sheet-tab.active{background:rgba(0,229,255,.08);border-color:rgba(0,229,255,.3);color:var(--accent);}
.sheet-info{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--muted);margin-bottom:10px;}

.preview-wrap{overflow-x:auto;border-radius:6px;border:1px solid var(--border);max-height:220px;overflow-y:auto;}
table.preview-table{width:100%;border-collapse:collapse;font-size:.7rem;}
.preview-table th{background:var(--surface2);font-family:'Share Tech Mono',monospace;font-size:.54rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:6px 9px;text-align:left;border-bottom:1px solid var(--border);position:sticky;top:0;}
.preview-table td{padding:5px 9px;border-bottom:1px solid rgba(28,36,50,.5);white-space:nowrap;}
.preview-table tr:last-child td{border-bottom:none;}
.preview-table tr:hover td{background:rgba(255,255,255,.02);}
.col-highlight{color:var(--accent)!important;background:rgba(0,229,255,.04)!important;}

.btn{background:rgba(0,229,255,.07);border:1px solid rgba(0,229,255,.22);color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:.64rem;letter-spacing:2px;text-transform:uppercase;padding:9px 16px;border-radius:6px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:hover{background:rgba(0,229,255,.14);}
.btn:disabled{opacity:.3;cursor:not-allowed;}
.btn-g{background:rgba(57,255,20,.07);border-color:rgba(57,255,20,.22);color:var(--accent2);}
.btn-g:hover{background:rgba(57,255,20,.14);}
.btn-p{background:rgba(168,85,247,.07);border-color:rgba(168,85,247,.22);color:var(--purple);}
.btn-p:hover{background:rgba(168,85,247,.14);}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}

.results-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px;}
.stat-pill{display:inline-flex;align-items:center;gap:5px;background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-family:'Share Tech Mono',monospace;font-size:.62rem;}
.stat-pill .sv{color:var(--accent);margin-left:3px;}
.stat-pill.g .sv{color:var(--accent2);}
.stat-pill.w .sv{color:var(--warn);}
.stat-pill.r .sv{color:var(--danger);}

/* â”€â”€ PRESET CARDS â”€â”€ */
.preset-list{display:flex;flex-direction:column;gap:8px;}

.preset-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;overflow:hidden;transition:opacity .25s,border-color .2s;}
.preset-card.resolved{border-color:rgba(57,255,20,.18);}
.preset-card.conflict{border-color:rgba(255,179,71,.25);}
.preset-card.skipped{opacity:.35;border-color:rgba(255,45,85,.2)!important;}
.preset-card.skipped .pc-body{pointer-events:none;user-select:none;}

.pc-header{display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.25);}
.pc-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;transition:all .2s;}
.preset-card.resolved .pc-dot{background:var(--accent2);box-shadow:0 0 6px var(--accent2);}
.preset-card.conflict .pc-dot{background:var(--warn);box-shadow:0 0 6px var(--warn);}
.preset-card.skipped .pc-dot{background:var(--danger);box-shadow:0 0 6px var(--danger);}
.pc-name{font-family:'Share Tech Mono',monospace;font-size:.78rem;color:var(--accent);flex:1;letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.preset-card.skipped .pc-name{color:var(--danger);text-decoration:line-through;}

.pc-badge{font-family:'Share Tech Mono',monospace;font-size:.54rem;letter-spacing:1.5px;padding:2px 8px;border-radius:8px;border:1px solid;white-space:nowrap;flex-shrink:0;}
.pc-badge.ok{color:var(--accent2);border-color:rgba(57,255,20,.3);background:rgba(57,255,20,.06);}
.pc-badge.warn{color:var(--warn);border-color:rgba(255,179,71,.35);background:rgba(255,179,71,.07);}
.pc-badge.skip{color:var(--danger);border-color:rgba(255,45,85,.35);background:rgba(255,45,85,.07);}

.pc-unit-count{font-family:'Share Tech Mono',monospace;font-size:.54rem;color:var(--muted);background:var(--muted2);padding:2px 7px;border-radius:8px;white-space:nowrap;flex-shrink:0;}

/* Skip toggle */
.skip-toggle{display:flex;align-items:center;gap:6px;cursor:pointer;flex-shrink:0;padding:2px 0;}
.skip-track{width:30px;height:16px;background:var(--muted2);border-radius:16px;position:relative;transition:background .2s;flex-shrink:0;}
.skip-track::after{content:'';position:absolute;left:2px;top:2px;width:12px;height:12px;background:#fff;border-radius:50%;transition:transform .2s;}
.skip-toggle.on .skip-track{background:var(--danger);}
.skip-toggle.on .skip-track::after{transform:translateX(14px);}
.skip-lbl{font-family:'Share Tech Mono',monospace;font-size:.54rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);transition:color .2s;white-space:nowrap;}
.skip-toggle.on .skip-lbl{color:var(--danger);}

/* Card body */
.pc-body{}

/* Single-variant row */
.sv-row{display:grid;grid-template-columns:1fr 90px 100px 70px;align-items:stretch;}
.sv-cell{padding:9px 14px;font-family:'Share Tech Mono',monospace;font-size:.7rem;}
.sv-cell+.sv-cell{border-left:1px solid var(--border);}
.sv-cpu{color:var(--text);}
.sv-ram{color:var(--accent);}
.sv-storage{color:var(--purple);}
.sv-count{color:var(--muted);text-align:right;}

/* Variant table */
.var-table{width:100%;border-collapse:collapse;}
.var-table thead tr{background:rgba(0,0,0,.3);}
.var-table th{font-family:'Share Tech Mono',monospace;font-size:.5rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:5px 14px;text-align:left;border-bottom:1px solid var(--border);}
.var-table th:first-child{width:40px;text-align:center;padding-left:12px;}
.var-table th:last-child{text-align:right;}
.var-table td{padding:8px 14px;border-bottom:1px solid rgba(28,36,50,.4);vertical-align:middle;}
.var-table td:first-child{padding-left:12px;text-align:center;}
.var-table td:last-child{text-align:right;}
.var-table tbody tr{cursor:pointer;transition:background .1s;}
.var-table tbody tr:last-child td{border-bottom:none;}
.var-table tbody tr:hover{background:rgba(255,255,255,.02);}
.var-table tbody tr.sel{background:rgba(57,255,20,.04);}
.var-table tbody tr.sel td{border-bottom-color:rgba(57,255,20,.08);}

.vr-radio{width:13px;height:13px;border-radius:50%;border:1.5px solid var(--muted);display:inline-block;transition:all .15s;vertical-align:middle;}
.sel .vr-radio{border-color:var(--accent2);background:var(--accent2);box-shadow:0 0 7px var(--accent2);}

.vr-cpu{color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.68rem;}
.vr-ram{color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:.72rem;}
.vr-storage{color:var(--purple);font-family:'Share Tech Mono',monospace;font-size:.72rem;}
.vr-count{color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:.62rem;}

/* Output */
.output-box{background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:6px;padding:14px;font-family:'Share Tech Mono',monospace;font-size:.68rem;color:var(--accent2);line-height:1.6;max-height:300px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;}

.status-msg{font-family:'Share Tech Mono',monospace;font-size:.7rem;padding:9px 12px;border-radius:6px;border:1px solid var(--border);margin-bottom:12px;display:none;}
.status-msg.show{display:block;}
.status-msg.ok{border-color:rgba(57,255,20,.3);color:var(--accent2);background:rgba(57,255,20,.04);}
.status-msg.err{border-color:rgba(255,45,85,.3);color:var(--danger);background:rgba(255,45,85,.04);}
.status-msg.warn{border-color:rgba(255,179,71,.3);color:var(--warn);background:rgba(255,179,71,.04);}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>â—ˆ Preset Generator</h1>
    <p>Import pallet spreadsheet â†’ extract model presets â†’ export to AssetSaleLister</p>
  </div>

  <div class="card" id="stepUpload">
    <div class="card-title">â–¸ Step 1 â€” Load Spreadsheet</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
      <div class="drop-icon">ðŸ“‚</div>
      <div class="drop-title" id="dropTitle">Drop .xlsx or .csv here â€” or click to browse</div>
      <div class="drop-sub" id="dropSub">Supports multi-sheet .xlsx files and .csv exports</div>
    </div>
  </div>

  <div class="card" id="stepMap" style="display:none;">
    <div class="card-title">â–¸ Step 2 â€” Map Columns</div>
    <div id="sheetTabsWrap" style="display:none;">
      <div class="map-label" style="margin-bottom:7px;">Sheets â€” select which to process:</div>
      <div class="sheet-tabs" id="sheetTabs"></div>
      <div class="sheet-info" id="sheetInfo"></div>
    </div>
    <div class="mapper-grid">
      <div class="mapper-field">
        <div class="map-label"><span>*</span>Model</div>
        <select class="map-select" id="colModel"><option value="">â€” select column â€”</option></select>
      </div>
      <div class="mapper-field">
        <div class="map-label"><span>*</span>CPU</div>
        <select class="map-select" id="colCpu"><option value="">â€” select column â€”</option></select>
      </div>
      <div class="mapper-field">
        <div class="map-label"><span>*</span>RAM (GB)</div>
        <select class="map-select" id="colRam"><option value="">â€” select column â€”</option></select>
      </div>
      <div class="mapper-field">
        <div class="map-label"><span>*</span>Storage (GB)</div>
        <select class="map-select" id="colStorage"><option value="">â€” select column â€”</option></select>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn" onclick="previewData()">â–¸ Preview Data</button>
    </div>
    <div id="previewWrap" style="display:none;margin-top:14px;">
      <div class="map-label" style="margin-bottom:7px;">Preview <span id="previewSheetName" style="color:var(--accent)"></span> â€” first 10 rows:</div>
      <div class="preview-wrap"><table class="preview-table" id="previewTable"></table></div>
    </div>
  </div>

  <div class="card" id="stepProcess" style="display:none;">
    <div class="card-title">â–¸ Step 3 â€” Review &amp; Resolve</div>
    <div id="statusMsg" class="status-msg"></div>
    <div class="results-header" id="resultsHeader"></div>
    <div class="preset-list" id="presetList"></div>
    <div class="btn-row">
      <button class="btn btn-g" onclick="generateJSON()">â¬‡ Export Presets JSON</button>
      <button class="btn btn-p" onclick="copyJSON()">âŽ˜ Copy to Clipboard</button>
    </div>
  </div>

  <div class="card" id="stepOutput" style="display:none;">
    <div class="card-title">â–¸ Export</div>
    <div class="output-box" id="outputBox"></div>
    <div class="btn-row">
      <button class="btn" onclick="downloadJSON()">â¬‡ Download .json</button>
      <button class="btn btn-p" onclick="copyJSON()">âŽ˜ Copy</button>
    </div>
  </div>
</div>

<script>
let workbook=null, allSheets={}, selectedSheets=new Set(), detectedColumns=[];
let resolvedPresets={}, conflictMap={}, skippedModels=new Set(), cleanPresets=[];

// â”€â”€ FILE LOAD â”€â”€
const dropZone=document.getElementById('dropZone');
const fileInput=document.getElementById('fileInput');
dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over');});
dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('drag-over');if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0]);});
fileInput.addEventListener('change',e=>{if(e.target.files[0])loadFile(e.target.files[0]);});

function loadFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      workbook=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      allSheets={};
      workbook.SheetNames.forEach(n=>{allSheets[n]=XLSX.utils.sheet_to_json(workbook.Sheets[n],{defval:''});});
      dropZone.classList.add('has-file');
      document.getElementById('dropTitle').textContent='âœ“ '+file.name;
      document.getElementById('dropSub').textContent=workbook.SheetNames.length+' sheet(s) Â· '+Object.values(allSheets).reduce((a,r)=>a+r.length,0)+' total rows';
      setupMapper();
    }catch(err){showStatus('err','Failed to parse: '+err.message);}
  };
  reader.readAsArrayBuffer(file);
}

function setupMapper(){
  document.getElementById('stepMap').style.display='';
  const names=workbook.SheetNames;
  selectedSheets=new Set(names);
  const tabsEl=document.getElementById('sheetTabs');
  tabsEl.innerHTML='';
  if(names.length>1){
    document.getElementById('sheetTabsWrap').style.display='';
    names.forEach(name=>{
      const t=document.createElement('div');
      t.className='sheet-tab active';
      t.textContent=name+' ('+allSheets[name].length+')';
      t.onclick=()=>{
        if(selectedSheets.has(name)){if(selectedSheets.size>1){selectedSheets.delete(name);t.classList.remove('active');}}
        else{selectedSheets.add(name);t.classList.add('active');}
        updateSheetInfo();refreshCols();
      };
      tabsEl.appendChild(t);
    });
    updateSheetInfo();
  }
  refreshCols();
  autoMap();
}

function updateSheetInfo(){
  const total=[...selectedSheets].reduce((a,s)=>a+allSheets[s].length,0);
  document.getElementById('sheetInfo').textContent=selectedSheets.size+' sheet(s) Â· '+total+' rows';
}

function refreshCols(){
  const first=[...selectedSheets][0];
  if(!first||!allSheets[first]?.length)return;
  detectedColumns=Object.keys(allSheets[first][0]);
  ['colModel','colCpu','colRam','colStorage'].forEach(id=>{
    const sel=document.getElementById(id),prev=sel.value;
    sel.innerHTML='<option value="">â€” select column â€”</option>';
    detectedColumns.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;if(c===prev)o.selected=true;sel.appendChild(o);});
  });
}

function autoMap(){
  const kw={colModel:['model','models','laptop model','computer model','device model','name','product name','description'],colCpu:['cpu','processor','proc','core','intel','amd'],colRam:['ram','memory','mem','gb ram'],colStorage:['storage','hdd','ssd','disk','drive','hard drive','capacity']};
  detectedColumns.forEach(c=>{const lc=c.toLowerCase();Object.entries(kw).forEach(([id,ks])=>{const s=document.getElementById(id);if(!s.value&&ks.some(k=>lc.includes(k)))s.value=c;});});
  updateMapStyles();
}
function updateMapStyles(){['colModel','colCpu','colRam','colStorage'].forEach(id=>document.getElementById(id).classList.toggle('mapped',!!document.getElementById(id).value));}
['colModel','colCpu','colRam','colStorage'].forEach(id=>document.getElementById(id).addEventListener('change',updateMapStyles));

function previewData(){
  const mc=document.getElementById('colModel').value;
  if(!mc){showStatus('err','Select the Model column first.');return;}
  const cc=document.getElementById('colCpu').value,rc=document.getElementById('colRam').value,sc=document.getElementById('colStorage').value;
  const hl=new Set([mc,cc,rc,sc].filter(Boolean));
  const first=[...selectedSheets][0];
  const rows=allSheets[first].slice(0,10);
  document.getElementById('previewTable').innerHTML=
    '<thead><tr>'+detectedColumns.map(c=>`<th class="${hl.has(c)?'col-highlight':''}">${c}</th>`).join('')+'</tr></thead>'+
    '<tbody>'+rows.map(r=>'<tr>'+detectedColumns.map(c=>`<td class="${hl.has(c)?'col-highlight':''}">${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
  document.getElementById('previewSheetName').textContent=first;
  document.getElementById('previewWrap').style.display='';
  document.getElementById('stepProcess').style.display='';
  processData();
}

// â”€â”€ PROCESS â”€â”€
function processData(){
  const mc=document.getElementById('colModel').value,cc=document.getElementById('colCpu').value;
  const rc=document.getElementById('colRam').value,sc=document.getElementById('colStorage').value;
  const allRows=[];selectedSheets.forEach(s=>allRows.push(...allSheets[s]));
  const mm={};
  allRows.forEach(row=>{
    const model=String(row[mc]||'').trim();if(!model)return;
    const cpu=cc?String(row[cc]||'').trim():'',ram=rc?String(row[rc]||'').trim():'',storage=sc?String(row[sc]||'').trim():'';
    const key=`${cpu}|${ram}|${storage}`;
    if(!mm[model])mm[model]={};
    if(!mm[model][key])mm[model][key]={cpu,ram,storage,count:0};
    mm[model][key].count++;
  });
  conflictMap={};resolvedPresets={};skippedModels=new Set();
  let clean=0,conflict=0;
  Object.entries(mm).forEach(([model,variants])=>{
    const list=Object.values(variants).sort((a,b)=>b.count-a.count);
    if(list.length===1){resolvedPresets[model]={...list[0],model};clean++;}
    else{conflictMap[model]=list.map(v=>({...v,model}));conflict++;resolvedPresets[model]={...list[0],model};}
  });
  const total=clean+conflict;
  document.getElementById('resultsHeader').innerHTML=`
    <div class="stat-pill g"><span>Total Models</span><span class="sv">${total}</span></div>
    <div class="stat-pill"><span>Auto-resolved</span><span class="sv">${clean}</span></div>
    <div class="stat-pill w"><span>Conflicts</span><span class="sv">${conflict}</span></div>
    <div class="stat-pill r" id="skipPill" style="display:none;"><span>Skipped</span><span class="sv" id="skipCount">0</span></div>`;
  if(conflict>0)showStatus('warn',conflict+' model(s) have multiple spec variants â€” pick one per conflict below.');
  else showStatus('ok','All '+total+' models resolved. Ready to export.');
  renderList();
}

function renderList(){
  const list=document.getElementById('presetList');
  list.innerHTML='';
  const allModels=[...Object.keys(conflictMap).sort(),...Object.keys(resolvedPresets).filter(m=>!conflictMap[m]).sort()];
  allModels.forEach(model=>list.appendChild(buildCard(model)));
}

function buildCard(model){
  const isConflict=!!conflictMap[model];
  const variants=isConflict?conflictMap[model]:[resolvedPresets[model]];
  const totalUnits=variants.reduce((a,v)=>a+v.count,0);
  const isSkipped=skippedModels.has(model);
  const slug=slugify(model);

  const card=document.createElement('div');
  card.id='card_'+slug;
  card.className='preset-card '+(isSkipped?'skipped':isConflict?'conflict':'resolved');

  // Header
  const badge=isSkipped?`<span class="pc-badge skip">SKIP</span>`:isConflict?`<span class="pc-badge warn">âš  ${variants.length} variants</span>`:`<span class="pc-badge ok">âœ“ resolved</span>`;
  card.innerHTML=`
    <div class="pc-header">
      <div class="pc-dot"></div>
      <div class="pc-name">${esc(model)}</div>
      ${badge}
      <span class="pc-unit-count">${totalUnits} unit${totalUnits!==1?'s':''}</span>
      <div class="skip-toggle ${isSkipped?'on':''}" id="tog_${slug}" onclick="toggleSkip('${esc(model)}')">
        <div class="skip-track"></div>
        <span class="skip-lbl">Skip</span>
      </div>
    </div>
    <div class="pc-body" id="body_${slug}"></div>`;

  // Body
  const body=card.querySelector('.pc-body');
  if(!isConflict){
    const v=variants[0];
    body.innerHTML=`<div class="sv-row">
      <div class="sv-cell sv-cpu">${esc(v.cpu||'â€”')}</div>
      <div class="sv-cell sv-ram">${v.ram?parseNum(v.ram)+' GB':'â€”'}</div>
      <div class="sv-cell sv-storage">${v.storage?parseNum(v.storage)+' GB':'â€”'}</div>
      <div class="sv-cell sv-count">${v.count} unit${v.count!==1?'s':''}</div>
    </div>`;
  } else {
    const rows=variants.map((v,i)=>`
      <tr class="${i===0?'sel':''}" id="vr_${slug}_${i}" onclick="selectVariant('${esc(model)}',${i})">
        <td><div class="vr-radio"></div></td>
        <td class="vr-cpu">${esc(v.cpu||'â€”')}</td>
        <td class="vr-ram">${v.ram?parseNum(v.ram)+' GB':'â€”'}</td>
        <td class="vr-storage">${v.storage?parseNum(v.storage)+' GB':'â€”'}</td>
        <td class="vr-count">${v.count} unit${v.count!==1?'s':''}</td>
      </tr>`).join('');
    body.innerHTML=`<table class="var-table">
      <thead><tr><th></th><th>CPU</th><th>RAM</th><th>Storage</th><th style="text-align:right">Units</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  }
  return card;
}

function selectVariant(model,idx){
  const slug=slugify(model);
  conflictMap[model].forEach((_,i)=>{
    const r=document.getElementById(`vr_${slug}_${i}`);
    if(r)r.classList.toggle('sel',i===idx);
  });
  resolvedPresets[model]={...conflictMap[model][idx],model};
}

function toggleSkip(model){
  if(skippedModels.has(model))skippedModels.delete(model);
  else skippedModels.add(model);
  const isSkipped=skippedModels.has(model);
  const isConflict=!!conflictMap[model];
  const slug=slugify(model);
  const card=document.getElementById('card_'+slug);
  if(!card)return;
  card.className='preset-card '+(isSkipped?'skipped':isConflict?'conflict':'resolved');
  const badge=card.querySelector('.pc-badge');
  if(badge){badge.className='pc-badge '+(isSkipped?'skip':isConflict?'warn':'ok');badge.textContent=isSkipped?'SKIP':isConflict?`âš  ${conflictMap[model].length} variants`:'âœ“ resolved';}
  const tog=document.getElementById('tog_'+slug);
  if(tog)tog.className='skip-toggle '+(isSkipped?'on':'');
  const pill=document.getElementById('skipPill');
  if(pill){pill.style.display=skippedModels.size>0?'':'none';document.getElementById('skipCount').textContent=skippedModels.size;}
}

// â”€â”€ EXPORT â”€â”€
function generateJSON(){
  cleanPresets=Object.entries(resolvedPresets).filter(([m])=>!skippedModels.has(m)).map(([model,v])=>{
    const ram=parseNum(v.ram),storage=parseNum(v.storage);
    return{id:'pr_'+Math.floor(Math.random()*9e15),name:model,mfr:guessMfr(model,v.cpu),cpu:v.cpu||'',ram:ram?String(ram):'',storage:storage?String(storage):'',noStorage:!storage,weight:0};
  });
  const skipped=skippedModels.size;
  document.getElementById('outputBox').textContent=JSON.stringify(cleanPresets,null,2);
  document.getElementById('stepOutput').style.display='';
  document.getElementById('stepOutput').scrollIntoView({behavior:'smooth'});
  showStatus('ok',`${cleanPresets.length} preset${cleanPresets.length!==1?'s':''} exported${skipped>0?' Â· '+skipped+' model'+(skipped!==1?'s':'')+' skipped':''}.  Weight defaults to 0 â€” set in AssetSaleLister.`);
}

function parseNum(val){if(!val)return 0;const n=parseInt(String(val).replace(/[^0-9]/g,''),10);return isNaN(n)?0:n;}

function guessMfr(model,cpu){
  const m=(model||'').toLowerCase();
  if(m.includes('dell')||m.includes('latitude')||m.includes('optiplex')||m.includes('precision')||m.includes('inspiron')||m.includes('vostro'))return'Dell';
  if(m.includes('lenovo')||m.includes('thinkpad')||m.includes('thinkcentre'))return'Lenovo';
  if(m.includes('hp')||m.includes('elitebook')||m.includes('probook')||m.includes('pavilion')||m.includes('envy'))return'HP';
  if(m.includes('apple')||m.includes('macbook')||m.includes('imac'))return'Apple';
  if(m.includes('microsoft')||m.includes('surface'))return'Microsoft';
  if(m.includes('asus'))return'ASUS';
  if(m.includes('acer'))return'Acer';
  if(m.includes('toshiba'))return'Toshiba';
  return'';
}

function downloadJSON(){
  if(!cleanPresets.length){generateJSON();return;}
  const d=new Date(),fname=`AssetPresets_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.json`;
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(cleanPresets,null,2)],{type:'application/json'}));a.download=fname;a.click();
}

function copyJSON(){
  const t=document.getElementById('outputBox').textContent;
  if(!t){generateJSON();return;}
  navigator.clipboard.writeText(t).then(()=>showStatus('ok','Copied to clipboard!'));
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function slugify(s){return s.replace(/[^a-z0-9]/gi,'_').toLowerCase();}
function showStatus(type,msg){const el=document.getElementById('statusMsg');el.className='status-msg show '+type;el.textContent=msg;}
</script>
</body>
</html>
