<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Lister + OCR</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600;700&display=swap');
:root{
  --bg:#080b0f;--surface:#0d1117;--surface2:#141b24;--border:#1c2432;--border2:#263040;
  --accent:#00e5ff;--accent2:#39ff14;--warn:#ffb347;--danger:#ff2d55;--purple:#a855f7;
  --text:#c8d6e5;--muted:#4a5568;--muted2:#2d3748;
  --ag:0 0 20px rgba(0,229,255,.22);
  --ocr-accent:#e8ff00;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 15% 50%,rgba(0,229,255,.03) 0%,transparent 55%),radial-gradient(ellipse at 85% 15%,rgba(57,255,20,.025) 0%,transparent 55%);pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.07) 2px,rgba(0,0,0,.07) 4px);pointer-events:none;z-index:0;}

.app-layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh;position:relative;z-index:1;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto;}
.sidebar-logo{padding:16px 16px 12px;border-bottom:1px solid var(--border);}
.sidebar-logo h1{font-family:'Share Tech Mono',monospace;font-size:.88rem;color:var(--accent);text-shadow:0 0 16px rgba(0,229,255,.4);letter-spacing:3px;text-transform:uppercase;}
.sidebar-logo p{color:var(--muted);font-size:.6rem;letter-spacing:2px;text-transform:uppercase;margin-top:3px;}
.count-tiles{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:9px 13px;}
.count-tile{background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:6px;padding:9px;text-align:center;}
.ctn{font-family:'Share Tech Mono',monospace;font-size:1.5rem;line-height:1;color:var(--accent);}
.ctl{font-family:'Share Tech Mono',monospace;font-size:.5rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.count-tile.global .ctn{color:var(--accent2);}
.sidebar-section{padding:9px 13px 5px;}
.sidebar-label{font-family:'Share Tech Mono',monospace;font-size:.56rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;gap:4px;}
.pallets-list{display:flex;flex-direction:column;gap:2px;margin-bottom:4px;}
.pallet-item{display:flex;align-items:center;gap:5px;padding:6px 8px;border-radius:5px;border:1px solid transparent;cursor:pointer;transition:all .15s;}
.pallet-item:hover{background:rgba(255,255,255,.04);border-color:var(--border2);}
.pallet-item.active{background:rgba(0,229,255,.07);border-color:rgba(0,229,255,.25);}
.pallet-item.damaged-pallet-item{border-color:rgba(255,45,85,.15)!important;}
.pallet-item.damaged-pallet-item .pallet-dot{background:var(--danger)!important;box-shadow:0 0 4px var(--danger)!important;}
.pallet-item.damaged-pallet-item .pallet-name{color:var(--danger)!important;}
.pallet-item.damaged-pallet-item.active{background:rgba(255,45,85,.07)!important;border-color:rgba(255,45,85,.35)!important;}
.pallet-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;background:var(--muted2);}
.pallet-item.active .pallet-dot{background:var(--accent);box-shadow:0 0 5px var(--accent);}
.pallet-name{flex:1;font-family:'Share Tech Mono',monospace;font-size:.7rem;letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text);}
.pallet-item.active .pallet-name{color:var(--accent);}
.pallet-count{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--muted);background:var(--muted2);padding:1px 5px;border-radius:7px;}
.pallet-item.active .pallet-count{background:rgba(0,229,255,.15);color:var(--accent);}
.pallet-del,.del-btn{opacity:0;background:none;border:none;color:var(--danger);cursor:pointer;font-size:.74rem;padding:1px 3px;border-radius:3px;transition:opacity .15s;}
.pallet-item:hover .pallet-del,.preset-item:hover .del-btn{opacity:1;}
.edit-btn{opacity:0;background:none;border:none;color:var(--accent);cursor:pointer;font-size:.76rem;padding:1px 3px;border-radius:3px;transition:opacity .15s;}
.preset-item:hover .edit-btn{opacity:1;}
.damaged-section-label{font-family:'Share Tech Mono',monospace;font-size:.54rem;letter-spacing:2px;text-transform:uppercase;color:var(--danger);padding:6px 8px 3px;opacity:.7;display:flex;align-items:center;gap:5px;}
.damaged-section-label::after{content:'';flex:1;height:1px;background:rgba(255,45,85,.2);}
.preset-search{width:100%;background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.68rem;padding:5px 8px;outline:none;margin-bottom:6px;transition:border-color .15s;}
.preset-search:focus{border-color:rgba(168,85,247,.4);}
.preset-search::placeholder{color:var(--muted);}
.preset-item{display:flex;align-items:center;gap:5px;padding:6px 8px;border-radius:5px;border:1px solid transparent;cursor:pointer;transition:all .15s;}
.preset-item:hover{background:rgba(255,255,255,.04);border-color:var(--border2);}
.preset-item.active{background:rgba(168,85,247,.08);border-color:rgba(168,85,247,.3);}
.preset-item.damaged-preset .preset-name{color:var(--danger);}
.preset-item.damaged-preset.active{background:rgba(255,45,85,.07);border-color:rgba(255,45,85,.3);}
.preset-name{font-family:'Share Tech Mono',monospace;font-size:.68rem;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.no-weight-warn{color:var(--warn);font-size:.62rem;flex-shrink:0;}
.sdiv{height:1px;background:var(--border);margin:2px 0 7px;}
.sidebar-bottom{margin-top:auto;padding:11px 13px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:4px;}

/* toggles */
.toggle-switch{position:relative;width:32px;height:17px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-track{position:absolute;inset:0;background:var(--muted2);border-radius:17px;cursor:pointer;transition:background .2s;}
.toggle-track::after{content:'';position:absolute;left:2px;top:2px;width:13px;height:13px;background:#fff;border-radius:50%;transition:transform .2s;}
.toggle-switch input:checked+.toggle-track{background:var(--warn);}
.toggle-switch input:checked+.toggle-track::after{transform:translateX(15px);}

/* buttons */
.btn-xs{background:rgba(0,229,255,.07);border:1px solid rgba(0,229,255,.2);color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:.56rem;letter-spacing:1.5px;text-transform:uppercase;padding:3px 7px;border-radius:4px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn-xs:hover{background:rgba(0,229,255,.14);}
.btn-xs.p{border-color:rgba(168,85,247,.3);color:var(--purple);}
.btn-xs.p:hover{background:rgba(168,85,247,.12);}
.btn{background:rgba(0,229,255,.07);border:1px solid rgba(0,229,255,.22);color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:.64rem;letter-spacing:2px;text-transform:uppercase;padding:8px 13px;border-radius:6px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:hover{background:rgba(0,229,255,.12);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-g{background:rgba(57,255,20,.07);border-color:rgba(57,255,20,.22);color:var(--accent2);}
.btn-g:hover{background:rgba(57,255,20,.13);}
.btn-p{background:rgba(168,85,247,.07);border-color:rgba(168,85,247,.22);color:var(--purple);}
.btn-p:hover{background:rgba(168,85,247,.13);}
.btn-r{background:rgba(255,45,85,.07);border-color:rgba(255,45,85,.22);color:var(--danger);}
.btn-r:hover{background:rgba(255,45,85,.13);}
.btn-y{background:rgba(232,255,0,.07);border-color:rgba(232,255,0,.25);color:var(--ocr-accent);}
.btn-y:hover{background:rgba(232,255,0,.13);}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{display:flex;flex-direction:column;min-height:100vh;}
.main-header{padding:13px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:11px;flex-wrap:wrap;}
.active-pallet-name{font-family:'Share Tech Mono',monospace;font-size:.92rem;color:var(--accent);letter-spacing:3px;}
.pallet-stats-txt{font-size:.68rem;color:var(--muted);letter-spacing:1.5px;}
.header-actions{margin-left:auto;display:flex;gap:6px;align-items:center;}
.main-content{flex:1;padding:16px 20px;display:flex;flex-direction:column;gap:13px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:15px 17px;}
.card-title{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:11px;display:flex;align-items:center;gap:7px;}
.card-title::after{content:'';flex:1;height:1px;background:var(--border);}
.card-title.collapsible{cursor:pointer;user-select:none;}
.card-title.collapsible .caret{display:inline-block;transition:transform .2s;margin-right:2px;}
.card-title.collapsible.collapsed .caret{transform:rotate(-90deg);}

/* weight warning banner */
.weight-warn-banner{display:none;background:rgba(255,45,85,.08);border:1px solid rgba(255,45,85,.35);border-radius:7px;padding:9px 14px;margin-bottom:11px;align-items:center;gap:9px;flex-wrap:wrap;}
.weight-warn-banner.visible{display:flex;}
.wwb-icon{font-size:1.1rem;}
.wwb-text{font-family:'Share Tech Mono',monospace;font-size:.72rem;color:var(--danger);flex:1;}
.damaged-header-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,45,85,.1);border:1px solid rgba(255,45,85,.3);color:var(--danger);font-family:'Share Tech Mono',monospace;font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase;padding:2px 9px;border-radius:8px;}

/* scan inputs */
.scan-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:9px;}
.scan-field{display:flex;flex-direction:column;gap:4px;}
.scan-label{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.scan-input{width:100%;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:7px;color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:1.2rem;letter-spacing:5px;padding:10px 12px;outline:none;transition:all .15s;text-transform:uppercase;}
.scan-input:focus{border-color:var(--accent);box-shadow:var(--ag);}
.scan-input.active-field{border-color:rgba(0,229,255,.4);}
.scan-input.filled-field{border-color:rgba(57,255,20,.3);color:var(--accent2);}
.scan-input.bypassed{border-color:rgba(255,179,71,.3)!important;color:var(--warn)!important;}
.scan-input.blocked{border-color:rgba(255,45,85,.3)!important;opacity:.5;cursor:not-allowed;}
.scan-input::placeholder{color:var(--muted);letter-spacing:1.5px;font-size:.74rem;}
.scan-input.flash-success{animation:fS .3s ease;}
.scan-input.flash-error{animation:fE .3s ease;}
@keyframes fS{0%{border-color:var(--accent2);box-shadow:0 0 22px rgba(57,255,20,.5);}100%{border-color:var(--accent);box-shadow:var(--ag);}}
@keyframes fE{0%{border-color:var(--danger);box-shadow:0 0 22px rgba(255,45,85,.5);}100%{border-color:var(--border);box-shadow:none;}}
.bypass-row{display:flex;gap:14px;align-items:center;padding:6px 0 0;}
.bypass-item{display:flex;align-items:center;gap:6px;}
.bypass-lbl{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.status-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:rgba(0,0,0,.25);min-height:38px;transition:all .15s;margin-bottom:9px;}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--muted);}
.status-bar.ready .status-dot{background:var(--accent);box-shadow:0 0 6px var(--accent);}
.status-bar.success .status-dot{background:var(--accent2);box-shadow:0 0 7px var(--accent2);}
.status-bar.error .status-dot{background:var(--danger);box-shadow:0 0 7px var(--danger);}
.status-bar.warn .status-dot{background:var(--warn);box-shadow:0 0 7px var(--warn);}
.status-bar.overweight .status-dot{background:var(--danger);box-shadow:0 0 10px var(--danger);animation:pulse .6s ease-in-out infinite alternate;}
.status-bar.pair-ready .status-dot{background:var(--purple);box-shadow:0 0 7px var(--purple);}
.status-bar.success{border-color:rgba(57,255,20,.22);}
.status-bar.error{border-color:rgba(255,45,85,.22);}
.status-bar.pair-ready{border-color:rgba(168,85,247,.22);}
.status-bar.warn{border-color:rgba(255,179,71,.22);}
.status-bar.overweight{border-color:rgba(255,45,85,.4);background:rgba(255,45,85,.04);}
@keyframes pulse{from{opacity:.7;}to{opacity:1;}}
.status-text{font-family:'Share Tech Mono',monospace;font-size:.76rem;}

/* preset bar */
.preset-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:7px;margin-bottom:11px;flex-wrap:wrap;}
.preset-bar.active-p{background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.2);}
.preset-bar.active-p.damaged{background:rgba(255,45,85,.05);border:1px solid rgba(255,45,85,.25);}
.preset-bar.no-p{background:rgba(255,45,85,.05);border:1px solid rgba(255,45,85,.2);cursor:pointer;}
.pb-label{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;}
.active-p .pb-label{color:var(--purple);}
.active-p.damaged .pb-label{color:var(--danger);}
.no-p .pb-label{color:var(--danger);}
.pb-name{font-family:'Share Tech Mono',monospace;font-size:.76rem;flex:1;}
.pb-detail{font-size:.66rem;color:var(--muted);}
.drive-pill{display:inline-flex;align-items:center;gap:5px;border-radius:14px;padding:2px 9px;font-family:'Share Tech Mono',monospace;font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase;border:1px solid;cursor:pointer;transition:all .15s;}
.drive-pill.dp-ok{background:rgba(0,229,255,.07);border-color:rgba(0,229,255,.3);color:var(--accent);}
.drive-pill.dp-none{background:rgba(255,45,85,.07);border-color:rgba(255,45,85,.3);color:var(--danger);}
.dp-dot{width:5px;height:5px;border-radius:50%;}
.dp-ok .dp-dot{background:var(--accent);box-shadow:0 0 4px var(--accent);}
.dp-none .dp-dot{background:var(--danger);box-shadow:0 0 4px var(--danger);}

/* scan log */
.scan-log{max-height:148px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;margin-top:7px;}
.log-entry{display:flex;align-items:baseline;gap:6px;font-family:'Share Tech Mono',monospace;font-size:.66rem;padding:3px 6px;border-radius:3px;border-left:2px solid transparent;}
.log-entry.ok{border-color:var(--accent2);background:rgba(57,255,20,.03);}
.log-entry.pair{border-color:var(--purple);background:rgba(168,85,247,.03);}
.log-entry.warn{border-color:var(--warn);background:rgba(255,179,71,.03);}
.log-entry.error{border-color:var(--danger);background:rgba(255,45,85,.03);}
.log-entry.manual{border-color:var(--purple);background:rgba(168,85,247,.03);}
.log-entry.ocr{border-color:var(--ocr-accent);background:rgba(232,255,0,.03);}
.log-time{color:var(--muted);font-size:.58rem;flex-shrink:0;}

/* manual entry */
.manual-grid{display:grid;grid-template-columns:1fr auto auto auto auto;gap:8px;align-items:end;margin-top:11px;}
.mini-input{background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Barlow',sans-serif;font-size:.84rem;padding:8px 10px;outline:none;transition:border-color .15s;width:100%;}
.mini-input:focus{border-color:var(--purple);}
.mini-num{background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.84rem;padding:8px 8px;outline:none;text-align:center;width:62px;}
.mini-num:focus{border-color:var(--purple);}
.mini-lbs{background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:6px;color:var(--warn);font-family:'Share Tech Mono',monospace;font-size:.84rem;padding:8px 8px;outline:none;text-align:center;width:70px;}
.mini-lbs:focus{border-color:var(--warn);}
.weight-mode-toggle{display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);cursor:pointer;user-select:none;white-space:nowrap;}
.weight-mode-toggle input{display:none;}
.wmt-track{width:28px;height:15px;background:var(--muted2);border-radius:15px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;}
.wmt-track::after{content:'';position:absolute;left:2px;top:2px;width:11px;height:11px;background:#fff;border-radius:50%;transition:transform .2s;}
.weight-mode-toggle input:checked~.wmt-track{background:var(--warn);}
.weight-mode-toggle input:checked~.wmt-track::after{transform:translateX(13px);}

/* stats */
.stats-strip{display:flex;gap:7px;flex-wrap:wrap;}
.stat-chip{display:flex;align-items:center;gap:4px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:13px;padding:3px 8px;font-family:'Share Tech Mono',monospace;font-size:.64rem;}
.sn{color:var(--accent);font-size:.82rem;}
.sl{color:var(--muted);}

/* weight bar */
.weight-bar{display:flex;align-items:center;gap:10px;padding:7px 12px;background:rgba(0,0,0,.25);border:1px solid var(--border);border-radius:6px;flex-wrap:wrap;margin-bottom:9px;transition:border-color .2s;}
.weight-bar.overweight{border-color:rgba(255,45,85,.4);background:rgba(255,45,85,.04);}
.wi .wl{font-family:'Share Tech Mono',monospace;font-size:.56rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.wi .wv{font-family:'Share Tech Mono',monospace;font-size:.8rem;color:var(--accent);}
.wi.danger .wv{color:var(--danger);}

/* entry table */
.entry-table-wrap{overflow-x:auto;border-radius:6px;border:1px solid var(--border);}
table.entry-table{width:100%;border-collapse:collapse;font-size:.76rem;}
.entry-table th{background:var(--surface2);font-family:'Share Tech Mono',monospace;font-size:.54rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:7px 10px;text-align:left;border-bottom:1px solid var(--border);}
.entry-table td{padding:6px 10px;border-bottom:1px solid rgba(28,36,50,.5);vertical-align:middle;}
.entry-table tr:last-child td{border-bottom:none;}
.entry-table tr:hover td{background:rgba(255,255,255,.02);}
.entry-table tr.drag-over td{border-top:2px solid var(--accent);}
/* Unified colors for asset/serial regardless of scan vs OCR source */
.e-asset{font-family:'Share Tech Mono',monospace;color:var(--ocr-accent);letter-spacing:2px;}
.e-serial{font-family:'Share Tech Mono',monospace;color:var(--accent2);letter-spacing:2px;}
.e-bypass{color:var(--warn)!important;}
.e-manual{color:var(--purple);}
.e-damaged{color:var(--danger)!important;}
.preset-tag{display:inline-block;background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.2);color:var(--purple);font-family:'Share Tech Mono',monospace;font-size:.54rem;letter-spacing:1px;padding:1px 5px;border-radius:6px;}
.preset-tag.dmg{background:rgba(255,45,85,.08);border-color:rgba(255,45,85,.25);color:var(--danger);}
.source-badge{display:inline-block;font-family:'Share Tech Mono',monospace;font-size:.5rem;letter-spacing:1px;padding:1px 4px;border-radius:4px;border:1px solid;}
.source-badge.scan{background:rgba(0,229,255,.08);border-color:rgba(0,229,255,.25);color:var(--accent);}
.source-badge.ocr-badge{background:rgba(232,255,0,.08);border-color:rgba(232,255,0,.25);color:var(--ocr-accent);}
.e-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.78rem;padding:2px 4px;border-radius:3px;transition:color .15s;}
.e-del:hover{color:var(--danger);}
.drag-handle{cursor:grab;color:var(--muted);font-size:.8rem;padding:0 2px;user-select:none;}
.drag-handle:active{cursor:grabbing;}

.no-pallet-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:13px;padding:60px;text-align:center;}
.no-pallet-screen .big-icon{font-size:3rem;opacity:.15;}
.no-pallet-screen h2{font-family:'Share Tech Mono',monospace;font-size:.8rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);}
.empty-state{text-align:center;padding:30px;color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:.66rem;letter-spacing:2px;}

/* modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:20px;width:100%;max-width:440px;box-shadow:0 20px 60px rgba(0,0,0,.5),var(--ag);}
.modal-title{font-family:'Share Tech Mono',monospace;font-size:.76rem;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:15px;display:flex;align-items:center;justify-content:space-between;}
.close-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem;}
.form-group{margin-bottom:10px;}
.form-label{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px;}
.form-label small{font-size:.54rem;font-weight:400;}
.form-input{width:100%;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Barlow',sans-serif;font-size:.82rem;padding:7px 10px;outline:none;transition:border-color .15s;}
.form-input:focus{border-color:var(--accent);}
.form-input.wb{border-color:rgba(255,179,71,.4);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.form-hint{font-size:.6rem;color:var(--muted);margin-top:2px;font-family:'Share Tech Mono',monospace;}
.form-hint.wh{color:var(--warn);}
.toggle-row-form{display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:6px;padding:8px 10px;margin-bottom:10px;}
.trf-lbl{font-family:'Share Tech Mono',monospace;font-size:.64rem;letter-spacing:1.5px;text-transform:uppercase;}
.trf-sub{font-size:.6rem;color:var(--muted);margin-top:2px;}
.modal-actions{display:flex;gap:6px;margin-top:14px;justify-content:flex-end;}
.dell-serial-section{background:rgba(0,229,255,.03);border:1px solid rgba(0,229,255,.15);border-radius:6px;padding:9px 11px;margin-bottom:10px;}
.dell-serial-label{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:6px;opacity:.7;}
.dell-serial-row{display:flex;gap:8px;align-items:center;}
.dell-serial-input{flex:1;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.82rem;letter-spacing:3px;padding:7px 10px;outline:none;transition:border-color .15s;text-transform:uppercase;}
.dell-serial-input:focus{border-color:var(--accent);}
.dell-serial-link{display:inline-flex;align-items:center;gap:4px;padding:7px 10px;background:rgba(0,229,255,.08);border:1px solid rgba(0,229,255,.25);border-radius:6px;color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:.62rem;text-decoration:none;transition:all .15s;white-space:nowrap;}
.dell-serial-link:hover{background:rgba(0,229,255,.15);}
.dell-serial-link.hidden{display:none;}

/* ‚îÄ‚îÄ OCR PANEL STYLES ‚îÄ‚îÄ */
.ocr-layout{display:grid;grid-template-columns:160px 1fr 290px;gap:0;border:none;overflow:hidden;height:100%;}
.ocr-images{border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--surface);}
.ocr-images-header{padding:8px 10px;border-bottom:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:flex;align-items:center;justify-content:space-between;}
.ocr-thumb-list{flex:1;overflow-y:auto;padding:5px;}
.ocr-storage{padding:5px 10px;border-top:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:.52rem;color:var(--muted);}
.ocr-storage-track{height:2px;background:var(--border);border-radius:2px;margin-top:3px;overflow:hidden;}
.ocr-storage-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .5s;}
.thumb-wrapper{position:relative;margin-bottom:4px;}
.image-thumb{width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:3px;border:2px solid transparent;cursor:pointer;display:block;transition:border-color .15s;background:var(--surface2);}
.image-thumb:hover{border-color:var(--muted);}
.image-thumb.active{border-color:var(--ocr-accent);}
.image-thumb.assigned-asset{border-color:var(--ocr-accent);}
.image-thumb.assigned-serial{border-color:var(--accent);}
.image-thumb.assigned-both{border-color:var(--accent2);}
.thumb-badge{position:absolute;top:3px;right:3px;font-family:'Share Tech Mono',monospace;font-size:.5rem;padding:1px 4px;border-radius:2px;pointer-events:none;}
.thumb-badge.at{background:var(--ocr-accent);color:#000;}
.thumb-badge.sn{background:var(--accent);color:#000;}
.thumb-badge.both{background:var(--accent2);color:#000;}
/* Delete thumb button */
.thumb-del-btn{position:absolute;bottom:3px;right:3px;background:rgba(255,45,85,.85);border:none;color:#fff;border-radius:3px;font-size:.55rem;padding:2px 4px;cursor:pointer;opacity:0;transition:opacity .15s;font-family:'Share Tech Mono',monospace;}
.thumb-wrapper:hover .thumb-del-btn{opacity:1;}

.ocr-canvas-wrap{display:flex;flex-direction:column;background:#060809;}
.ocr-toolbar{padding:7px 10px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0;}
.ocr-canvas-area{flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;position:relative;}
#ocrCanvas{cursor:crosshair;display:block;}
#ocrDropZone{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;cursor:pointer;}
#ocrDropZone.hidden{display:none;}
.drop-icon{font-size:36px;opacity:.25;}
.drop-text{font-family:'Share Tech Mono',monospace;font-size:.68rem;color:var(--muted);text-align:center;line-height:1.9;}
.ocr-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:.72rem;color:var(--ocr-accent);letter-spacing:.1em;pointer-events:none;opacity:0;transition:opacity .2s;}
.ocr-overlay.visible{opacity:1;}
.ocr-progress{height:2px;background:var(--border);flex-shrink:0;}
.ocr-progress-fill{height:100%;background:var(--ocr-accent);width:0;transition:width .3s;}

/* OCR init banner */
.ocr-init-bar{background:rgba(8,11,15,.9);border-bottom:1px solid var(--border);padding:6px 12px;display:flex;align-items:center;gap:12px;font-family:'Share Tech Mono',monospace;font-size:.58rem;flex-shrink:0;}
.ocr-init-bar.hidden{display:none;}
.init-steps{display:flex;gap:4px;align-items:center;flex:1;}
.init-step{display:flex;align-items:center;gap:4px;color:var(--muted);white-space:nowrap;}
.init-step.active{color:var(--accent);}
.init-step.done{color:var(--accent2);}
.init-step.error{color:var(--danger);}
.step-sep{color:var(--border2);margin:0 1px;}
.init-bar-wrap{width:120px;flex-shrink:0;}
.init-bar-track{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.init-bar-fill{height:100%;background:var(--accent);width:0%;transition:width .4s;}
.init-elapsed{color:var(--muted);font-size:.52rem;text-align:right;margin-top:2px;}

.ocr-right{border-left:1px solid var(--border);display:flex;flex-direction:column;background:var(--surface);}
.ocr-right-header{padding:8px 10px;border-bottom:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.ocr-fields{padding:10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.ocr-field{margin-bottom:8px;}
.ocr-field-label{font-family:'Share Tech Mono',monospace;font-size:.52rem;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;display:flex;align-items:center;gap:5px;}
.ocr-field-label.asset{color:var(--ocr-accent);}
.ocr-field-label.serial{color:var(--accent);}
.field-fmt{font-size:.48rem;color:var(--muted);letter-spacing:0;}
.ocr-field-preview{width:100%;height:42px;border-radius:3px;background:var(--surface2);display:block;margin-bottom:4px;}
.ocr-field-preview.empty{border:1px dashed var(--border);}
.ocr-field input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.84rem;padding:5px 8px;outline:none;transition:border-color .15s;text-transform:uppercase;letter-spacing:0.18em;}
.ocr-field input:focus{border-color:var(--ocr-accent);}
.ocr-field input.valid{border-color:var(--accent2);}
.ocr-field input.invalid{border-color:var(--danger);}
.ocr-field input.tav-active{border-color:var(--warn);color:var(--warn);}
.field-error{font-size:.52rem;color:var(--danger);margin-top:2px;font-family:'Share Tech Mono',monospace;min-height:12px;}
.tav-row{display:flex;align-items:center;gap:4px;margin-top:3px;}
.tav-btn{font-family:'Share Tech Mono',monospace;font-size:.5rem;letter-spacing:.05em;text-transform:uppercase;padding:2px 6px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all .15s;}
.tav-btn:hover{border-color:var(--warn);color:var(--warn);}
.tav-btn.active{border-color:var(--warn);background:rgba(255,179,71,.1);color:var(--warn);}
.tav-lock{font-size:.7rem;padding:2px 5px;border-radius:3px;cursor:pointer;border:1px solid transparent;background:transparent;color:var(--muted);transition:all .15s;}
.tav-lock.locked{color:var(--warn);border-color:var(--warn);background:rgba(255,179,71,.1);}
.tav-label{font-family:'Share Tech Mono',monospace;font-size:.5rem;color:var(--muted);}
.tav-label.active{color:var(--warn);}

.ocr-actions{padding:8px 10px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:5px;flex-shrink:0;}
.sel-preview{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--accent);background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:3px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ocr-assign-row{display:flex;gap:4px;}
.ocr-pairs-list{flex:1;overflow-y:auto;padding:6px;}
.ocr-pair-card{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 8px;margin-bottom:5px;font-family:'Share Tech Mono',monospace;font-size:.6rem;display:flex;justify-content:space-between;align-items:flex-start;}
.opc-at{color:var(--ocr-accent);margin-bottom:1px;}
.opc-sn{color:var(--accent);}
.opc-pallet{color:var(--muted);font-size:.52rem;margin-top:2px;}
.opc-del{color:var(--muted);cursor:pointer;font-size:.8rem;padding:0 0 0 5px;}
.opc-del:hover{color:var(--danger);}

/* ‚îÄ‚îÄ OCR TOP PANEL (expandable pallet/preset selector) ‚îÄ‚îÄ */
.ocr-top-panel{border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;overflow:hidden;transition:max-height .3s ease;}
.ocr-top-panel.collapsed{max-height:0;}
.ocr-top-panel.expanded{max-height:400px;}
.ocr-top-panel-inner{display:grid;grid-template-columns:1fr 1fr;gap:0;padding:0;}
.ocr-panel-col{padding:10px 12px;border-right:1px solid var(--border);}
.ocr-panel-col:last-child{border-right:none;}
.ocr-panel-col-title{font-family:'Share Tech Mono',monospace;font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;}
.ocr-pallet-list-inline{display:flex;flex-direction:column;gap:2px;max-height:130px;overflow-y:auto;}
.ocr-preset-list-inline{display:flex;flex-direction:column;gap:2px;max-height:130px;overflow-y:auto;}
.ocr-inline-item{display:flex;align-items:center;gap:5px;padding:4px 7px;border-radius:4px;border:1px solid transparent;cursor:pointer;transition:all .15s;font-family:'Share Tech Mono',monospace;font-size:.65rem;}
.ocr-inline-item:hover{background:rgba(255,255,255,.04);border-color:var(--border2);}
.ocr-inline-item.active{background:rgba(0,229,255,.07);border-color:rgba(0,229,255,.25);color:var(--accent);}
.ocr-inline-item.preset-active{background:rgba(168,85,247,.07);border-color:rgba(168,85,247,.25);color:var(--purple);}
.ocr-inline-item.damaged-active{background:rgba(255,45,85,.07);border-color:rgba(255,45,85,.25);color:var(--danger);}
.ocr-inline-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;background:var(--muted2);}
.ocr-inline-item.active .ocr-inline-dot{background:var(--accent);}
.ocr-inline-item.preset-active .ocr-inline-dot{background:var(--purple);}
.ocr-inline-item.damaged-active .ocr-inline-dot{background:var(--danger);}
.ocr-preset-search-inline{width:100%;background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.6rem;padding:4px 7px;outline:none;margin-bottom:4px;transition:border-color .15s;}
.ocr-preset-search-inline:focus{border-color:rgba(168,85,247,.4);}
.ocr-preset-search-inline::placeholder{color:var(--muted);}

/* ‚îÄ‚îÄ RECYCLING BIN ‚îÄ‚îÄ */
.recycle-bin-btn{position:relative;display:inline-flex;align-items:center;gap:5px;}
.recycle-count-badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:#fff;font-family:'Share Tech Mono',monospace;font-size:.45rem;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;pointer-events:none;}
.recycle-count-badge.hidden{display:none;}

/* Recycling bin modal */
.bin-modal{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:20px;width:100%;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5);}
.bin-entry{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:5px;border:1px solid var(--border);margin-bottom:5px;background:rgba(0,0,0,.25);}
.bin-entry-info{flex:1;font-family:'Share Tech Mono',monospace;font-size:.62rem;}
.bin-entry-type{font-size:.5rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:2px;}
.bin-entry-main{color:var(--text);margin-bottom:1px;}
.bin-entry-sub{color:var(--muted);font-size:.55rem;}
.bin-entry-time{color:var(--muted);font-size:.5rem;margin-top:2px;}
.bin-actions{display:flex;gap:4px;flex-shrink:0;}
.bin-restore-btn{background:rgba(57,255,20,.07);border:1px solid rgba(57,255,20,.25);color:var(--accent2);font-family:'Share Tech Mono',monospace;font-size:.5rem;padding:3px 7px;border-radius:3px;cursor:pointer;transition:all .15s;}
.bin-restore-btn:hover{background:rgba(57,255,20,.14);}
.bin-perm-del-btn{background:rgba(255,45,85,.07);border:1px solid rgba(255,45,85,.25);color:var(--danger);font-family:'Share Tech Mono',monospace;font-size:.5rem;padding:3px 7px;border-radius:3px;cursor:pointer;transition:all .15s;}
.bin-perm-del-btn:hover{background:rgba(255,45,85,.14);}

::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
</style>
</head>
<body>

<!-- PRESET MODAL -->
<div class="modal-overlay" id="presetModal">
  <div class="modal" style="max-width:480px;max-height:90vh;overflow-y:auto;">
    <div class="modal-title"><span id="presetModalTitle">‚ñ∏ Define Model Preset</span> <button class="close-btn" onclick="closePresetModal()">‚úï</button></div>
    <div class="form-group"><label class="form-label">Model / Preset Name <small>(used for both)</small></label><input class="form-input" id="pm_name" placeholder="e.g. Dell Latitude 5520" oninput="onMfrChange()"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Manufacturer</label><input class="form-input" id="pm_mfr" placeholder="Dell" oninput="onMfrChange()"></div>
      <div class="form-group"><label class="form-label">CPU</label><input class="form-input" id="pm_cpu" placeholder="i5-1145G7"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">RAM <small>‚Äî numbers only, GB</small></label><input class="form-input" id="pm_ram" type="number" min="1" placeholder="16"></div>
      <div class="form-group" id="storageFieldGroup"><label class="form-label">Storage <small>‚Äî numbers only, GB</small></label><input class="form-input" id="pm_storage" type="number" min="1" placeholder="256"></div>
    </div>
    <div class="toggle-row-form">
      <div><div class="trf-lbl">No Storage Device</div><div class="trf-sub">Logs as "None" ‚Äî thin client, stripped unit</div></div>
      <label class="toggle-switch"><input type="checkbox" id="pm_no_storage" onchange="toggleStorageField()"><span class="toggle-track"></span></label>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Weight (lbs) <small>‚Äî optional, suggested</small></label><input class="form-input" id="pm_weight" type="number" min="0" step="0.1" placeholder="3.5" oninput="clearWeightNag()"><div class="form-hint" id="weightHint">Helps calculate shipping weight</div></div>
    </div>
    <div class="dell-serial-section" id="dellSerialSection" style="display:none;">
      <div class="dell-serial-label">‚ñ∏ Dell Support Lookup</div>
      <div class="dell-serial-row"><input class="dell-serial-input" id="dellSerialInput" placeholder="Enter service tag‚Ä¶" oninput="updateDellLink()" maxlength="20"><a class="dell-serial-link hidden" id="dellSupportLink" href="#" target="_blank" rel="noopener">üîó View on Dell Support</a></div>
    </div>
    <div class="modal-actions"><button class="btn btn-r" onclick="closePresetModal()">Cancel</button><button class="btn btn-g" onclick="savePreset()">Save Preset</button></div>
  </div>
</div>

<!-- NEW PALLET MODAL -->
<div class="modal-overlay" id="palletModal">
  <div class="modal" style="max-width:310px;">
    <div class="modal-title">‚ñ∏ New Pallet</div>
    <div class="form-group"><label class="form-label">Pallet Name</label><input class="form-input" id="newPalletName" placeholder="e.g. Pallet A1" onkeydown="if(event.key==='Enter')confirmNewPallet()"></div>
    <div class="modal-actions"><button class="btn btn-r" onclick="closePalletModal()">Cancel</button><button class="btn btn-g" onclick="confirmNewPallet()">Create</button></div>
  </div>
</div>

<!-- HTML VIEW MODAL -->
<div class="modal-overlay" id="htmlViewModal" style="align-items:flex-start;padding:12px;overflow-y:auto;">
  <div class="modal" style="max-width:960px;width:100%;max-height:92vh;overflow-y:auto;">
    <div class="modal-title">‚ñ∏ Pallet Summary <button class="close-btn" onclick="closeHtmlView()">‚úï</button></div>
    <div id="htmlViewContent"></div>
    <div class="modal-actions" style="margin-top:11px;"><button class="btn btn-p" onclick="printHtmlView()">Print / Save PDF</button><button class="btn" onclick="closeHtmlView()">Close</button></div>
  </div>
</div>

<!-- RECYCLING BIN MODAL -->
<div class="modal-overlay" id="recycleBinModal">
  <div class="bin-modal">
    <div class="modal-title" style="color:var(--danger);">
      <span>üóë Recycling Bin (<span id="binCountLabel">0</span>)</span>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-g" onclick="restoreAllFromBin()" style="font-size:.54rem;padding:4px 9px;">‚Ü© Restore All</button>
        <button class="btn btn-r" onclick="emptyBin()" style="font-size:.54rem;padding:4px 9px;">‚úï Empty Bin</button>
        <button class="close-btn" onclick="closeRecycleBin()">‚úï</button>
      </div>
    </div>
    <div id="binList"></div>
    <div id="binEmpty" style="color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:.68rem;text-align:center;padding:20px;display:none;">Bin is empty</div>
  </div>
</div>

<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h1>Asset Lister</h1>
      <p>Sale Pallet Builder + OCR</p>
    </div>
    <div class="count-tiles">
      <div class="count-tile"><div class="ctn" id="tilePalletCount">0</div><div class="ctl">Pallet Assets</div></div>
      <div class="count-tile global"><div class="ctn" id="tileGlobalCount">0</div><div class="ctl">Total Assets</div></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Pallets <button class="btn-xs" onclick="openPalletModal()">+ New</button></div>
      <div class="pallets-list" id="palletsList"></div>
    </div>
    <div class="sidebar-section" style="padding-top:4px;">
      <div class="damaged-section-label">‚ö† Damaged</div>
      <div class="pallets-list" id="damagedPalletList"></div>
    </div>
    <div class="sdiv" style="margin:0 13px;"></div>
    <div class="sidebar-section">
      <div class="sidebar-label">
        Model Presets
        <div style="display:flex;gap:3px;">
          <button class="btn-xs" onclick="openPresetModal()">+ New</button>
          <button class="btn-xs p" onclick="exportPresets()" title="Export JSON">‚Üë</button>
          <label class="btn-xs p" title="Import JSON" style="cursor:pointer;">‚Üì<input type="file" accept=".json" style="display:none;" onchange="importPresets(event)"></label>
        </div>
      </div>
      <input class="preset-search" id="presetSearch" placeholder="Search presets‚Ä¶" oninput="renderPresetList()">
      <div class="pallets-list" id="presetsList"></div>
    </div>
    <div class="sidebar-bottom">
      <div class="sdiv" style="margin:0;"></div>
      <button class="btn btn-g" onclick="exportAllXLSX()" style="width:100%;">‚¨á Export Spreadsheet</button>
      <button class="btn btn-y" onclick="exportOcrZip()" style="width:100%;margin-top:3px;">üì∑ Export OCR ZIP</button>
      <button class="btn btn-p" onclick="openHtmlView()" style="width:100%;margin-top:3px;">‚óà View All as HTML</button>
      <div class="sdiv" style="margin:4px 0 2px;"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;">
        <span id="sessionStatus" style="font-family:'Share Tech Mono',monospace;font-size:.54rem;letter-spacing:1px;color:var(--muted);"></span>
        <div style="display:flex;gap:4px;">
          <div class="recycle-bin-btn">
            <button class="btn btn-r" onclick="openRecycleBin()" style="font-size:.54rem;padding:4px 8px;" title="Recycling Bin">üóë</button>
            <span class="recycle-count-badge hidden" id="recycleBadge">0</span>
          </div>
          <button class="btn btn-r" onclick="clearSession()" style="font-size:.54rem;padding:4px 8px;">‚úï Clear</button>
        </div>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="no-pallet-screen" id="noPalletScreen">
      <div class="big-icon">üì¶</div>
      <h2>No Pallet Selected</h2>
      <p style="color:var(--muted);font-size:.74rem;max-width:240px;line-height:1.7;">Create a pallet or select the Damaged section to start scanning.</p>
      <button class="btn" onclick="openPalletModal()">+ Create First Pallet</button>
    </div>

    <div id="palletWorkspace" style="display:none;flex-direction:column;">
      <div class="main-header">
        <div>
          <div class="active-pallet-name" id="headerPalletName">PALLET</div>
          <div class="pallet-stats-txt" id="headerStats">0 ENTRIES</div>
        </div>
        <div id="damagedHeaderBadge"></div>
        <div class="header-actions">
          <button class="btn btn-y" id="ocrToggleBtn" onclick="switchMode(currentMode==='ocr'?'scan':'ocr')" style="font-size:.58rem;padding:5px 10px;">üì∑ OCR Mode</button>
          <button class="btn btn-r" onclick="clearCurrentPallet()" style="font-size:.58rem;padding:5px 9px;">‚úï Clear Pallet</button>
        </div>
      </div>

      <div class="main-content">
        <!-- SCAN MODE -->
        <div class="mode-panel active" id="panelScan">
          <div id="presetBarWrap"></div>
          <div class="weight-warn-banner" id="weightWarnBanner">
            <span class="wwb-icon">‚ö†Ô∏è</span>
            <span class="wwb-text" id="weightWarnText">Pallet weight exceeds 1,200 lbs</span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--muted);">Scanning continues normally</span>
          </div>
          <div class="card">
            <div class="card-title">Asset / Serial Scan</div>
            <div class="scan-row">
              <div class="scan-field"><label class="scan-label">Asset Tag</label><input class="scan-input active-field" id="assetInput" placeholder="Scan 6-digit number‚Ä¶" onkeydown="handleScanKey(event,'asset')" onblur="handleScanBlur(event,'asset')" autocomplete="off" spellcheck="false"></div>
              <div class="scan-field"><label class="scan-label">Serial Number</label><input class="scan-input" id="serialInput" placeholder="Waiting for asset tag‚Ä¶" onkeydown="handleScanKey(event,'serial')" onblur="handleScanBlur(event,'serial')" autocomplete="off" spellcheck="false"></div>
            </div>
            <div class="bypass-row" style="margin-bottom:9px;">
              <div class="bypass-item"><span class="bypass-lbl">Bypass Asset Tag</span><label class="toggle-switch"><input type="checkbox" id="bypassAsset" onchange="updateBypassUI()"><span class="toggle-track"></span></label></div>
              <div class="bypass-item"><span class="bypass-lbl">Bypass Serial #</span><label class="toggle-switch"><input type="checkbox" id="bypassSerial" onchange="updateBypassUI()"><span class="toggle-track"></span></label></div>
              <div id="bypassBadgeWrap" style="margin-left:auto;"></div>
            </div>
            <div class="status-bar ready" id="statusBar"><div class="status-dot"></div><div class="status-text" id="statusText">Select a preset first, then scan</div></div>
            <div class="card-title collapsible" id="logToggle" onclick="toggleSection('logToggle','logBody')" style="margin-bottom:0;"><span class="caret">‚ñæ</span>Scan Log</div>
            <div id="logBody"><div class="scan-log" id="scanLog"><div class="log-entry" style="color:var(--muted);padding:4px 6px;">Awaiting first scan‚Ä¶</div></div></div>
          </div>
          <div class="card">
            <div class="card-title collapsible collapsed" id="manualToggle" onclick="toggleSection('manualToggle','manualBody')" style="margin-bottom:0;"><span class="caret">‚ñæ</span>Manual Entry</div>
            <div id="manualBody" style="display:none;">
              <div class="manual-grid">
                <div><label class="scan-label">Description</label><input class="mini-input" id="manualDesc" placeholder="e.g. 60 √ó USB-C chargers" onkeydown="if(event.key==='Enter')addManualEntry()"></div>
                <div><label class="scan-label">Qty</label><input class="mini-num" id="manualQty" type="number" value="1" min="1" max="9999" onkeydown="if(event.key==='Enter')addManualEntry()"></div>
                <div><label class="scan-label">Weight (lbs)</label><input class="mini-lbs" id="manualLbs" type="number" min="0" step="0.1" placeholder="0" onkeydown="if(event.key==='Enter')addManualEntry()"></div>
                <div style="display:flex;flex-direction:column;gap:4px;"><label class="scan-label">Mode</label><label class="weight-mode-toggle"><input type="checkbox" id="weightModeTotal"><span class="wmt-track"></span><span id="weightModeLabel" style="font-size:.56rem;">Per Item</span></label></div>
                <div><label class="scan-label">&nbsp;</label><button class="btn btn-p" onclick="addManualEntry()" style="padding:8px 12px;">+ Add</button></div>
              </div>
            </div>
          </div>
        </div>

        <!-- OCR FULL-SCREEN OVERLAY -->
        <div class="mode-panel" id="panelOcr" style="position:fixed;inset:0;z-index:50;background:var(--bg);overflow:hidden;padding:0;display:none;flex-direction:column;">
          <!-- OCR top bar with scan mode button (green, distinct from X clear) -->
          <div style="display:flex;align-items:center;gap:12px;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;">
            <div style="font-family:'Share Tech Mono',monospace;font-size:.82rem;color:var(--ocr-accent);letter-spacing:3px;">üì∑ OCR CAPTURE</div>
            <!-- Toggle expand panel button -->
            <button class="btn" id="ocrPanelToggleBtn" onclick="toggleOcrTopPanel()" style="font-size:.56rem;padding:4px 9px;border-color:rgba(0,229,255,.3);" title="Show/hide pallet & preset selector">‚äû Pallets &amp; Presets</button>
            <div id="ocrActiveInfo" style="font-family:'Share Tech Mono',monospace;font-size:.65rem;display:flex;gap:8px;align-items:center;"></div>
            <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
              <!-- Scan mode button - green/distinct from danger red -->
              <button class="btn btn-g" onclick="switchMode('scan')" style="font-size:.58rem;padding:5px 12px;">‚óÄ Scan Mode</button>
            </div>
          </div>
          <!-- Expandable top panel for pallets and presets -->
          <div class="ocr-top-panel collapsed" id="ocrTopPanel">
            <div class="ocr-top-panel-inner">
              <!-- Pallets column -->
              <div class="ocr-panel-col">
                <div class="ocr-panel-col-title">
                  <span>Pallets</span>
                  <button class="btn-xs" onclick="openPalletModal()" style="font-size:.5rem;padding:2px 5px;">+ New</button>
                </div>
                <div class="ocr-pallet-list-inline" id="ocrPalletListInline"></div>
              </div>
              <!-- Presets column -->
              <div class="ocr-panel-col">
                <div class="ocr-panel-col-title">
                  <span>Model Preset</span>
                  <button class="btn-xs p" onclick="openPresetModal()" style="font-size:.5rem;padding:2px 5px;">+ New</button>
                </div>
                <input class="ocr-preset-search-inline" id="ocrPresetSearchInline" placeholder="Search presets‚Ä¶" oninput="renderOcrInlinePresets()">
                <div class="ocr-preset-list-inline" id="ocrPresetListInline"></div>
              </div>
            </div>
          </div>
          <!-- OCR body -->
          <div style="flex:1;overflow:hidden;display:flex;">
          <div class="ocr-layout" style="flex:1;height:100%;border:none;border-radius:0;">
            <!-- Left: image thumbnails -->
            <div class="ocr-images">
              <div class="ocr-images-header">
                Images
                <label class="btn-xs" style="cursor:pointer;">+<input type="file" id="ocrFileInput" multiple accept="image/*,.heic,.HEIC" style="display:none;"></label>
              </div>
              <div class="ocr-init-bar" id="ocrInitBar">
                <div class="init-steps">
                  <div class="init-step" id="stepDb"><span>DB</span></div>
                  <span class="step-sep">‚Ä∫</span>
                  <div class="init-step" id="stepEngine"><span>Engine</span></div>
                  <span class="step-sep">‚Ä∫</span>
                  <div class="init-step" id="stepModel"><span>Model</span></div>
                  <span class="step-sep">‚Ä∫</span>
                  <div class="init-step" id="stepReady"><span>Ready</span></div>
                </div>
                <div class="init-bar-wrap">
                  <div class="init-bar-track"><div class="init-bar-fill" id="initBarFill"></div></div>
                  <div class="init-elapsed" id="initElapsed">0.0s</div>
                </div>
              </div>
              <div class="ocr-thumb-list" id="ocrThumbList"
                ondragover="event.preventDefault()" ondrop="ocrHandleDrop(event)"></div>
              <div class="ocr-storage">
                <span id="ocrStorageLabel">Storage: ‚Äî</span>
                <div class="ocr-storage-track"><div class="ocr-storage-fill" id="ocrStorageFill" style="width:0%"></div></div>
              </div>
            </div>

            <!-- Center: canvas -->
            <div class="ocr-canvas-wrap">
              <div class="ocr-toolbar" id="ocrToolbar">
                <span class="sel-preview" id="selPreview">‚Äî click or draw a region ‚Äî</span>
              </div>
              <div class="ocr-progress"><div class="ocr-progress-fill" id="ocrProgressFill"></div></div>
              <div class="ocr-canvas-area" id="ocrCanvasArea">
                <div id="ocrDropZone" ondragover="event.preventDefault();this.style.borderColor='var(--ocr-accent)'" ondragleave="this.style.borderColor=''" onclick="document.getElementById('ocrFileInput').click()">
                  <div class="drop-icon">üì∑</div>
                  <div class="drop-text">Drop images here<br>or click to browse<br><span style="font-size:.6rem;opacity:.5;">JPG ¬∑ PNG ¬∑ HEIC</span></div>
                </div>
                <canvas id="ocrCanvas" style="display:none;"></canvas>
                <div class="ocr-overlay" id="ocrOverlay">RUNNING OCR‚Ä¶</div>
              </div>
            </div>

            <!-- Right: pair builder -->
            <div class="ocr-right">
              <div class="ocr-right-header">Current OCR Pair</div>
              <div class="ocr-fields">
                <!-- Asset Tag -->
                <div class="ocr-field">
                  <div class="ocr-field-label asset">Asset Tag <span class="field-fmt">6 digits</span></div>
                  <canvas class="ocr-field-preview empty" id="atPreview" width="270" height="42"></canvas>
                  <input type="text" id="atInput" placeholder="000000" maxlength="12" oninput="ocrOnFieldInput('asset')" onblur="ocrValidateField('asset')">
                  <div class="tav-row">
                    <button class="tav-btn" id="tavBtnAt" onclick="toggleTAV('asset')">TAV</button>
                    <button class="tav-lock" id="tavLockAt" onclick="toggleTAVLock('asset')">üîì</button>
                    <span class="tav-label" id="tavLabelAt">take any value</span>
                  </div>
                  <div class="field-error" id="atError"></div>
                </div>
                <!-- Serial -->
                <div class="ocr-field">
                  <div class="ocr-field-label serial">Serial Number <span class="field-fmt">7 alphanumeric</span></div>
                  <canvas class="ocr-field-preview empty" id="snPreview" width="270" height="42"></canvas>
                  <input type="text" id="snInput" placeholder="A000000" maxlength="14" oninput="ocrOnFieldInput('serial')" onblur="ocrValidateField('serial')">
                  <div class="tav-row">
                    <button class="tav-btn" id="tavBtnSn" onclick="toggleTAV('serial')">TAV</button>
                    <button class="tav-lock" id="tavLockSn" onclick="toggleTAVLock('serial')">üîì</button>
                    <span class="tav-label" id="tavLabelSn">take any value</span>
                  </div>
                  <div class="field-error" id="snError"></div>
                </div>
              </div>
              <div class="ocr-actions">
                <div class="ocr-assign-row">
                  <button class="btn btn-xs" id="btnAssignAsset" disabled onclick="ocrAssignSelected('asset')" style="flex:1;">‚Üí Asset Tag</button>
                  <button class="btn btn-xs" id="btnAssignSerial" disabled onclick="ocrAssignSelected('serial')" style="flex:1;">‚Üí Serial</button>
                </div>
                <button class="btn btn-y" onclick="ocrFinalizePair()" style="width:100%;font-size:.58rem;padding:6px;">Finalize OCR Pair</button>
                <button class="btn btn-xs" onclick="ocrClearPair()" style="width:100%;text-align:center;">Clear Pair</button>
              </div>
              <div class="ocr-right-header" style="display:flex;align-items:center;justify-content:space-between;">
                <span>OCR Pairs (<span id="ocrPairsCount">0</span>)</span>
              </div>
              <div class="ocr-pairs-list" id="ocrPairsList"></div>
            </div><!-- ocr-right -->
          </div><!-- ocr-layout -->
          </div><!-- ocr-body -->
        </div><!-- panelOcr -->

        <!-- Entries Table (always visible) -->
        <div class="card">
          <div class="card-title" style="margin-bottom:8px;">
            Pallet Entries
            <div class="stats-strip" style="margin-left:3px;">
              <div class="stat-chip"><span class="sn" id="statPairs">0</span><span class="sl">scan</span></div>
              <div class="stat-chip"><span class="sn" id="statOcr">0</span><span class="sl">ocr</span></div>
              <div class="stat-chip"><span class="sn" id="statManual">0</span><span class="sl">manual</span></div>
              <div class="stat-chip"><span class="sn" id="statDupes">0</span><span class="sl">dupes</span></div>
              <div class="stat-chip"><span class="sn" id="statErrors">0</span><span class="sl">errors</span></div>
            </div>
          </div>
          <div class="weight-bar" id="weightBar">
            <div class="wi" id="wPalletWi"><div class="wl">Pallet Weight</div><div class="wv" id="wPallet">‚Äî</div></div>
            <div style="color:var(--border2);">|</div>
            <div class="wi"><div class="wl">Total Shipment</div><div class="wv" id="wTotal">‚Äî</div></div>
            <div style="margin-left:auto;font-family:'Share Tech Mono',monospace;font-size:.58rem;color:var(--warn);" id="weightNote"></div>
          </div>
          <div class="entry-table-wrap">
            <table class="entry-table">
              <thead><tr>
                <th style="width:20px;"></th><th>#</th><th>Asset Tag</th>
                <th>Serial</th><th>Preset</th><th>Src</th><th></th>
              </tr></thead>
              <tbody id="entryTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INDEXEDDB (for OCR images)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB_NAME='OCRCaptureDB', DB_VER=1;
let db=null;
function openDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VER);
    req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('images'))d.createObjectStore('images',{keyPath:'id'});if(!d.objectStoreNames.contains('session'))d.createObjectStore('session',{keyPath:'key'});};
    req.onsuccess=e=>{db=e.target.result;res(db);};
    req.onerror=e=>rej(e.target.error);
  });
}
const dbOp=(store,mode,fn)=>new Promise((res,rej)=>{const tx=db.transaction(store,mode);const req=fn(tx.objectStore(store));req.onsuccess=e=>res(e.target.result);req.onerror=e=>rej(e.target.error);});
const dbPut=(store,val)=>dbOp(store,'readwrite',s=>s.put(val));
const dbGet=(store,key)=>dbOp(store,'readonly',s=>s.get(key));
const dbGetAll=store=>dbOp(store,'readonly',s=>s.getAll());
const dbClear=store=>dbOp(store,'readwrite',s=>s.clear());
const dbDelete=(store,key)=>dbOp(store,'readwrite',s=>s.delete(key));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _ac=null;
function ac(){if(!_ac)_ac=new(window.AudioContext||window.webkitAudioContext)();return _ac;}
function beep(t){
  try{
    const ctx=ac();
    if(t==='tag'){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='square';o.frequency.setValueAtTime(900,ctx.currentTime);g.gain.setValueAtTime(.09,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.07);o.start();o.stop(ctx.currentTime+.07);}
    else if(t==='pair'){const o1=ctx.createOscillator(),g1=ctx.createGain(),o2=ctx.createOscillator(),g2=ctx.createGain();o1.connect(g1);g1.connect(ctx.destination);o2.connect(g2);g2.connect(ctx.destination);o1.type='square';o1.frequency.setValueAtTime(660,ctx.currentTime);g1.gain.setValueAtTime(.09,ctx.currentTime);g1.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.065);o1.start();o1.stop(ctx.currentTime+.065);o2.type='square';o2.frequency.setValueAtTime(1040,ctx.currentTime+.075);g2.gain.setValueAtTime(.09,ctx.currentTime+.075);g2.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.14);o2.start(ctx.currentTime+.075);o2.stop(ctx.currentTime+.14);}
    else if(t==='error'){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.setValueAtTime(200,ctx.currentTime);g.gain.setValueAtTime(.11,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.18);o.start();o.stop(ctx.currentTime+.18);}
    else if(t==='dupe'){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.setValueAtTime(340,ctx.currentTime);o.frequency.linearRampToValueAtTime(200,ctx.currentTime+.14);g.gain.setValueAtTime(.09,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.14);o.start();o.stop(ctx.currentTime+.14);}
    else if(t==='manual'){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(580,ctx.currentTime);g.gain.setValueAtTime(.07,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.09);o.start();o.stop(ctx.currentTime+.09);}
    else if(t==='ocr'){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(800,ctx.currentTime);o.frequency.linearRampToValueAtTime(1100,ctx.currentTime+.07);g.gain.setValueAtTime(.07,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.12);o.start();o.stop(ctx.currentTime+.12);}
    else if(t==='overweight'){const times=[0,.12,.24];times.forEach(offset=>{const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sawtooth';o.frequency.setValueAtTime(380-offset*80,ctx.currentTime+offset);g.gain.setValueAtTime(.13,ctx.currentTime+offset);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+offset+.09);o.start(ctx.currentTime+offset);o.stop(ctx.currentTime+offset+.09);});}
  }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LISTER STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pallets=[], presets=[];
let activePalletId=null, activePresetId=null;
let assetPending=null, dupeCount=0, errorCount=0;
let globalAssetTags=new Set(), globalSerials=new Set();
let storageLogDefault=true;
const PALLET_WEIGHT=50, WEIGHT_LIMIT=1200;
const DAMAGED_PALLET_ID='__damaged_pallet__';
const DAMAGED_PRESET_ID='__damaged__';
let damagedPallet={id:DAMAGED_PALLET_ID,name:'Damaged',entries:[],isDamaged:true};

// ‚îÄ‚îÄ RECYCLING BIN ‚îÄ‚îÄ
let recycleBin=[]; // {id, type, deletedAt, data:{entry|image|pair}, palletId, description}

function getActivePallet(){if(activePalletId===DAMAGED_PALLET_ID)return damagedPallet;return pallets.find(p=>p.id===activePalletId);}
function getActivePreset(){return presets.find(p=>p.id===activePresetId)||(activePresetId===DAMAGED_PRESET_ID?getDamagedPreset():null);}
function getDamagedPreset(){return{id:DAMAGED_PRESET_ID,name:'‚ö† Damaged',mfr:'',cpu:'',ram:'',storage:'',noStorage:true,weight:null,isDamaged:true};}
function getAllPresets(){return[getDamagedPreset(),...presets];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SKIP='(F)';
const FMT={asset:{re:/^\d{6}$/,hint:'6 digits'},serial:{re:/^[A-Za-z0-9]{7}$/,hint:'7 alphanumeric'}};
const tav={asset:{active:false,locked:false},serial:{active:false,locked:false}};

// Regex for smart bounding box filtering
const ASSET_RE=/^\d{5,6}$/;
const SERIAL_RE=/^[A-Z0-9]{6,8}$/i;
function looksLikeAssetOrSerial(text){
  const t=text.trim().replace(/[^A-Z0-9]/gi,'');
  return ASSET_RE.test(t)||SERIAL_RE.test(t);
}

let ocrImages=[], ocrActiveId=null, ocrSelectedBox=null;
let ocrWorker=null, ocrWorkerReady=false, ocrBusy=false, ocrQueue=[];
let ocrCurrentPair={asset:null,serial:null,assetCrop:null,serialCrop:null,imageIds:new Set()};
let ocrSaveTimer=null, ocrCanvasScale=1;
let drawRect=null, pointerDown=false, pointerStart=null, hitOnDown=null, didDrag=false;
let ocrTopPanelOpen=false;

// Image hash tracking for dedup
let ocrImageHashes=new Set();

const ocrCanvas=document.getElementById('ocrCanvas');
const ocrCtx=ocrCanvas.getContext('2d');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR TOP PANEL (expand/collapse for pallet+preset)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleOcrTopPanel(){
  ocrTopPanelOpen=!ocrTopPanelOpen;
  const panel=document.getElementById('ocrTopPanel');
  panel.classList.toggle('expanded',ocrTopPanelOpen);
  panel.classList.toggle('collapsed',!ocrTopPanelOpen);
  const btn=document.getElementById('ocrPanelToggleBtn');
  btn.textContent=ocrTopPanelOpen?'‚äü Pallets & Presets':'‚äû Pallets & Presets';
  if(ocrTopPanelOpen){renderOcrInlinePallets();renderOcrInlinePresets();}
}

function renderOcrInlinePallets(){
  const list=document.getElementById('ocrPalletListInline');
  const items=[...pallets,damagedPallet];
  list.innerHTML=items.map(p=>{
    const isActive=activePalletId===p.id;
    const isDmg=p.isDamaged;
    const cls=isActive?(isDmg?'ocr-inline-item damaged-active':'ocr-inline-item active'):'ocr-inline-item';
    const cnt=p.entries.filter(e=>e.type==='pair'||e.type==='ocr').length;
    return `<div class="${cls}" onclick="selectPallet('${p.id}');updateOcrActiveInfo();renderOcrInlinePallets();">
      <div class="ocr-inline-dot"></div>
      <span style="flex:1;${isDmg?'color:var(--danger)':''}">${escHtml(p.name)}</span>
      <span style="color:var(--muted);font-size:.55rem;">${cnt}</span>
    </div>`;
  }).join('');
  if(!items.length)list.innerHTML='<div style="color:var(--muted);font-size:.6rem;padding:4px 8px;">No pallets</div>';
}

function renderOcrInlinePresets(){
  const list=document.getElementById('ocrPresetListInline');
  const q=(document.getElementById('ocrPresetSearchInline')?.value||'').toLowerCase();
  const all=getAllPresets();
  const filtered=q?all.filter(p=>p.name.toLowerCase().includes(q)):all;
  list.innerHTML=filtered.map(p=>{
    const isActive=activePresetId===p.id;
    const isDmg=p.isDamaged;
    const cls=isActive?(isDmg?'ocr-inline-item damaged-active':'ocr-inline-item preset-active'):'ocr-inline-item';
    return `<div class="${cls}" onclick="selectPreset('${p.id}');updateOcrActiveInfo();renderOcrInlinePresets();">
      <div class="ocr-inline-dot"></div>
      <span style="flex:1;${isDmg?'color:var(--danger)':''}">${escHtml(p.name)}</span>
      ${!p.weight&&!isDmg?'<span style="color:var(--warn);font-size:.55rem;">‚ö†</span>':''}
    </div>`;
  }).join('');
}

function updateOcrActiveInfo(){
  const el=document.getElementById('ocrActiveInfo');
  const pallet=getActivePallet();
  const preset=getActivePreset();
  let html='';
  if(pallet)html+=`<span style="background:rgba(0,229,255,.07);border:1px solid rgba(0,229,255,.2);border-radius:4px;padding:2px 8px;font-size:.65rem;">üì¶ ${escHtml(pallet.name.toUpperCase())}</span>`;
  if(preset){const isDmg=preset.isDamaged;html+=`<span style="background:${isDmg?'rgba(255,45,85,.07)':'rgba(168,85,247,.07)'};border:1px solid ${isDmg?'rgba(255,45,85,.2)':'rgba(168,85,247,.2)'};border-radius:4px;padding:2px 8px;font-size:.65rem;color:${isDmg?'var(--danger)':'var(--purple)'};">‚ñ∏ ${escHtml(preset.name)}</span>`;}
  el.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentMode='scan';
function switchMode(mode){
  currentMode=mode;
  const ocrPanel=document.getElementById('panelOcr');
  ocrPanel.style.display=mode==='ocr'?'flex':'none';
  const btn=document.getElementById('ocrToggleBtn');
  if(btn){btn.style.background=mode==='ocr'?'rgba(232,255,0,.15)':'';btn.style.borderColor=mode==='ocr'?'rgba(232,255,0,.4)':'';btn.textContent=mode==='ocr'?'‚úï Close OCR':'üì∑ OCR Mode';}
  if(mode==='ocr'){
    updateOcrActiveInfo();
    if(ocrActiveId)renderOcrCanvas();
    renderOcrPairsList();
    if(ocrTopPanelOpen){renderOcrInlinePallets();renderOcrInlinePresets();}
  }else{
    renderPresetBar();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE HASH UTILITY (for dedup)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function hashFile(blob){
  const buf=await blob.arrayBuffer();
  const hashBuf=await crypto.subtle.digest('SHA-256',buf);
  return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VALIDATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isValidAssetTag(v){return /^\d{6}$/.test(v);}
function isValidSerial(v){if(!/^[A-Z0-9]{7}$/i.test(v))return false;if(!/[A-Z]/i.test(v))return false;if(!/[0-9]/.test(v))return false;return true;}

function ocrValidateField(field){
  const inp=document.getElementById(field==='asset'?'atInput':'snInput');
  const err=document.getElementById(field==='asset'?'atError':'snError');
  const val=inp.value.trim();
  inp.classList.remove('valid','invalid','tav-active');
  err.textContent='';
  if(!val||val===SKIP)return true;
  if(!tav[field].active&&!FMT[field].re.test(val)){err.textContent=`Expected ${FMT[field].hint}.`;inp.classList.add('invalid');return false;}
  if(tav[field].active&&!FMT[field].re.test(val)){err.textContent=`Override active ‚Äî expected ${FMT[field].hint}.`;inp.classList.add('tav-active');}
  const v=val.toUpperCase();
  const isDup=[...pallets,damagedPallet].some(p=>p.entries.some(e=>(e.type==='pair'||e.type==='ocr')&&((e.asset&&e.asset.toUpperCase()===v)||(e.serial&&e.serial.toUpperCase()===v))));
  if(isDup){err.textContent='Already exists in another entry.';inp.classList.add('invalid');return false;}
  const othId=field==='asset'?'snInput':'atInput';
  const othVal=document.getElementById(othId).value.trim().toUpperCase();
  if(othVal&&othVal!==SKIP&&othVal===v){err.textContent='Cannot match other field.';inp.classList.add('invalid');return false;}
  if(!inp.classList.contains('tav-active'))inp.classList.add('valid');
  return true;
}
function ocrOnFieldInput(field){ocrValidateField(field);const o=field==='asset'?'serial':'asset';if(document.getElementById(o==='asset'?'atInput':'snInput').value.trim())ocrValidateField(o);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTAV(f){if(tav[f].locked)return;tav[f].active=!tav[f].active;updateTAVUI(f);ocrValidateField(f);}
function toggleTAVLock(f){tav[f].locked=!tav[f].locked;if(tav[f].locked)tav[f].active=true;updateTAVUI(f);ocrValidateField(f);ocrScheduleSave();}
function resetTAV(f){if(!tav[f].locked){tav[f].active=false;updateTAVUI(f);}}
function updateTAVUI(f){
  const t=tav[f];
  const btn=document.getElementById(f==='asset'?'tavBtnAt':'tavBtnSn');
  const lock=document.getElementById(f==='asset'?'tavLockAt':'tavLockSn');
  const lbl=document.getElementById(f==='asset'?'tavLabelAt':'tavLabelSn');
  btn.classList.toggle('active',t.active);lock.classList.toggle('locked',t.locked);
  lock.textContent=t.locked?'üîí':'üîì';
  if(t.locked){lbl.textContent='always on';lbl.classList.add('active');}
  else if(t.active){lbl.textContent='one-time override';lbl.classList.add('active');}
  else{lbl.textContent='take any value';lbl.classList.remove('active');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ocrInitStart=Date.now(), ocrElapsedTimer=null;
function startOcrTimer(){ocrInitStart=Date.now();ocrElapsedTimer=setInterval(()=>{document.getElementById('initElapsed').textContent=((Date.now()-ocrInitStart)/1000).toFixed(1)+'s';},100);}
function stopOcrTimer(){clearInterval(ocrElapsedTimer);}
function setInitStep(step,status){
  const el=document.getElementById('step'+step.charAt(0).toUpperCase()+step.slice(1));
  el.className='init-step '+status;
  const order=['db','engine','model','ready'];
  const done=order.filter(s=>{const e=document.getElementById('step'+s.charAt(0).toUpperCase()+s.slice(1));return e&&e.classList.contains('done');}).length;
  document.getElementById('initBarFill').style.width=(done/order.length*100)+'%';
}
function hideInitBar(){stopOcrTimer();const b=document.getElementById('ocrInitBar');b.style.transition='opacity .5s';b.style.opacity='0';setTimeout(()=>b.classList.add('hidden'),550);}

async function initOcr(){
  startOcrTimer();
  setInitStep('db','active');
  try{await openDB();setInitStep('db','done');}catch(e){setInitStep('db','error');}
  await ocrRestoreSession();
  await updateOcrStorage();
  setInitStep('engine','active');
  try{
    ocrWorker=await Tesseract.createWorker('eng',1,{logger:m=>{
      if(m.status==='loading tesseract core')setInitStep('engine','active');
      if(m.status==='loading language traineddata'){setInitStep('engine','done');setInitStep('model','active');document.getElementById('initElapsed').textContent=Math.round(m.progress*100)+'%';}
      if(m.status==='initializing api'){setInitStep('model','done');setInitStep('ready','active');document.getElementById('initElapsed').textContent='';}
      if(m.status==='recognizing text')document.getElementById('ocrProgressFill').style.width=(m.progress*100)+'%';
    }});
    setInitStep('ready','active');
    const bc=document.createElement('canvas');bc.width=10;bc.height=10;
    try{await ocrWorker.recognize(bc.toDataURL());}catch(e){}
    ocrWorkerReady=true;
    setInitStep('ready','done');
    setTimeout(()=>{hideInitBar();},1200);
    ocrProcessQueue();
  }catch(e){setInitStep('engine','error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR SESSION SAVE/RESTORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ocrScheduleSave(){clearTimeout(ocrSaveTimer);ocrSaveTimer=setTimeout(ocrSaveSession,900);}
async function ocrSaveSession(){
  if(!db)return;
  try{
    await dbPut('session',{key:'tav',value:{asset:{locked:tav.asset.locked},serial:{locked:tav.serial.locked}}});
    for(const img of ocrImages){if(img.ocrDone)await dbPut('session',{key:'ocr_'+img.id,value:{words:img.words}});}
  }catch(e){}
}
async function ocrRestoreSession(){
  if(!db)return;
  try{
    const tavRec=await dbGet('session','tav');
    if(tavRec?.value){['asset','serial'].forEach(f=>{if(tavRec.value[f]?.locked){tav[f].locked=true;tav[f].active=true;updateTAVUI(f);}});}
    const imgs=await dbGetAll('images');
    for(const rec of imgs){
      const dataUrl=await blobToDataUrl(rec.blob);
      const entry={id:rec.id,name:rec.name,blob:rec.blob,dataUrl,hash:rec.hash||'',ocrDone:false,words:[]};
      const ocrRec=await dbGet('session','ocr_'+rec.id);
      if(ocrRec?.value){entry.words=ocrRec.value.words;entry.ocrDone=true;}
      else ocrQueue.push(rec.id);
      ocrImages.push(entry);
      if(rec.hash)ocrImageHashes.add(rec.hash);
      addOcrThumb(entry);
    }
    if(ocrImages.length){
      document.getElementById('ocrDropZone').classList.add('hidden');
      ocrCanvas.style.display='block';
      selectOcrImage(ocrImages[0].id);
    }
  }catch(e){}
}
async function updateOcrStorage(){
  if(!navigator.storage?.estimate)return;
  try{
    const{usage=0,quota=1}=await navigator.storage.estimate();
    const pct=Math.min(usage/quota*100,100);
    document.getElementById('ocrStorageLabel').textContent=`${(usage/1048576).toFixed(1)}MB / ${(quota/1073741824).toFixed(1)}GB`;
    const fill=document.getElementById('ocrStorageFill');
    fill.style.width=pct+'%';fill.style.background=pct>80?'var(--danger)':pct>50?'var(--warn)':'var(--accent)';
  }catch(e){}
}
function blobToDataUrl(blob){return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(blob);});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR FILE HANDLING (with dedup)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('ocrFileInput').addEventListener('change',e=>ocrHandleFiles(e.target.files));
function ocrHandleDrop(e){e.preventDefault();e.currentTarget.style.borderColor='';ocrHandleFiles(e.dataTransfer.files);}
async function ocrHandleFiles(fileList){
  const files=Array.from(fileList).filter(f=>f.type.startsWith('image/')||f.name.toLowerCase().endsWith('.heic'));
  if(!files.length)return;
  let dupCount=0;
  document.getElementById('ocrDropZone').classList.add('hidden');
  ocrCanvas.style.display='block';
  for(const file of files){
    let blob=file;
    if(file.name.toLowerCase().endsWith('.heic')||file.type==='image/heif'){try{const h=await loadHeic2Any();blob=await h({blob:file,toType:'image/jpeg',quality:.92});}catch(e){}}
    // Hash check for dedup
    const hash=await hashFile(blob);
    if(ocrImageHashes.has(hash)){dupCount++;continue;}
    ocrImageHashes.add(hash);
    const id='img_'+Date.now()+'_'+Math.random().toString(36).slice(2);
    const dataUrl=await blobToDataUrl(blob);
    const entry={id,name:file.name,blob,dataUrl,hash,ocrDone:false,words:[]};
    ocrImages.push(entry);
    if(db)await dbPut('images',{id,name:file.name,blob,hash});
    addOcrThumb(entry);
    ocrQueue.push(id);
  }
  if(dupCount>0){alert(`${dupCount} duplicate image${dupCount>1?'s were':' was'} skipped (already added).`);}
  if(!ocrActiveId&&ocrImages.length)selectOcrImage(ocrImages[0].id);
  ocrProcessQueue();updateOcrStorage();ocrScheduleSave();
}
let heic2anyLoaded=null;
async function loadHeic2Any(){
  if(heic2anyLoaded)return heic2anyLoaded;
  return new Promise((res,rej)=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js';s.onload=()=>{heic2anyLoaded=window.heic2any;res(window.heic2any);};s.onerror=rej;document.head.appendChild(s);});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DELETE OCR IMAGE (sends to bin + removes linked pairs)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function deleteOcrImage(id){
  const img=ocrImages.find(i=>i.id===id);if(!img)return;
  // Find all OCR entries that use this image
  const linkedEntries=[];
  [...pallets,damagedPallet].forEach(p=>{
    p.entries.forEach(e=>{
      if(e.type==='ocr'&&e.imageIds&&e.imageIds.includes(id))linkedEntries.push({entry:e,pallet:p});
    });
  });
  // Send image to bin
  recycleBin.push({id:'bin_'+Date.now()+'_'+Math.random().toString(36).slice(2),type:'image',deletedAt:Date.now(),description:`Image: ${img.name}`,data:{img},linkedEntryIds:linkedEntries.map(l=>l.entry.id)});
  // Send linked pairs to bin too
  for(const{entry,pallet}of linkedEntries){
    recycleBin.push({id:'bin_'+Date.now()+'_'+Math.random().toString(36).slice(2),type:'entry',deletedAt:Date.now(),description:`OCR Pair: AT ${entry.asset} ‚Üí SN ${entry.serial}`,data:{entry:JSON.parse(JSON.stringify(entry)),palletId:pallet.id},linkedImageIds:entry.imageIds||[]});
    const idx=pallet.entries.findIndex(e=>e.id===entry.id);
    if(idx!==-1){globalAssetTags.delete(entry.asset);globalSerials.delete(entry.serial);pallet.entries.splice(idx,1);}
  }
  // Remove image from ocrImages
  ocrImageHashes.delete(img.hash);
  ocrImages=ocrImages.filter(i=>i.id!==id);
  // Remove from DB
  if(db){try{await dbDelete('images',id);await dbDelete('session','ocr_'+id);}catch(e){}}
  // Remove thumb
  const wrap=document.querySelector(`.thumb-wrapper[data-id="${id}"]`);if(wrap)wrap.remove();
  // Select next image
  if(ocrActiveId===id){
    ocrActiveId=null;
    if(ocrImages.length)selectOcrImage(ocrImages[0].id);
    else{ocrCanvas.style.display='none';document.getElementById('ocrDropZone').classList.remove('hidden');}
  }
  renderEntries();updateStats();updateHeaderStats();updateTiles();renderDamagedPalletList();renderOcrPairsList();updateBinBadge();updateOcrStorage();scheduleSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR PROCESSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function ocrProcessQueue(){
  if(!ocrWorkerReady||ocrBusy||!ocrQueue.length)return;
  ocrBusy=true;
  const id=ocrQueue.shift();
  const img=ocrImages.find(i=>i.id===id);
  if(!img){ocrBusy=false;ocrProcessQueue();return;}
  if(ocrActiveId===id)document.getElementById('ocrOverlay').classList.add('visible');
  try{
    const result=await ocrWorker.recognize(img.dataUrl);
    img.words=result.data.words.filter(w=>w.text.trim().length>0);
    img.ocrDone=true;
    document.getElementById('ocrProgressFill').style.width='0';
    if(ocrActiveId===id)renderOcrCanvas();
    ocrScheduleSave();
  }catch(e){}
  document.getElementById('ocrOverlay').classList.remove('visible');
  ocrBusy=false;ocrProcessQueue();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR CANVAS (with smart bounding boxes - only asset/serial patterns)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectOcrImage(id){
  ocrActiveId=id;ocrSelectedBox=null;
  document.getElementById('selPreview').textContent='‚Äî click or draw a region ‚Äî';
  document.getElementById('btnAssignAsset').disabled=document.getElementById('btnAssignSerial').disabled=true;
  document.querySelectorAll('.image-thumb').forEach(t=>t.classList.toggle('active',t.dataset.id===id));
  // Ensure canvas is visible and drop zone hidden whenever an image is selected
  document.getElementById('ocrDropZone').classList.add('hidden');
  ocrCanvas.style.display='block';
  renderOcrCanvas();
}
function renderOcrCanvas(){
  const img=ocrImages.find(i=>i.id===ocrActiveId);if(!img)return;
  const area=document.getElementById('ocrCanvasArea');
  const maxW=area.clientWidth-20,maxH=area.clientHeight-20;
  const image=new Image();
  image.onload=()=>{
    const scale=Math.min(maxW/image.width,maxH/image.height,1);
    ocrCanvasScale=scale;
    ocrCanvas.width=Math.round(image.width*scale);ocrCanvas.height=Math.round(image.height*scale);
    ocrCtx.drawImage(image,0,0,ocrCanvas.width,ocrCanvas.height);
    if(img.ocrDone){
      // Only draw boxes for words matching asset or serial patterns
      const boxes=img.words.filter(w=>looksLikeAssetOrSerial(w.text));
      for(const box of boxes){
        const{x0,y0,x1,y1}=box.bbox;
        const isAsset=ASSET_RE.test(box.text.trim().replace(/[^0-9]/g,''));
        ocrCtx.strokeStyle=isAsset?'rgba(232,255,0,.7)':'rgba(0,229,255,.65)';
        ocrCtx.lineWidth=1.8;
        ocrCtx.strokeRect(x0*scale,y0*scale,(x1-x0)*scale,(y1-y0)*scale);
        ocrCtx.fillStyle=isAsset?'rgba(232,255,0,.06)':'rgba(0,229,255,.05)';
        ocrCtx.fillRect(x0*scale,y0*scale,(x1-x0)*scale,(y1-y0)*scale);
        // Label
        ocrCtx.fillStyle=isAsset?'rgba(232,255,0,.85)':'rgba(0,229,255,.8)';
        ocrCtx.font=`${Math.max(8,Math.round(10*scale))}px monospace`;
        ocrCtx.fillText(box.text.trim(),x0*scale+2,y0*scale-3);
      }
      if(ocrSelectedBox){const{x0,y0,x1,y1}=ocrSelectedBox.bbox;ocrCtx.strokeStyle='#ffb347';ocrCtx.lineWidth=2.5;ocrCtx.strokeRect(x0*scale,y0*scale,(x1-x0)*scale,(y1-y0)*scale);ocrCtx.fillStyle='rgba(255,179,71,.12)';ocrCtx.fillRect(x0*scale,y0*scale,(x1-x0)*scale,(y1-y0)*scale);}
    }else{ocrCtx.fillStyle='rgba(232,255,0,.6)';ocrCtx.font='12px Share Tech Mono';ocrCtx.fillText(ocrWorkerReady?'Queued for OCR‚Ä¶':'Waiting for engine‚Ä¶',10,20);}
  };image.src=img.dataUrl;
}
function drawLiveRect(){
  if(!drawRect)return;
  const{x0,y0,x1,y1}=drawRect;const s=ocrCanvasScale;
  ocrCtx.save();ocrCtx.strokeStyle='#ffb347';ocrCtx.lineWidth=2;ocrCtx.setLineDash([5,3]);
  ocrCtx.strokeRect(x0*s,y0*s,(x1-x0)*s,(y1-y0)*s);ocrCtx.fillStyle='rgba(255,179,71,.1)';
  ocrCtx.fillRect(x0*s,y0*s,(x1-x0)*s,(y1-y0)*s);ocrCtx.setLineDash([]);ocrCtx.restore();
}
function canvasXY(e){const r=ocrCanvas.getBoundingClientRect();return{x:(e.clientX-r.left)/ocrCanvasScale,y:(e.clientY-r.top)/ocrCanvasScale};}
function hitTest(x,y){
  const img=ocrImages.find(i=>i.id===ocrActiveId);if(!img?.ocrDone)return null;
  // Only hit-test on boxes we're actually drawing (matching words)
  const boxes=img.words.filter(w=>looksLikeAssetOrSerial(w.text));
  return boxes.find(({bbox:{x0,y0,x1,y1}})=>x>=x0&&x<=x1&&y>=y0&&y<=y1)||null;
}
function autoAssignOcr(){const atV=document.getElementById('atInput').value.trim();const snV=document.getElementById('snInput').value.trim();if(!atV)ocrAssignSelected('asset');else if(!snV)ocrAssignSelected('serial');}

ocrCanvas.addEventListener('mousedown',e=>{
  if(!ocrImages.find(i=>i.id===ocrActiveId))return;
  pointerDown=true;didDrag=false;drawRect=null;pointerStart=canvasXY(e);hitOnDown=hitTest(pointerStart.x,pointerStart.y);
});
ocrCanvas.addEventListener('mousemove',e=>{
  if(!pointerDown)return;
  const pos=canvasXY(e);const dx=Math.abs(pos.x-pointerStart.x),dy=Math.abs(pos.y-pointerStart.y);
  if(!hitOnDown&&(dx>4||dy>4)){
    didDrag=true;
    drawRect={x0:Math.min(pointerStart.x,pos.x),y0:Math.min(pointerStart.y,pos.y),x1:Math.max(pointerStart.x,pos.x),y1:Math.max(pointerStart.y,pos.y)};
    renderOcrCanvas();drawLiveRect();
  }
});
ocrCanvas.addEventListener('mouseup',async e=>{
  if(!pointerDown)return;pointerDown=false;
  if(didDrag&&drawRect&&(drawRect.x1-drawRect.x0)>=5&&(drawRect.y1-drawRect.y0)>=5){
    const img=ocrImages.find(i=>i.id===ocrActiveId);
    if(!img||!ocrWorker){drawRect=null;return;}
    const{x0,y0,x1,y1}=drawRect;const cw=Math.round(x1-x0),ch=Math.round(y1-y0);
    const cc=document.createElement('canvas');cc.width=cw;cc.height=ch;
    await new Promise(res=>{const si=new Image();si.onload=()=>{cc.getContext('2d').drawImage(si,x0,y0,cw,ch,0,0,cw,ch);res();};si.src=img.dataUrl;});
    document.getElementById('ocrOverlay').classList.add('visible');
    try{
      const result=await ocrWorker.recognize(cc);
      const text=result.data.text.trim().replace(/[\n\r]+/g,' ').replace(/\s+/g,' ');
      ocrSelectedBox={text,bbox:{x0,y0,x1,y1}};
      document.getElementById('selPreview').textContent=text||'(no text found)';
      document.getElementById('btnAssignAsset').disabled=document.getElementById('btnAssignSerial').disabled=false;
      if(text)autoAssignOcr();
    }catch(err){}
    document.getElementById('ocrOverlay').classList.remove('visible');
    document.getElementById('ocrProgressFill').style.width='0';
    drawRect=null;renderOcrCanvas();
  }else if(hitOnDown){
    ocrSelectedBox=hitOnDown;
    document.getElementById('selPreview').textContent=hitOnDown.text;
    document.getElementById('btnAssignAsset').disabled=document.getElementById('btnAssignSerial').disabled=false;
    drawRect=null;renderOcrCanvas();autoAssignOcr();
  }else{drawRect=null;}
  didDrag=false;hitOnDown=null;
});
ocrCanvas.addEventListener('mouseleave',()=>{if(pointerDown){pointerDown=false;didDrag=false;hitOnDown=null;drawRect=null;renderOcrCanvas();}});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR ASSIGN + PAIR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ocrAssignSelected(field){
  if(!ocrSelectedBox)return;
  const img=ocrImages.find(i=>i.id===ocrActiveId);if(!img)return;
  const{x0,y0,x1,y1}=ocrSelectedBox.bbox;const cw=x1-x0,ch=y1-y0;
  const cc=document.createElement('canvas');cc.width=cw;cc.height=ch;
  const si=new Image();
  si.onload=()=>{cc.getContext('2d').drawImage(si,x0,y0,cw,ch,0,0,cw,ch);ocrCurrentPair[field+'Crop']=cc;updateOcrPreview(field);};
  si.src=img.dataUrl;
  ocrCurrentPair[field]=ocrSelectedBox.text;
  ocrCurrentPair.imageIds.add(ocrActiveId);
  const inp=document.getElementById(field==='asset'?'atInput':'snInput');
  inp.value=ocrSelectedBox.text;ocrOnFieldInput(field);
  updateOcrThumbBadges();
}
function updateOcrPreview(field){
  const pc=document.getElementById(field==='asset'?'atPreview':'snPreview');
  const inp=document.getElementById(field==='asset'?'atInput':'snInput');
  const src=ocrCurrentPair[field+'Crop'];if(!src)return;
  pc.classList.remove('empty');const pCtx=pc.getContext('2d');
  const s=Math.min(pc.width/src.width,pc.height/src.height);
  const dw=src.width*s,dh=src.height*s;
  const imgX=(pc.width-dw)/2;
  pCtx.fillStyle='#0d1117';pCtx.fillRect(0,0,pc.width,pc.height);
  pCtx.drawImage(src,0,0,src.width,src.height,imgX,(pc.height-dh)/2,dw,dh);
  // Sync input font size + letter-spacing to match rendered image width
  const text=inp.value.trim();
  if(text&&text.length>0){
    const inputEl=inp;
    const inputWidth=inputEl.getBoundingClientRect().width||270;
    const padPx=16; // 8px padding each side
    const availWidth=inputWidth-padPx;
    // Target: text spans ~dw pixels rendered in the preview (scale to input width)
    // Ratio of preview canvas width to actual input width
    const previewToInput=inputWidth/pc.offsetWidth||1;
    const targetTextWidth=dw*previewToInput;
    const charCount=text.length;
    // Calculate font size to fill ~targetTextWidth
    // Use canvas to measure at candidate sizes
    const mc=document.createElement('canvas').getContext('2d');
    let bestSize=14;
    for(let sz=8;sz<=32;sz++){
      mc.font=`${sz}px 'Share Tech Mono', monospace`;
      const w=mc.measureText(text).width;
      if(w<=availWidth*0.85)bestSize=sz;
    }
    mc.font=`${bestSize}px 'Share Tech Mono', monospace`;
    const baseWidth=mc.measureText(text).width;
    const gap=(Math.min(targetTextWidth,availWidth*0.9)-baseWidth)/Math.max(charCount-1,1);
    const letterSpacingPx=Math.max(2,Math.min(gap,30));
    inputEl.style.fontSize=bestSize+'px';
    inputEl.style.letterSpacing=letterSpacingPx+'px';
    // Offset left padding to align text start with image start
    const textTotalWidth=baseWidth+(charCount-1)*letterSpacingPx;
    const imageStartInInput=imgX*(inputWidth/pc.width);
    const paddingLeft=Math.max(8,imageStartInInput);
    inputEl.style.paddingLeft=paddingLeft+'px';
  }
}

function ocrFinalizePair(){
  const pallet=getActivePallet();
  if(!pallet){alert('Select a pallet first (use ‚äû Pallets & Presets).');return;}
  if(!activePresetId){alert('Select a preset first (use ‚äû Pallets & Presets).');return;}
  const atRaw=document.getElementById('atInput').value.trim();
  const snRaw=document.getElementById('snInput').value.trim();
  const atVal=atRaw===''?SKIP:atRaw;
  const snVal=snRaw===''?SKIP:snRaw;
  if(atVal===SKIP&&snVal===SKIP){alert('At least one field must have a value.');return;}
  const atOk=ocrValidateField('asset');const snOk=ocrValidateField('serial');
  if(!atOk||!snOk){return;}

  const preset=getActivePreset();
  const isDamaged=!!(preset&&preset.isDamaged);
  const entry={
    id:'e_'+Date.now()+'_'+Math.random().toString(36).slice(2),
    type:'ocr',asset:atVal,serial:snVal,
    presetId:activePresetId,
    imageIds:[...ocrCurrentPair.imageIds],
    bypassAsset:tav.asset.active,bypassSerial:tav.serial.active,
    isDamaged,storageNone:!storageLogDefault
  };
  if(atVal!==SKIP)globalAssetTags.add(atVal);
  if(snVal!==SKIP)globalSerials.add(snVal);
  const targetPallet=isDamaged?damagedPallet:pallet;
  targetPallet.entries.push(entry);

  renderEntries();updateStats();updateHeaderStats();updateTiles();renderDamagedPalletList();
  logScan('ocr',`OCR Pair: ${atVal} ‚Üí ${snVal}${isDamaged?' [‚ÜíDamaged]':''}`);
  beep('ocr');
  resetTAV('asset');resetTAV('serial');
  ocrClearPair();renderOcrPairsList();scheduleSave();
  updateOcrThumbBadges();checkOverweightAlert(pallet);

  // advance to next unassigned image
  const assignedIds=new Set([...pallets,damagedPallet].flatMap(p=>p.entries.filter(e=>e.type==='ocr').flatMap(e=>e.imageIds)));
  const next=ocrImages.find(i=>!assignedIds.has(i.id));
  if(next)selectOcrImage(next.id);
}

function ocrClearPair(){
  ocrCurrentPair={asset:null,serial:null,assetCrop:null,serialCrop:null,imageIds:new Set()};
  ['atInput','snInput'].forEach(id=>{const el=document.getElementById(id);el.value='';el.className='';el.style.fontSize='';el.style.letterSpacing='';el.style.paddingLeft='';});
  ['atError','snError'].forEach(id=>document.getElementById(id).textContent='');
  ['atPreview','snPreview'].forEach(id=>{const c=document.getElementById(id);c.classList.add('empty');c.getContext('2d').clearRect(0,0,c.width,c.height);});
  ocrSelectedBox=null;document.getElementById('selPreview').textContent='‚Äî click or draw a region ‚Äî';
  document.getElementById('btnAssignAsset').disabled=document.getElementById('btnAssignSerial').disabled=true;
  renderOcrCanvas();
}

function renderOcrPairsList(){
  const list=document.getElementById('ocrPairsList');
  const allOcr=[...pallets,damagedPallet].flatMap(p=>p.entries.filter(e=>e.type==='ocr').map(e=>({...e,palletName:p.name})));
  document.getElementById('ocrPairsCount').textContent=allOcr.length;
  if(!allOcr.length){list.innerHTML='<div style="color:var(--muted);font-family:Share Tech Mono,monospace;font-size:.58rem;padding:8px;">No OCR pairs yet</div>';return;}
  list.innerHTML=allOcr.slice().reverse().map(e=>`<div class="ocr-pair-card">
    <div><div class="opc-at">AT: ${escHtml(e.asset)}</div><div class="opc-sn">SN: ${escHtml(e.serial)}</div><div class="opc-pallet">üì¶ ${escHtml(e.palletName)}</div></div>
    <span class="opc-del" onclick="deleteEntry('${e.id}')">‚úï</span>
  </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR THUMBNAILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addOcrThumb(img){
  const wrap=document.createElement('div');wrap.className='thumb-wrapper';wrap.dataset.id=img.id;
  const thumb=document.createElement('img');thumb.className='image-thumb';thumb.dataset.id=img.id;
  thumb.src=img.dataUrl;thumb.title=img.name;
  thumb.onclick=()=>selectOcrImage(img.id);
  const delBtn=document.createElement('button');delBtn.className='thumb-del-btn';delBtn.textContent='üóë';delBtn.title='Delete image';
  delBtn.onclick=(e)=>{
    e.stopPropagation();
    // Find linked pairs for this image
    const linked=[];
    [...pallets,damagedPallet].forEach(p=>{
      p.entries.forEach(en=>{
        if(en.type==='ocr'&&en.imageIds&&en.imageIds.includes(img.id))linked.push({entry:en,palletName:p.name});
      });
    });
    let msg=`Delete image "${img.name}"?`;
    if(linked.length>0){
      const pairLines=linked.map(l=>`  ‚Ä¢ AT: ${l.entry.asset} / SN: ${l.entry.serial} (${l.palletName})`).join('\n');
      msg+=`\n\nThe following OCR pair${linked.length>1?'s':''} will also be deleted:\n${pairLines}`;
    }else{
      msg+='\n\nNo OCR pairs are linked to this image.';
    }
    msg+='\n\nAre you sure?';
    if(confirm(msg))deleteOcrImage(img.id);
  };
  wrap.appendChild(thumb);wrap.appendChild(delBtn);document.getElementById('ocrThumbList').appendChild(wrap);
}
function updateOcrThumbBadges(){
  const ocrEntries=[...pallets,damagedPallet].flatMap(p=>p.entries.filter(e=>e.type==='ocr'));
  document.querySelectorAll('#ocrThumbList .thumb-wrapper').forEach(w=>{
    const id=w.dataset.id;
    const entry=ocrEntries.find(e=>e.imageIds&&e.imageIds.includes(id));
    w.querySelectorAll('.thumb-badge').forEach(b=>b.remove());
    const thumb=w.querySelector('.image-thumb');
    thumb.className='image-thumb'+(id===ocrActiveId?' active':'');
    if(entry){
      const hasAt=entry.asset!==SKIP,hasSn=entry.serial!==SKIP;
      if(hasAt&&hasSn){thumb.classList.add('assigned-both');badge(w,'both','‚úì');}
      else if(hasAt){thumb.classList.add('assigned-asset');badge(w,'at','AT');}
      else{thumb.classList.add('assigned-serial');badge(w,'sn','SN');}
    }
  });
}
function badge(wrap,cls,text){const b=document.createElement('div');b.className='thumb-badge '+cls;b.textContent=text;wrap.insertBefore(b,wrap.querySelector('.thumb-del-btn'));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECYCLING BIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateBinBadge(){
  const badge=document.getElementById('recycleBadge');
  const count=recycleBin.length;
  badge.textContent=count;
  badge.classList.toggle('hidden',count===0);
}
function openRecycleBin(){renderBinList();document.getElementById('recycleBinModal').classList.add('open');}
function closeRecycleBin(){document.getElementById('recycleBinModal').classList.remove('open');}
function renderBinList(){
  const list=document.getElementById('binList');
  const empty=document.getElementById('binEmpty');
  document.getElementById('binCountLabel').textContent=recycleBin.length;
  if(recycleBin.length===0){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=recycleBin.slice().reverse().map(item=>{
    const d=new Date(item.deletedAt);
    const ts=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+' '+d.toLocaleDateString();
    const typeLabel=item.type==='image'?'üñº Image':item.type==='entry'?'üìã Entry':'üì¶ Pallet';
    return `<div class="bin-entry">
      <div class="bin-entry-info">
        <div class="bin-entry-type">${typeLabel}</div>
        <div class="bin-entry-main">${escHtml(item.description)}</div>
        <div class="bin-entry-time">Deleted ${ts}</div>
      </div>
      <div class="bin-actions">
        <button class="bin-restore-btn" onclick="restoreFromBin('${item.id}')">‚Ü© Restore</button>
        <button class="bin-perm-del-btn" onclick="permDeleteFromBin('${item.id}')">‚úï</button>
      </div>
    </div>`;
  }).join('');
}
function restoreFromBin(binId){
  const idx=recycleBin.findIndex(b=>b.id===binId);if(idx===-1)return;
  const item=recycleBin[idx];
  if(item.type==='entry'){
    // Restore entry to its pallet
    const pallet=item.data.palletId===DAMAGED_PALLET_ID?damagedPallet:pallets.find(p=>p.id===item.data.palletId);
    if(!pallet){alert('Original pallet no longer exists.');recycleBin.splice(idx,1);renderBinList();updateBinBadge();return;}
    const e=item.data.entry;
    // Check for conflicts
    if(e.asset&&e.asset!==SKIP&&globalAssetTags.has(e.asset)){alert(`Cannot restore: Asset tag "${e.asset}" already exists.`);return;}
    if(e.serial&&e.serial!==SKIP&&globalSerials.has(e.serial)){alert(`Cannot restore: Serial "${e.serial}" already exists.`);return;}
    pallet.entries.push(e);
    if(e.asset&&e.asset!==SKIP)globalAssetTags.add(e.asset);
    if(e.serial&&e.serial!==SKIP)globalSerials.add(e.serial);
    recycleBin.splice(idx,1);
    renderEntries();updateStats();updateHeaderStats();updateTiles();renderDamagedPalletList();renderOcrPairsList();scheduleSave();
  }else if(item.type==='image'){
    // Restore image - re-add to ocrImages
    const imgData=item.data.img;
    if(ocrImages.find(i=>i.id===imgData.id)){alert('Image already exists.');recycleBin.splice(idx,1);renderBinList();updateBinBadge();return;}
    ocrImages.push(imgData);
    if(imgData.hash)ocrImageHashes.add(imgData.hash);
    if(db)dbPut('images',{id:imgData.id,name:imgData.name,blob:imgData.blob,hash:imgData.hash}).catch(()=>{});
    addOcrThumb(imgData);
    recycleBin.splice(idx,1);
    if(imgData.ocrDone)ocrScheduleSave();else ocrQueue.push(imgData.id);
    ocrProcessQueue();updateOcrStorage();
  }
  renderBinList();updateBinBadge();
}
function permDeleteFromBin(binId){
  const idx=recycleBin.findIndex(b=>b.id===binId);if(idx===-1)return;
  recycleBin.splice(idx,1);
  renderBinList();updateBinBadge();
}
function restoreAllFromBin(){
  const items=[...recycleBin];
  for(const item of items)restoreFromBin(item.id);
}
function emptyBin(){
  if(!recycleBin.length)return;
  if(!confirm(`Permanently delete all ${recycleBin.length} items from the bin?`))return;
  recycleBin=[];renderBinList();updateBinBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BYPASS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateBypassUI(){
  const ba=document.getElementById('bypassAsset').checked,bs=document.getElementById('bypassSerial').checked;
  const wrap=document.getElementById('bypassBadgeWrap');wrap.innerHTML='';
  if(ba||bs){const p=[ba&&'ASSET',bs&&'SERIAL'].filter(Boolean).join('+');wrap.innerHTML=`<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,179,71,.1);border:1px solid rgba(255,179,71,.3);color:var(--warn);font-family:'Share Tech Mono',monospace;font-size:.56rem;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:8px;">‚ö† Bypass: ${p}</span>`;}
  document.getElementById('assetInput').placeholder=ba?'Any value accepted‚Ä¶':'Scan 6-digit number‚Ä¶';
  updateScanBlockState();
}
function updateScanBlockState(){
  const hasPreset=!!activePresetId;
  const ai=document.getElementById('assetInput'),si=document.getElementById('serialInput');
  if(!hasPreset){ai.disabled=true;si.disabled=true;ai.classList.add('blocked');si.classList.add('blocked');setStatus('warn','Select or create a preset before scanning');}
  else{ai.disabled=false;si.disabled=false;ai.classList.remove('blocked');si.classList.remove('blocked');if(!assetPending)setStatus('ready','Ready ‚Äî scan or type asset tag first');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WEIGHT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcPalletWeight(pallet){
  if(pallet.isDamaged)return{total:0,missing:0};
  let total=PALLET_WEIGHT,missing=0;
  pallet.entries.forEach(e=>{
    if(e.type==='pair'||e.type==='ocr'){const preset=getAllPresets().find(p=>p.id===e.presetId);if(preset&&preset.weight)total+=parseFloat(preset.weight);else if(!preset?.isDamaged)missing++;}
    else if(e.type==='manual'&&e.weight)total+=e.weight;
  });
  return{total,missing};
}
let _lastOverweightAlerted=false;
function checkOverweightAlert(pallet){
  if(!pallet||pallet.isDamaged)return;
  const{total}=calcPalletWeight(pallet);
  const banner=document.getElementById('weightWarnBanner');const isOver=total>WEIGHT_LIMIT;
  banner.classList.toggle('visible',isOver);
  if(isOver){document.getElementById('weightWarnText').textContent=`‚ö† Pallet weight ~${total.toFixed(0)} lbs ‚Äî exceeds ${WEIGHT_LIMIT} lb limit.`;if(!_lastOverweightAlerted){beep('overweight');_lastOverweightAlerted=true;}}
  else _lastOverweightAlerted=false;
}
function updateWeightBar(){
  const pallet=getActivePallet();const wb=document.getElementById('weightBar');const pwi=document.getElementById('wPalletWi');
  if(!pallet||pallet.isDamaged){document.getElementById('wPallet').textContent='‚Äî';document.getElementById('wTotal').textContent='‚Äî';document.getElementById('weightNote').textContent='';wb.classList.remove('overweight');pwi.classList.remove('danger');return;}
  const pw=calcPalletWeight(pallet);const isOver=pw.total>WEIGHT_LIMIT;
  document.getElementById('wPallet').textContent=pw.total.toFixed(1)+' lbs';
  let shipTotal=0;pallets.forEach(p=>{shipTotal+=calcPalletWeight(p).total;});
  document.getElementById('wTotal').textContent=shipTotal.toFixed(1)+' lbs';
  document.getElementById('weightNote').textContent=pw.missing>0?`‚ö† ${pw.missing} missing weights`:'';
  wb.classList.toggle('overweight',isOver);pwi.classList.toggle('danger',isOver);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCAN LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleScanKey(e,field){
  if(e.key!=='Enter'&&e.key!=='Tab')return;
  e.preventDefault();
  const val=e.target.value.trim().toUpperCase();e.target.value='';
  if(!val)return;
  if(!activePresetId){setStatus('error','Select a preset before scanning');flashInput(field==='asset'?'assetInput':'serialInput','error');beep('error');return;}
  const pallet=getActivePallet();if(!pallet){setStatus('warn','No pallet selected');return;}
  const bypassAsset=document.getElementById('bypassAsset').checked;
  const bypassSerial=document.getElementById('bypassSerial').checked;
  if(field==='asset'){
    if(!bypassAsset&&!isValidAssetTag(val)){errorCount++;updateStats();setStatus('error',`INVALID ‚Äî "${val}" must be exactly 6 digits`);logScan('error',`Invalid asset tag: ${val}`);flashInput('assetInput','error');beep('error');return;}
    if(globalAssetTags.has(val)){dupeCount++;updateStats();setStatus('warn',`DUPLICATE ‚Äî "${val}" already exists`);logScan('warn',`Duplicate asset: ${val}`);flashInput('assetInput','error');beep('dupe');return;}
    assetPending=val;document.getElementById('assetInput').value=val;
    document.getElementById('assetInput').classList.remove('active-field');document.getElementById('assetInput').classList.add('filled-field');
    if(bypassAsset)document.getElementById('assetInput').classList.add('bypassed');
    document.getElementById('serialInput').classList.add('active-field');document.getElementById('serialInput').placeholder=bypassSerial?'Press Enter to skip serial‚Ä¶':'Scan 7-char serial‚Ä¶';
    setStatus('pair-ready',`Asset "${val}" captured ‚Äî ${bypassSerial?'press Enter to skip':'scan serial'}`);flashInput('assetInput','success');beep('tag');document.getElementById('serialInput').focus();
  }else if(field==='serial'){
    if(!assetPending){setStatus('warn','Scan asset tag first');return;}
    const effectiveVal=(!val&&bypassSerial)?('BYP'+Date.now().toString(36).toUpperCase().slice(-5)):val;
    const serialVal=effectiveVal||val;
    if(!bypassSerial&&!isValidSerial(serialVal)){errorCount++;updateStats();setStatus('error',`INVALID ‚Äî "${val}" must be 7 alphanumeric with letters + numbers`);logScan('error',`Invalid serial: ${val}`);flashInput('serialInput','error');beep('error');return;}
    if(globalSerials.has(serialVal)){dupeCount++;updateStats();setStatus('warn',`DUPLICATE ‚Äî serial "${serialVal}" exists`);logScan('warn',`Duplicate serial: ${serialVal}`);flashInput('serialInput','error');beep('dupe');return;}
    globalAssetTags.add(assetPending);globalSerials.add(serialVal);
    const preset=getActivePreset();const isDamaged=!!(preset&&preset.isDamaged);
    const entry={id:'e_'+Date.now()+'_'+Math.random().toString(36).slice(2),type:'pair',asset:assetPending,serial:serialVal,bypassAsset,bypassSerial,presetId:activePresetId,storageNone:!storageLogDefault,isDamaged};
    const targetPallet=isDamaged?damagedPallet:pallet;
    const firstManual=targetPallet.entries.findIndex(e=>e.type==='manual');
    if(firstManual===-1)targetPallet.entries.push(entry);else targetPallet.entries.splice(firstManual,0,entry);
    const dmgNote=isDamaged?' [‚Üí Damaged]':'';
    setStatus('success',`${isDamaged?'[DAMAGED] ':''}PAIR LOGGED ‚Äî ${assetPending} / ${serialVal}${dmgNote}`);
    logScan('pair',`${isDamaged?'[DMG] ':''}Pair: ${assetPending} ‚Üí ${serialVal}`);flashInput('serialInput','success');beep('pair');
    assetPending=null;document.getElementById('assetInput').value='';document.getElementById('assetInput').className='scan-input active-field';
    document.getElementById('serialInput').className='scan-input';document.getElementById('serialInput').placeholder='Waiting for asset tag‚Ä¶';document.getElementById('assetInput').focus();
    if(!isDamaged)checkOverweightAlert(pallet);
    renderEntries();updateStats();updateHeaderStats();updateTiles();renderDamagedPalletList();scheduleSave();
  }
}
function handleScanBlur(e,field){
  if(!e.target.value.trim())return;
  const goingTo=e.relatedTarget;const assetEl=document.getElementById('assetInput');
  if(field==='asset'){const fakeEvent={key:'Enter',preventDefault:()=>{},target:e.target};handleScanKey(fakeEvent,field);}
  else if(field==='serial'){if(goingTo===assetEl)return;const fakeEvent={key:'Enter',preventDefault:()=>{},target:e.target};handleScanKey(fakeEvent,field);}
}
function setStatus(t,m){document.getElementById('statusBar').className='status-bar '+t;document.getElementById('statusText').textContent=m;}
function flashInput(id,t){const el=document.getElementById(id);el.classList.remove('flash-success','flash-error');void el.offsetWidth;el.classList.add(t==='success'?'flash-success':'flash-error');setTimeout(()=>el.classList.remove('flash-success','flash-error'),400);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCAN LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function logScan(t,m){
  const log=document.getElementById('scanLog');
  const ts=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const d=document.createElement('div');d.className='log-entry '+t;
  d.innerHTML=`<span class="log-time">${ts}</span><span>${escHtml(m)}</span>`;
  const ph=log.querySelector('div:not(.ok):not(.pair):not(.warn):not(.error):not(.manual):not(.ocr)');if(ph)ph.remove();
  log.insertBefore(d,log.firstChild);while(log.children.length>80)log.removeChild(log.lastChild);
}
function toggleSection(toggleId,bodyId){const t=document.getElementById(toggleId),b=document.getElementById(bodyId);t.classList.toggle('collapsed');b.style.display=t.classList.contains('collapsed')?'none':'';}
document.addEventListener('change',e=>{if(e.target.id==='weightModeTotal')document.getElementById('weightModeLabel').textContent=e.target.checked?'Total':'Per Item';});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MANUAL ENTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addManualEntry(){
  const pallet=getActivePallet();if(!pallet){alert('Select a pallet first.');return;}
  const desc=document.getElementById('manualDesc').value.trim();const qty=parseInt(document.getElementById('manualQty').value)||1;const lbsRaw=parseFloat(document.getElementById('manualLbs').value)||0;const totalMode=document.getElementById('weightModeTotal').checked;
  if(!desc){document.getElementById('manualDesc').focus();return;}
  const weightTotal=totalMode?lbsRaw:(lbsRaw*qty);
  pallet.entries.push({id:'e_'+Date.now()+'_'+Math.random().toString(36).slice(2),type:'manual',description:desc,qty,weight:lbsRaw>0?weightTotal:null,presetId:null});
  document.getElementById('manualDesc').value='';document.getElementById('manualQty').value=1;document.getElementById('manualLbs').value='';
  logScan('manual',`Manual: ${qty}√ó ${desc}`);beep('manual');checkOverweightAlert(pallet);renderEntries();updateStats();updateHeaderStats();updateTiles();scheduleSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENTRIES TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dragSrcIdx=null;
function renderEntries(){
  const pallet=getActivePallet();const tbody=document.getElementById('entryTableBody');
  if(!pallet||pallet.entries.length===0){tbody.innerHTML='<tr><td colspan="7"><div class="empty-state">NO ENTRIES YET</div></td></tr>';updateWeightBar();return;}
  tbody.innerHTML=pallet.entries.map((e,i)=>{
    const preset=getAllPresets().find(p=>p.id===e.presetId);
    const isDmg=e.isDamaged||preset?.isDamaged;
    const ptag=preset?`<span class="preset-tag${isDmg?' dmg':''}">${escHtml(preset.name)}</span>`:'';
    const ra=`draggable="true" ondragstart="onDragStart(event,${i})" ondragover="onDragOver(event,${i})" ondrop="onDrop(event,${i})" ondragleave="onDragLeave(event)"`;
    const srcBadge=e.type==='ocr'?'<span class="source-badge ocr-badge">OCR</span>':'<span class="source-badge scan">SCAN</span>';
    if(e.type==='pair'||e.type==='ocr'){
      // Unified color: asset=ocr-accent (yellow-green), serial=accent2 (green), regardless of source
      const aC='e-asset'+(e.bypassAsset?' e-bypass':'')+(isDmg?' e-damaged':'');
      const sC='e-serial'+(e.bypassSerial?' e-bypass':'')+(isDmg?' e-damaged':'');
      return `<tr ${ra}><td><span class="drag-handle">‚†ø</span></td><td style="color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:.64rem;">${i+1}</td><td class="${aC}">${escHtml(e.asset)}</td><td class="${sC}">${escHtml(e.serial)}</td><td>${ptag}</td><td>${srcBadge}</td><td><button class="e-del" onclick="confirmDeleteEntry('${e.id}','pair',${JSON.stringify(e.asset)},${JSON.stringify(e.serial)})">‚úï</button></td></tr>`;
    }else{
      const wt=e.weight?` <span style="color:var(--warn);font-size:.6rem;">(${e.weight.toFixed(1)}lbs)</span>`:'';
      return `<tr ${ra}><td><span class="drag-handle">‚†ø</span></td><td style="color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:.64rem;">${i+1}</td><td class="e-manual" colspan="2"><span style="color:var(--muted);font-size:.8rem;margin-right:4px;">√ó${e.qty}</span>${escHtml(e.description)}${wt}</td><td></td><td></td><td><button class="e-del" onclick="confirmDeleteEntry('${e.id}','manual',''+e.description,null,e.qty)">‚úï</button></td></tr>`;
    }
  }).join('');
  updateWeightBar();
}
function onDragStart(e,i){dragSrcIdx=i;e.currentTarget.classList.add('dragging');}
function onDragOver(e,i){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function onDragLeave(e){e.currentTarget.classList.remove('drag-over');}
function onDrop(e,i){e.preventDefault();e.currentTarget.classList.remove('drag-over');const pallet=getActivePallet();if(!pallet||dragSrcIdx===null||dragSrcIdx===i){dragSrcIdx=null;return;}const[moved]=pallet.entries.splice(dragSrcIdx,1);pallet.entries.splice(i,0,moved);dragSrcIdx=null;renderEntries();scheduleSave();}

function confirmDeleteEntry(id, type, labelA, labelB, qty){
  let msg;
  if(type==='manual'){
    msg=`Delete manual entry "${qty}√ó ${labelA}"?`;
  }else{
    msg=`Delete entry?

  Asset Tag: ${labelA}
  Serial:    ${labelB}

This will move it to the recycling bin.`;
  }
  if(confirm(msg))deleteEntry(id);
}
function deleteEntry(id){
  const all=[...pallets,damagedPallet];
  for(const pallet of all){
    const idx=pallet.entries.findIndex(e=>String(e.id)===String(id));
    if(idx===-1)continue;
    const e=pallet.entries[idx];
    // Add to recycle bin
    const desc=e.type==='pair'||e.type==='ocr'?`${e.type==='ocr'?'OCR Pair':'Scan Pair'}: AT ${e.asset} ‚Üí SN ${e.serial}`:`Manual: ${e.qty}√ó ${e.description}`;
    recycleBin.push({id:'bin_'+Date.now()+'_'+Math.random().toString(36).slice(2),type:'entry',deletedAt:Date.now(),description:desc,data:{entry:JSON.parse(JSON.stringify(e)),palletId:pallet.id},linkedImageIds:e.imageIds||[]});
    if(e.type==='pair'||e.type==='ocr'){globalAssetTags.delete(e.asset);globalSerials.delete(e.serial);}
    pallet.entries.splice(idx,1);
    break;
  }
  updateBinBadge();
  renderEntries();updateStats();updateHeaderStats();updateTiles();checkOverweightAlert(getActivePallet()||{isDamaged:true});renderDamagedPalletList();renderOcrPairsList();updateOcrThumbBadges();scheduleSave();
}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATS + TILES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats(){
  const p=getActivePallet();
  document.getElementById('statPairs').textContent=p?p.entries.filter(e=>e.type==='pair').length:0;
  document.getElementById('statOcr').textContent=p?p.entries.filter(e=>e.type==='ocr').length:0;
  document.getElementById('statManual').textContent=p?p.entries.filter(e=>e.type==='manual').length:0;
  document.getElementById('statDupes').textContent=dupeCount;document.getElementById('statErrors').textContent=errorCount;
}
function updateTiles(){
  const p=getActivePallet();document.getElementById('tilePalletCount').textContent=p?p.entries.filter(e=>e.type==='pair'||e.type==='ocr').length:0;
  const allPairs=pallets.reduce((a,pp)=>a+pp.entries.filter(e=>e.type==='pair'||e.type==='ocr').length,0);
  document.getElementById('tileGlobalCount').textContent=allPairs+damagedPallet.entries.filter(e=>e.type==='pair'||e.type==='ocr').length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRESET BAR (SCAN MODE)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPresetBar(){
  const wrap=document.getElementById('presetBarWrap');const preset=getActivePreset();
  if(preset){
    const isDmg=preset.isDamaged;const hasRealStorage=!preset.noStorage&&preset.storage;
    let storagePill='';
    if(!isDmg&&hasRealStorage)storagePill=storageLogDefault?`<span class="drive-pill dp-ok" onclick="toggleStorageLog()" title="Click to log None"><span class="dp-dot"></span>${preset.storage} GB</span>`:`<span class="drive-pill dp-none" onclick="toggleStorageLog()" title="Click to log size"><span class="dp-dot"></span>No Drive</span>`;
    else if(!isDmg&&preset.noStorage)storagePill=`<span class="drive-pill dp-none" title="No storage"><span class="dp-dot"></span>No Drive</span>`;
    const details=isDmg?'Asset + Serial only':[preset.mfr,preset.cpu,preset.ram?preset.ram+' GB RAM':''].filter(Boolean).join(' ¬∑ ');
    wrap.innerHTML=`<div class="preset-bar active-p${isDmg?' damaged':''}">
      <span class="pb-label">Preset ‚ñ∏</span><span class="pb-name" style="${isDmg?'color:var(--danger)':''}">${escHtml(preset.name)}</span>
      <span class="pb-detail">${escHtml(details)}</span>${storagePill}
      <button class="btn" style="padding:2px 7px;font-size:.56rem;" onclick="clearActivePreset()">‚úï</button>
    </div>`;
  }else{
    wrap.innerHTML=`<div class="preset-bar no-p" onclick="openPresetModal()"><span class="pb-label">‚õî No Preset Selected</span><span class="pb-name" style="color:var(--muted);font-size:.72rem;">Scanning is blocked ‚Äî select or create a preset</span></div>`;
  }
  updateScanBlockState();
}
function toggleStorageLog(){storageLogDefault=!storageLogDefault;renderPresetBar();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PALLETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPalletModal(){document.getElementById('newPalletName').value='';document.getElementById('palletModal').classList.add('open');setTimeout(()=>document.getElementById('newPalletName').focus(),50);}
function closePalletModal(){document.getElementById('palletModal').classList.remove('open');}
function confirmNewPallet(){const name=document.getElementById('newPalletName').value.trim();if(!name){document.getElementById('newPalletName').focus();return;}const pallet={id:'p_'+Date.now(),name,entries:[]};pallets.push(pallet);closePalletModal();selectPallet(pallet.id);renderPalletList();if(ocrTopPanelOpen)renderOcrInlinePallets();scheduleSave();}
function selectPallet(id){
  activePalletId=id;assetPending=null;dupeCount=0;errorCount=0;_lastOverweightAlerted=false;rebuildGlobalSets();
  document.getElementById('noPalletScreen').style.display='none';document.getElementById('palletWorkspace').style.display='flex';
  const pallet=getActivePallet();const isDmg=pallet&&pallet.isDamaged;
  document.getElementById('damagedHeaderBadge').innerHTML=isDmg?'<span class="damaged-header-badge">‚ö† Damaged Assets ‚Äî No Weight Calculated</span>':'';
  document.getElementById('weightBar').style.display=isDmg?'none':'';document.getElementById('weightWarnBanner').classList.remove('visible');
  updateHeaderStats();renderPalletList();renderDamagedPalletList();renderEntries();updateStats();updateTiles();
  document.getElementById('assetInput').value='';document.getElementById('serialInput').value='';
  document.getElementById('assetInput').className='scan-input active-field';document.getElementById('serialInput').className='scan-input';document.getElementById('serialInput').placeholder='Waiting for asset tag‚Ä¶';
  document.getElementById('scanLog').innerHTML='<div class="log-entry" style="color:var(--muted);padding:4px 6px;">Switched pallet ‚Äî awaiting scan‚Ä¶</div>';
  if(currentMode==='scan'){renderPresetBar();if(activePresetId)document.getElementById('assetInput').focus();}
  else{updateOcrActiveInfo();if(ocrTopPanelOpen)renderOcrInlinePallets();}
  renderOcrPairsList();
}
function rebuildGlobalSets(){globalAssetTags=new Set();globalSerials=new Set();[...pallets,damagedPallet].forEach(p=>p.entries.forEach(e=>{if(e.type==='pair'||e.type==='ocr'){if(e.asset&&e.asset!==SKIP)globalAssetTags.add(e.asset);if(e.serial&&e.serial!==SKIP)globalSerials.add(e.serial);}}));}
function deletePallet(id){
  const pallet=pallets.find(p=>p.id===id);if(!pallet)return;
  if(!confirm('Delete this pallet and all its entries?'))return;
  // Send pallet entries to bin
  pallet.entries.forEach(e=>{
    const desc=e.type==='pair'||e.type==='ocr'?`${e.type==='ocr'?'OCR Pair':'Scan Pair'}: AT ${e.asset} ‚Üí SN ${e.serial}`:`Manual: ${e.qty}√ó ${e.description}`;
    recycleBin.push({id:'bin_'+Date.now()+'_'+Math.random().toString(36).slice(2),type:'entry',deletedAt:Date.now(),description:`[Pallet "${pallet.name}"] ${desc}`,data:{entry:JSON.parse(JSON.stringify(e)),palletId:id},linkedImageIds:e.imageIds||[]});
  });
  pallets=pallets.filter(p=>p.id!==id);rebuildGlobalSets();
  if(activePalletId===id){activePalletId=null;document.getElementById('palletWorkspace').style.display='none';document.getElementById('noPalletScreen').style.display='flex';}
  renderPalletList();updateTiles();updateBinBadge();if(ocrTopPanelOpen)renderOcrInlinePallets();scheduleSave();
}
function renderPalletList(){
  const list=document.getElementById('palletsList');
  if(pallets.length===0){list.innerHTML='<div style="color:var(--muted);font-size:.66rem;padding:4px 8px;font-family:Share Tech Mono,monospace;">No pallets yet</div>';return;}
  list.innerHTML=pallets.map(p=>{const cnt=p.entries.filter(e=>e.type==='pair'||e.type==='ocr').length;return `<div class="pallet-item${p.id===activePalletId?' active':''}" onclick="selectPallet('${p.id}')"><div class="pallet-dot"></div><span class="pallet-name">${escHtml(p.name)}</span><span class="pallet-count">${cnt}</span><button class="pallet-del" onclick="event.stopPropagation();deletePallet('${p.id}')" title="Delete">‚úï</button></div>`;}).join('');
}
function renderDamagedPalletList(){
  const list=document.getElementById('damagedPalletList');const cnt=damagedPallet.entries.filter(e=>e.type==='pair'||e.type==='ocr').length;const isActive=activePalletId===DAMAGED_PALLET_ID;
  list.innerHTML=`<div class="pallet-item damaged-pallet-item${isActive?' active':''}" onclick="selectPallet('${DAMAGED_PALLET_ID}')"><div class="pallet-dot"></div><span class="pallet-name">Damaged</span><span class="pallet-count" style="${isActive?'background:rgba(255,45,85,.15);color:var(--danger);':''}">${cnt}</span></div>`;
}
function updateHeaderStats(){
  const p=getActivePallet();if(!p)return;
  document.getElementById('headerPalletName').textContent=p.name.toUpperCase();
  const pairs=p.entries.filter(e=>e.type==='pair').length;const ocr=p.entries.filter(e=>e.type==='ocr').length;const manual=p.entries.filter(e=>e.type==='manual').length;
  document.getElementById('headerStats').textContent=`${pairs} SCAN ¬∑ ${ocr} OCR ¬∑ ${manual} MANUAL`;
}
function clearCurrentPallet(){
  const p=getActivePallet();if(!p||p.entries.length===0)return;if(!confirm(`Clear all entries from "${p.name}"?`))return;
  // Send all to bin
  p.entries.forEach(e=>{
    const desc=e.type==='pair'||e.type==='ocr'?`${e.type==='ocr'?'OCR Pair':'Scan Pair'}: AT ${e.asset} ‚Üí SN ${e.serial}`:`Manual: ${e.qty}√ó ${e.description}`;
    recycleBin.push({id:'bin_'+Date.now()+'_'+Math.random().toString(36).slice(2),type:'entry',deletedAt:Date.now(),description:`[Cleared from "${p.name}"] ${desc}`,data:{entry:JSON.parse(JSON.stringify(e)),palletId:p.id},linkedImageIds:e.imageIds||[]});
  });
  p.entries=[];rebuildGlobalSets();assetPending=null;dupeCount=0;errorCount=0;_lastOverweightAlerted=false;
  document.getElementById('assetInput').value='';document.getElementById('serialInput').value='';
  document.getElementById('assetInput').className='scan-input active-field';document.getElementById('serialInput').className='scan-input';document.getElementById('serialInput').placeholder='Waiting for asset tag‚Ä¶';
  document.getElementById('weightWarnBanner').classList.remove('visible');
  setStatus('ready','Ready ‚Äî pallet cleared');renderEntries();updateStats();updateHeaderStats();updateTiles();renderOcrPairsList();updateBinBadge();scheduleSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRESETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onMfrChange(){const mfr=document.getElementById('pm_mfr').value.trim().toLowerCase();document.getElementById('dellSerialSection').style.display=mfr==='dell'?'block':'none';}
function updateDellLink(){const s=document.getElementById('dellSerialInput').value.trim();const l=document.getElementById('dellSupportLink');if(s){l.href=`https://www.dell.com/support/product-details/en-us/servicetag/${encodeURIComponent(s)}/overview`;l.classList.remove('hidden');}else l.classList.add('hidden');}
function toggleStorageField(){const n=document.getElementById('pm_no_storage').checked;document.getElementById('storageFieldGroup').style.opacity=n?'.35':'1';document.getElementById('pm_storage').disabled=n;}
function clearWeightNag(){document.getElementById('weightHint').className='form-hint';document.getElementById('weightHint').textContent='Helps calculate shipping weight';document.getElementById('pm_weight').classList.remove('wb');document.getElementById('pm_weight').removeAttribute('data-nagged');}
let editingPresetId=null;
function openEditPresetModal(id){
  const p=presets.find(pr=>pr.id===id);if(!p)return;editingPresetId=id;
  document.getElementById('pm_name').value=p.name||'';document.getElementById('pm_mfr').value=p.mfr||'';document.getElementById('pm_cpu').value=p.cpu||'';document.getElementById('pm_ram').value=p.ram||'';document.getElementById('pm_storage').value=p.storage||'';document.getElementById('pm_weight').value=p.weight||'';document.getElementById('pm_no_storage').checked=!!p.noStorage;
  toggleStorageField();onMfrChange();clearWeightNag();document.getElementById('dellSerialInput').value='';document.getElementById('dellSupportLink').classList.add('hidden');
  document.getElementById('presetModal').classList.add('open');document.getElementById('presetModalTitle').textContent='‚ñ∏ Edit Preset';setTimeout(()=>document.getElementById('pm_name').focus(),50);
}
function openPresetModal(){
  ['pm_name','pm_mfr','pm_cpu'].forEach(id=>document.getElementById(id).value='');document.getElementById('pm_ram').value='';document.getElementById('pm_storage').value='';document.getElementById('pm_weight').value='';document.getElementById('pm_no_storage').checked=false;document.getElementById('storageFieldGroup').style.opacity='1';document.getElementById('pm_storage').disabled=false;clearWeightNag();document.getElementById('dellSerialSection').style.display='none';document.getElementById('dellSerialInput').value='';document.getElementById('dellSupportLink').classList.add('hidden');editingPresetId=null;document.getElementById('presetModal').classList.add('open');document.getElementById('presetModalTitle').textContent='‚ñ∏ Define Model Preset';setTimeout(()=>document.getElementById('pm_name').focus(),50);
}
function closePresetModal(){editingPresetId=null;document.getElementById('presetModal').classList.remove('open');}
function savePreset(){
  const name=document.getElementById('pm_name').value.trim();if(!name){document.getElementById('pm_name').focus();return;}
  const noStorage=document.getElementById('pm_no_storage').checked;const wtRaw=document.getElementById('pm_weight').value.trim();const weight=wtRaw?parseFloat(wtRaw):null;
  if(!wtRaw&&!document.getElementById('pm_weight').getAttribute('data-nagged')){document.getElementById('weightHint').className='form-hint wh';document.getElementById('weightHint').textContent='‚ö† No weight ‚Äî click Save again to proceed.';document.getElementById('pm_weight').classList.add('wb');document.getElementById('pm_weight').setAttribute('data-nagged','1');return;}
  const data={name,mfr:document.getElementById('pm_mfr').value.trim(),cpu:document.getElementById('pm_cpu').value.trim(),ram:document.getElementById('pm_ram').value.trim(),storage:noStorage?'':document.getElementById('pm_storage').value.trim(),noStorage,weight};
  if(editingPresetId){const idx=presets.findIndex(p=>p.id===editingPresetId);if(idx!==-1)presets[idx]={...presets[idx],...data};closePresetModal();renderPresetList();renderPresetBar();updateOcrActiveInfo();if(ocrTopPanelOpen)renderOcrInlinePresets();scheduleSave();}
  else{const preset={id:'pr_'+Date.now(),...data};presets.push(preset);activePresetId=preset.id;storageLogDefault=!noStorage;closePresetModal();renderPresetList();renderPresetBar();updateOcrActiveInfo();if(ocrTopPanelOpen)renderOcrInlinePresets();scheduleSave();}
}
function selectPreset(id){activePresetId=id;storageLogDefault=true;renderPresetList();renderPresetBar();updateOcrActiveInfo();if(ocrTopPanelOpen)renderOcrInlinePresets();const ai=document.getElementById('assetInput');if(ai&&!ai.disabled&&currentMode==='scan')setTimeout(()=>ai.focus(),50);}
function clearActivePreset(){activePresetId=null;renderPresetList();renderPresetBar();updateOcrActiveInfo();if(ocrTopPanelOpen)renderOcrInlinePresets();}
function deletePreset(id){if(!confirm('Delete this preset?'))return;presets=presets.filter(p=>p.id!==id);if(activePresetId===id){activePresetId=null;renderPresetBar();updateOcrActiveInfo();}renderPresetList();if(ocrTopPanelOpen)renderOcrInlinePresets();scheduleSave();}
function renderPresetList(){
  const list=document.getElementById('presetsList');const q=(document.getElementById('presetSearch').value||'').toLowerCase().trim();const all=getAllPresets();const filtered=q?all.filter(p=>p.name.toLowerCase().includes(q)||(p.mfr&&p.mfr.toLowerCase().includes(q))):all;
  if(filtered.length===0){list.innerHTML=`<div style="color:var(--muted);font-size:.66rem;padding:4px 8px;font-family:Share Tech Mono,monospace;">${q?'No matches':'No presets yet'}</div>`;return;}
  list.innerHTML=filtered.map(p=>{const isBuiltin=p.isDamaged;const noW=!isBuiltin&&!p.weight;return `<div class="preset-item${p.id===activePresetId?' active':''}${p.isDamaged?' damaged-preset':''}" onclick="selectPreset('${p.id}')"><span class="preset-name">${escHtml(p.name)}</span>${noW?'<span class="no-weight-warn" title="No weight set">‚ö†</span>':''}${!isBuiltin?`<button class="edit-btn" onclick="event.stopPropagation();openEditPresetModal('${p.id}')" title="Edit">‚úé</button><button class="del-btn" onclick="event.stopPropagation();deletePreset('${p.id}')" title="Delete">‚úï</button>`:''}</div>`;}).join('');
}
function exportPresets(){if(presets.length===0){alert('No custom presets to export.');return;}download('AssetPresets_'+new Date().toISOString().slice(0,10)+'.json',JSON.stringify(presets,null,2),'application/json');}
function importPresets(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){try{const imp=JSON.parse(e.target.result);if(!Array.isArray(imp))throw new Error('Expected JSON array');let added=0;imp.forEach(p=>{if(p.name){p.id='pr_'+Date.now()+'_'+Math.random().toString(36).slice(2);presets.push(p);added++;}});alert(`Imported ${added} preset${added!==1?'s':''}.`);renderPresetList();if(ocrTopPanelOpen)renderOcrInlinePresets();scheduleSave();}catch(err){alert('Import failed: '+err.message);}};reader.readAsText(file);event.target.value='';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  XLSX EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSheetJS(cb){if(window.XLSX){cb();return;}const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';s.onload=cb;s.onerror=()=>alert('Could not load SheetJS. Check internet connection.');document.head.appendChild(s);}
function fmtDate(){const d=new Date();return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}-${d.getFullYear()}`;}
function exportAllXLSX(){
  if(pallets.length===0&&damagedPallet.entries.length===0){alert('No data to export.');return;}
  loadSheetJS(()=>{
    const wb=XLSX.utils.book_new();
    pallets.forEach(pallet=>{
      const rows=[['Asset Tag','Serial Number','Manufacturer','Model','CPU','RAM','Storage','Source']];
      pallet.entries.forEach(e=>{
        const preset=getAllPresets().find(p=>p.id===e.presetId);
        if(e.type==='pair'||e.type==='ocr'){
          const mfr=preset?.mfr||'',model=preset?.name||'',cpu=preset?.cpu||'',ram=preset?.ram?preset.ram+' GB':'';
          let storage='';if(preset)storage=(preset.noStorage||e.storageNone)?'None':(preset.storage?preset.storage+' GB':'');
          rows.push([e.asset,e.serial,mfr,model,cpu,ram,storage,e.type==='ocr'?'OCR':'SCAN']);
        }
      });
      pallet.entries.filter(e=>e.type==='manual').forEach(e=>{rows.push([`${e.qty} x ${e.description}`,'','','','','','','MANUAL']);});
      const ws=XLSX.utils.aoa_to_sheet(rows);ws['!cols']=[{wch:12},{wch:12},{wch:16},{wch:24},{wch:14},{wch:8},{wch:10},{wch:7}];
      XLSX.utils.book_append_sheet(wb,ws,pallet.name.substring(0,31).replace(/[\\/?*[\]]/g,''));
    });
    if(damagedPallet.entries.length>0){
      const rows=[['Asset Tag','Serial Number','Source']];
      damagedPallet.entries.forEach(e=>{if(e.type==='pair'||e.type==='ocr')rows.push([e.asset,e.serial,e.type==='ocr'?'OCR':'SCAN']);});
      damagedPallet.entries.filter(e=>e.type==='manual').forEach(e=>{rows.push([`${e.qty} x ${e.description}`,'','MANUAL']);});
      const ws=XLSX.utils.aoa_to_sheet(rows);ws['!cols']=[{wch:12},{wch:12},{wch:7}];XLSX.utils.book_append_sheet(wb,ws,'Damaged');
    }
    {
      const rows=[['Pallet','Est. Total Weight (lbs)','Notes']];let grandTotal=0;
      pallets.forEach(pallet=>{const{total,missing}=calcPalletWeight(pallet);rows.push([pallet.name,parseFloat(total.toFixed(1)),missing>0?`${missing} items missing weight`:'']);grandTotal+=total;});
      rows.push(['']);rows.push(['TOTAL SHIPMENT WEIGHT',parseFloat(grandTotal.toFixed(1)),'']);rows.push(['']);rows.push(['Note: Each pallet weight includes 50 lb pallet hardware. Damaged assets excluded.']);
      const ws=XLSX.utils.aoa_to_sheet(rows);ws['!cols']=[{wch:24},{wch:24},{wch:32}];XLSX.utils.book_append_sheet(wb,ws,'Weight Summary');
    }
    XLSX.writeFile(wb,`Assets_Pending_Sale_${fmtDate()}.xlsx`);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OCR ZIP EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function exportOcrZip(){
  const allOcr=[...pallets,damagedPallet].flatMap(p=>p.entries.filter(e=>e.type==='ocr'));
  if(allOcr.length===0){alert('No OCR pairs to export yet.');return;}
  const zip=new JSZip();
  const now=new Date();const pad=n=>String(n).padStart(2,'0');
  const ts=`${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
  const rootName=`OCR_Export_${ts}`;const root=zip.folder(rootName);
  const allCsvRows=[['Pallet','Asset Tag','Serial Number','Preset','Folder','Images']];

  const palletList=[...pallets.map(p=>({pallet:p,isDamaged:false})),{pallet:damagedPallet,isDamaged:true}];
  for(const{pallet,isDamaged}of palletList){
    const ocrEntries=pallet.entries.filter(e=>e.type==='ocr');if(!ocrEntries.length)continue;
    const safePalletName=pallet.name.replace(/[\\/?*:<>"|]/g,'_');
    const palletFolder=root.folder(safePalletName);
    const palletCsvRows=[['Asset Tag','Serial Number','Preset','Images']];
    for(const entry of ocrEntries){
      const preset=getAllPresets().find(p=>p.id===entry.presetId);
      const folderName=`${entry.serial}_${entry.asset}`;
      const entryFolder=palletFolder.folder(folderName);
      let imgCount=0;
      for(const imgId of(entry.imageIds||[])){
        const img=ocrImages.find(i=>i.id===imgId);if(!img)continue;
        imgCount++;const ext=img.name.toLowerCase().endsWith('.heic')?'jpg':(img.name.split('.').pop()||'jpg');
        entryFolder.file(`img_${String(imgCount).padStart(3,'0')}.${ext}`,img.blob);
      }
      palletCsvRows.push([entry.asset,entry.serial,preset?.name||'',String(imgCount)]);
      allCsvRows.push([pallet.name,entry.asset,entry.serial,preset?.name||'',`${rootName}/${safePalletName}/${folderName}`,String(imgCount)]);
    }
    palletFolder.file('pallet_results.csv',palletCsvRows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n'));
  }
  root.file('all_results.csv',allCsvRows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n'));
  const blob=await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:4}});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`${rootName}.zip`;a.click();setTimeout(()=>URL.revokeObjectURL(url),5000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HTML VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openHtmlView(){if(pallets.length===0&&damagedPallet.entries.length===0){alert('No data to view.');return;}document.getElementById('htmlViewContent').innerHTML=buildHtmlView();document.getElementById('htmlViewModal').classList.add('open');}
function closeHtmlView(){document.getElementById('htmlViewModal').classList.remove('open');}
function buildHtmlView(){
  const ts=new Date().toLocaleString();let shipT=0,shipM=0;pallets.forEach(p=>{const w=calcPalletWeight(p);shipT+=w.total;shipM+=w.missing;});
  const totalPairs=pallets.reduce((a,p)=>a+p.entries.filter(e=>e.type==='pair'||e.type==='ocr').length,0);
  const dmgPairs=damagedPallet.entries.filter(e=>e.type==='pair'||e.type==='ocr').length;
  let html=`<div style="font-family:monospace;font-size:.76rem;"><div style="color:#00e5ff;font-size:.9rem;letter-spacing:3px;margin-bottom:3px;">ASSET SALE EXPORT</div><div style="color:#4a5568;margin-bottom:9px;font-size:.64rem;">${ts}</div>
  <div style="display:flex;gap:16px;flex-wrap:wrap;border:1px solid #1c2432;border-radius:7px;padding:9px 13px;background:#0d1117;margin-bottom:14px;">
    <div><div style="color:#4a5568;font-size:.56rem;letter-spacing:2px;text-transform:uppercase;">For Sale</div><div style="color:#39ff14;font-size:1.2rem;">${totalPairs}</div></div>
    <div><div style="color:#4a5568;font-size:.56rem;letter-spacing:2px;text-transform:uppercase;">Pallets</div><div style="color:#00e5ff;font-size:1.2rem;">${pallets.length}</div></div>
    <div><div style="color:#4a5568;font-size:.56rem;letter-spacing:2px;text-transform:uppercase;">Est. Shipment Weight</div><div style="color:#ffb347;font-size:1.2rem;">${shipT.toFixed(1)} lbs${shipM>0?` <span style="font-size:.58rem;color:#ff6b35;">‚ö† ${shipM} missing</span>`:''}</div></div>
    <div><div style="color:#4a5568;font-size:.56rem;letter-spacing:2px;text-transform:uppercase;">Damaged</div><div style="color:#ff2d55;font-size:1.2rem;">${dmgPairs}</div></div>
  </div>`;
  pallets.forEach(pallet=>{
    const pairs=pallet.entries.filter(e=>e.type==='pair'||e.type==='ocr').length;const manual=pallet.entries.filter(e=>e.type==='manual').length;const pw=calcPalletWeight(pallet);
    html+=`<div style="border:1px solid #1c2432;border-radius:7px;margin-bottom:11px;overflow:hidden;"><div style="background:#141b24;padding:8px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;"><span style="color:#00e5ff;font-size:.83rem;letter-spacing:2px;">${escHtml(pallet.name)}</span><span style="color:#4a5568;font-size:.64rem;">${pairs} pairs ¬∑ ${manual} manual</span><span style="color:#ffb347;font-size:.64rem;margin-left:auto;">~${pw.total.toFixed(1)} lbs${pw.missing>0?' ‚ö† '+pw.missing+' missing':''}</span></div>`;
    if(pallet.entries.length===0)html+=`<div style="padding:13px;color:#4a5568;text-align:center;">‚Äî empty ‚Äî</div>`;
    else{
      html+=`<table style="width:100%;border-collapse:collapse;font-size:.7rem;"><thead><tr style="background:#0d1117;">${['#','Asset Tag','Serial','Preset','RAM','Storage','Src'].map(h=>`<th style="padding:6px 9px;text-align:left;color:#4a5568;border-bottom:1px solid #1c2432;">${h}</th>`).join('')}</tr></thead><tbody>`;
      pallet.entries.forEach((e,i)=>{
        const preset=getAllPresets().find(p=>p.id===e.presetId);const pName=preset?preset.name:'‚Äî';let storageTxt='‚Äî';if(preset)storageTxt=(preset.noStorage||e.storageNone)?'None':(preset.storage?preset.storage+' GB':'‚Äî');const ram=preset?.ram?preset.ram+' GB':'‚Äî';
        if(e.type==='pair'||e.type==='ocr'){
          // Consistent colors: asset=e8ff00, serial=39ff14 for BOTH scan and ocr
          html+=`<tr style="border-bottom:1px solid rgba(28,36,50,.5);"><td style="padding:5px 9px;color:#4a5568;">${i+1}</td><td style="padding:5px 9px;color:#e8ff00;letter-spacing:2px;">${escHtml(e.asset)}</td><td style="padding:5px 9px;color:#39ff14;letter-spacing:2px;">${escHtml(e.serial)}</td><td style="padding:5px 9px;color:#a855f7;font-size:.64rem;">${escHtml(pName)}</td><td style="padding:5px 9px;color:#c8d6e5;">${escHtml(ram)}</td><td style="padding:5px 9px;color:#c8d6e5;">${escHtml(storageTxt)}</td><td style="padding:5px 9px;color:${e.type==='ocr'?'#e8ff00':'#00e5ff'};font-size:.6rem;">${e.type==='ocr'?'OCR':'SCAN'}</td></tr>`;
        }
        else{html+=`<tr style="border-bottom:1px solid rgba(28,36,50,.5);"><td style="padding:5px 9px;color:#4a5568;">${i+1}</td><td style="padding:5px 9px;color:#a855f7;" colspan="6">${escHtml(e.description)} √ó${e.qty}</td></tr>`;}
      });
      html+=`</tbody></table>`;
    }
    html+=`</div>`;
  });
  if(damagedPallet.entries.length>0){
    const dp=damagedPallet;const pairs=dp.entries.filter(e=>e.type==='pair'||e.type==='ocr').length;
    html+=`<div style="border:1px solid rgba(255,45,85,.25);border-radius:7px;margin-bottom:11px;overflow:hidden;"><div style="background:rgba(255,45,85,.07);padding:8px 12px;display:flex;align-items:center;gap:10px;"><span style="color:#ff2d55;font-size:.83rem;letter-spacing:2px;">‚ö† DAMAGED</span><span style="color:#4a5568;font-size:.64rem;">${pairs} assets</span></div><table style="width:100%;border-collapse:collapse;font-size:.7rem;"><thead><tr style="background:#0d1117;"><th style="padding:6px 9px;text-align:left;color:#4a5568;border-bottom:1px solid #1c2432;">#</th><th style="padding:6px 9px;text-align:left;color:#4a5568;border-bottom:1px solid #1c2432;">Asset Tag</th><th style="padding:6px 9px;text-align:left;color:#4a5568;border-bottom:1px solid #1c2432;">Serial</th><th style="padding:6px 9px;text-align:left;color:#4a5568;border-bottom:1px solid #1c2432;">Src</th></tr></thead><tbody>`;
    dp.entries.forEach((e,i)=>{if(e.type==='pair'||e.type==='ocr')html+=`<tr style="border-bottom:1px solid rgba(28,36,50,.5);"><td style="padding:5px 9px;color:#4a5568;">${i+1}</td><td style="padding:5px 9px;color:#ff2d55;letter-spacing:2px;">${escHtml(e.asset)}</td><td style="padding:5px 9px;color:#ff2d55;letter-spacing:2px;">${escHtml(e.serial)}</td><td style="padding:5px 9px;color:${e.type==='ocr'?'#e8ff00':'#4a5568'};font-size:.6rem;">${e.type==='ocr'?'OCR':'SCAN'}</td></tr>`;});
    html+=`</tbody></table></div>`;
  }
  html+=`<div style="border:1px solid #1c2432;border-radius:7px;overflow:hidden;"><div style="background:#141b24;padding:8px 12px;"><span style="color:#ffb347;font-size:.83rem;letter-spacing:2px;">WEIGHT SUMMARY</span></div><table style="width:100%;border-collapse:collapse;font-size:.7rem;"><thead><tr style="background:#0d1117;">${['Pallet','Asset Weight','+ Pallet HW','= Total Est.','Missing'].map(h=>`<th style="padding:6px 9px;text-align:left;color:#4a5568;border-bottom:1px solid #1c2432;">${h}</th>`).join('')}</tr></thead><tbody>`;
  let gTotal=0;pallets.forEach(p=>{const{total,missing}=calcPalletWeight(p);gTotal+=total;html+=`<tr style="border-bottom:1px solid rgba(28,36,50,.5);"><td style="padding:5px 9px;color:#00e5ff;">${escHtml(p.name)}</td><td style="padding:5px 9px;color:#c8d6e5;">${(total-PALLET_WEIGHT).toFixed(1)} lbs</td><td style="padding:5px 9px;color:#4a5568;">+${PALLET_WEIGHT} lbs</td><td style="padding:5px 9px;color:#ffb347;">${total.toFixed(1)} lbs</td><td style="padding:5px 9px;color:${missing>0?'#ff6b35':'#4a5568'};">${missing>0?missing+' items':'‚Äî'}</td></tr>`;});
  html+=`<tr style="background:#141b24;"><td style="padding:6px 9px;color:#ffb347;font-weight:bold;">TOTAL</td><td colspan="2" style="padding:6px 9px;"></td><td style="padding:6px 9px;color:#ffb347;font-weight:bold;">${gTotal.toFixed(1)} lbs</td><td></td></tr></tbody></table></div></div>`;
  return html;
}
function printHtmlView(){const c=document.getElementById('htmlViewContent').innerHTML;const w=window.open('','_blank');w.document.write(`<!DOCTYPE html><html><head><title>Asset Sale Export</title><style>body{background:#080b0f;color:#c8d6e5;font-family:monospace;padding:20px;}@media print{body{background:#fff;color:#000;}}</style></head><body>${c}</body></html>`);w.document.close();w.print();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SESSION (cookies for lister data)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SESSION_COOKIE='assetListerSession';const COOKIE_MAX_AGE=400*24*60*60;
function saveSession(){
  try{
    const data={pallets,presets,damagedPallet,activePalletId,activePresetId,recycleBin:recycleBin.slice(-100),savedAt:Date.now()};
    const json=JSON.stringify(data);const encoded=encodeURIComponent(json);
    if(encoded.length<3900){document.cookie=SESSION_COOKIE+'='+encoded+';max-age='+COOKIE_MAX_AGE+';path=/;SameSite=Lax';for(let i=0;i<10;i++)document.cookie=SESSION_COOKIE+'_'+i+'=;max-age=0;path=/';}
    else{try{localStorage.setItem(SESSION_COOKIE,json);document.cookie=SESSION_COOKIE+'=__ls__;max-age='+COOKIE_MAX_AGE+';path=/;SameSite=Lax';}catch(e){const chunks=[];for(let i=0;i<encoded.length;i+=3800)chunks.push(encoded.slice(i,i+3800));document.cookie=SESSION_COOKIE+'=__chunks_'+chunks.length+'___;max-age='+COOKIE_MAX_AGE+';path=/;SameSite=Lax';chunks.forEach((c,i)=>{document.cookie=SESSION_COOKIE+'_'+i+'='+c+';max-age='+COOKIE_MAX_AGE+';path=/;SameSite=Lax';});}}
    updateSessionStatus(data.savedAt);
  }catch(e){console.warn('Session save failed:',e);}
}
function getCookieVal(name){const m=document.cookie.split('; ').find(r=>r.startsWith(name+'='));return m?decodeURIComponent(m.split('=').slice(1).join('=')):null;}
function loadSession(){
  try{
    const val=getCookieVal(SESSION_COOKIE);if(!val)return false;
    let json=null;
    if(val==='__ls__')json=localStorage.getItem(SESSION_COOKIE);
    else if(val.startsWith('__chunks_')){const count=parseInt(val.match(/__chunks_(\d+)___/)[1]);let combined='';for(let i=0;i<count;i++){const c=getCookieVal(SESSION_COOKIE+'_'+i);if(!c)return false;combined+=c;}json=decodeURIComponent(combined);}
    else json=val;
    if(!json)return false;
    const data=JSON.parse(json);
    if(data.pallets)pallets=data.pallets;if(data.presets)presets=data.presets;if(data.damagedPallet)damagedPallet=data.damagedPallet;if(data.recycleBin)recycleBin=data.recycleBin;
    globalAssetTags=new Set();globalSerials=new Set();
    [...pallets,damagedPallet].forEach(p=>p.entries.forEach(e=>{if(e.type==='pair'||e.type==='ocr'){if(e.asset&&e.asset!==SKIP)globalAssetTags.add(e.asset);if(e.serial&&e.serial!==SKIP)globalSerials.add(e.serial);}}));
    renderPalletList();renderDamagedPalletList();renderPresetList();renderPresetBar();updateBinBadge();updateTiles();
    if(data.activePalletId){const p=data.activePalletId===DAMAGED_PALLET_ID?damagedPallet:pallets.find(x=>x.id===data.activePalletId);if(p)selectPallet(data.activePalletId);}
    if(data.activePresetId&&getAllPresets().find(x=>x.id===data.activePresetId)){activePresetId=data.activePresetId;renderPresetBar();}
    updateSessionStatus(data.savedAt);return true;
  }catch(e){console.warn('Session load failed:',e);return false;}
}
function clearSession(){
  if(!confirm('Clear session? All pallets, entries, presets, OCR images, and bin will be erased.'))return;
  document.cookie=SESSION_COOKIE+'=;max-age=0;path=/';for(let i=0;i<10;i++)document.cookie=SESSION_COOKIE+'_'+i+'=;max-age=0;path=/';
  try{localStorage.removeItem(SESSION_COOKIE);}catch(e){}
  if(db){dbClear('images').catch(()=>{});dbClear('session').catch(()=>{});}
  pallets=[];presets=[];damagedPallet={id:DAMAGED_PALLET_ID,name:'Damaged',entries:[],isDamaged:true};recycleBin=[];
  activePalletId=null;activePresetId=null;globalAssetTags=new Set();globalSerials=new Set();
  dupeCount=0;errorCount=0;assetPending=null;ocrImageHashes=new Set();
  ocrImages=[];ocrActiveId=null;ocrQueue=[];
  document.getElementById('ocrThumbList').innerHTML='';document.getElementById('ocrDropZone').classList.remove('hidden');ocrCanvas.style.display='none';
  renderPalletList();renderDamagedPalletList();renderPresetList();renderPresetBar();updateTiles();updateSessionStatus();updateBinBadge();
  document.getElementById('noPalletScreen').style.display='flex';document.getElementById('palletWorkspace').style.display='none';
}
function updateSessionStatus(savedAt){const el=document.getElementById('sessionStatus');if(!el)return;if(!savedAt){el.textContent='No saved session';el.style.color='var(--muted)';return;}const d=new Date(savedAt);const t=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const isToday=d.toDateString()===new Date().toDateString();el.textContent='Saved '+(isToday?'today':'on '+d.toLocaleDateString())+' '+t;el.style.color='var(--accent2)';}
let _saveTimer=null;
function scheduleSave(){clearTimeout(_saveTimer);_saveTimer=setTimeout(saveSession,800);}
function download(filename,content,type){const blob=new Blob([content],{type});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();URL.revokeObjectURL(a.href);}

window.addEventListener('resize',()=>{if(ocrActiveId&&currentMode==='ocr')setTimeout(renderOcrCanvas,50);});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if(!loadSession()){renderPalletList();renderDamagedPalletList();renderPresetList();renderPresetBar();updateTiles();updateSessionStatus();updateBinBadge();}
initOcr();
</script>
</body>
</html>
