<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SysInfo Diff</title>
<link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400;500;600;700&family=Geist:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080b10;
  --bg2:#0d1117;
  --surface:#111720;
  --surface2:#161d28;
  --border:#1e2a3a;
  --border2:#243040;
  --a-color:#38bdf8;
  --b-color:#f472b6;
  --added:#22c55e;
  --removed:#ef4444;
  --changed:#f59e0b;
  --match:#334155;
  --text:#e2e8f0;
  --muted:#4a5568;
  --muted2:#64748b;
  --mono:'Geist Mono',monospace;
  --sans:'Geist',sans-serif;
}

body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden}

/* â”€â”€ Drop Zone â”€â”€ */
#dropScreen{
  min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:0;padding:40px 20px;
  background:radial-gradient(ellipse 80% 60% at 50% 0%, rgba(56,189,248,.06) 0%, transparent 70%),
             radial-gradient(ellipse 60% 40% at 80% 100%, rgba(244,114,182,.04) 0%, transparent 60%),
             var(--bg);
}
.drop-title{font-family:var(--mono);font-size:clamp(18px,3vw,28px);font-weight:700;color:#fff;letter-spacing:-1px;margin-bottom:6px}
.drop-title .slash{color:var(--a-color)}
.drop-subtitle{font-family:var(--mono);font-size:12px;color:var(--muted2);margin-bottom:48px;letter-spacing:.5px}

.drop-grid{display:grid;grid-template-columns:1fr auto 1fr;gap:0;align-items:center;width:100%;max-width:780px}
.drop-zone{
  border:1.5px dashed var(--border2);border-radius:12px;
  padding:36px 24px;text-align:center;cursor:pointer;
  transition:all .2s;background:var(--surface);
  display:flex;flex-direction:column;align-items:center;gap:12px;
  min-height:180px;justify-content:center;
}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--a-color);background:rgba(56,189,248,.04)}
.drop-zone.b:hover,.drop-zone.b.drag-over{border-color:var(--b-color);background:rgba(244,114,182,.04)}
.drop-zone.loaded{border-style:solid}
.drop-zone.a.loaded{border-color:var(--a-color)}
.drop-zone.b.loaded{border-color:var(--b-color)}

.drop-icon{font-size:32px;opacity:.5}
.drop-label{font-family:var(--mono);font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase}
.drop-zone.a .drop-label{color:var(--a-color)}
.drop-zone.b .drop-label{color:var(--b-color)}
.drop-hint{font-size:12px;color:var(--muted2)}
.drop-filename{font-family:var(--mono);font-size:11px;margin-top:4px;word-break:break-all}
.drop-zone.a .drop-filename{color:var(--a-color)}
.drop-zone.b .drop-filename{color:var(--b-color)}

.vs-divider{display:flex;align-items:center;justify-content:center;padding:0 20px}
.vs-text{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--border2);letter-spacing:2px}

.compare-btn{
  margin-top:36px;font-family:var(--mono);font-size:13px;font-weight:600;
  padding:12px 40px;border-radius:8px;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--a-color),var(--b-color));
  color:#000;letter-spacing:.5px;transition:all .2s;opacity:.4;pointer-events:none;
}
.compare-btn.ready{opacity:1;pointer-events:all}
.compare-btn.ready:hover{transform:translateY(-1px);box-shadow:0 8px 30px rgba(56,189,248,.25)}

input[type=file]{display:none}

/* â”€â”€ Results Screen â”€â”€ */
#resultScreen{display:none;min-height:100vh;flex-direction:column}

.result-header{
  padding:20px 32px;border-bottom:1px solid var(--border);
  display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;
  background:var(--bg2);position:sticky;top:0;z-index:20;
}
.machine-label{font-family:var(--mono);font-size:11px;font-weight:600;letter-spacing:1px}
.machine-label.a{color:var(--a-color)}
.machine-label.b{color:var(--b-color)}
.machine-name{font-size:15px;font-weight:600;color:#fff;margin-top:2px}
.machine-os{font-family:var(--mono);font-size:10px;color:var(--muted2);margin-top:3px}

.summary-pills{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.pill{font-family:var(--mono);font-size:10px;font-weight:700;padding:4px 10px;border-radius:20px;white-space:nowrap}
.pill-changed{background:rgba(245,158,11,.15);color:var(--changed);border:1px solid rgba(245,158,11,.3)}
.pill-added  {background:rgba(34,197,94,.12); color:var(--added); border:1px solid rgba(34,197,94,.25)}
.pill-removed{background:rgba(239,68,68,.12); color:var(--removed);border:1px solid rgba(239,68,68,.25)}
.pill-match  {background:rgba(51,65,85,.4);   color:var(--muted2); border:1px solid var(--border)}

.reset-btn{
  font-family:var(--mono);font-size:10px;font-weight:600;padding:6px 14px;
  border-radius:6px;border:1px solid var(--border2);background:transparent;
  color:var(--muted2);cursor:pointer;transition:all .15s;justify-self:end;
}
.reset-btn:hover{border-color:var(--text);color:var(--text)}

/* â”€â”€ Tabs â”€â”€ */
.result-tabs{display:flex;padding:0 32px;border-bottom:1px solid var(--border);background:var(--bg2)}
.rtab{
  font-family:var(--mono);font-size:11px;font-weight:600;padding:13px 18px;
  background:none;border:none;border-bottom:2px solid transparent;
  color:var(--muted2);cursor:pointer;transition:all .15s;white-space:nowrap;
  display:flex;align-items:center;gap:7px;
}
.rtab:hover{color:var(--text)}
.rtab.active{color:#fff;border-bottom-color:#fff}
.rtab-count{
  font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;
  background:var(--surface2);color:var(--muted2);
}
.rtab.active .rtab-count{background:rgba(255,255,255,.12);color:#fff}
.rtab-count.has-diff{background:rgba(245,158,11,.2);color:var(--changed)}

/* â”€â”€ Content â”€â”€ */
.result-content{flex:1;padding:28px 32px 60px}
.rsection{display:none}
.rsection.active{display:block}

/* â”€â”€ System Overview â”€â”€ */
.overview-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:32px}
.ov-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.ov-card-header{padding:10px 16px;font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;border-bottom:1px solid var(--border)}
.ov-card.a .ov-card-header{color:var(--a-color);background:rgba(56,189,248,.05)}
.ov-card.b .ov-card-header{color:var(--b-color);background:rgba(244,114,182,.05)}
.ov-fields{display:grid;grid-template-columns:130px 1fr}
.ov-label{padding:8px 14px;font-family:var(--mono);font-size:11px;color:var(--muted2);border-bottom:1px solid var(--border);border-right:1px solid var(--border)}
.ov-val  {padding:8px 14px;font-family:var(--mono);font-size:11px;color:var(--text); border-bottom:1px solid var(--border);word-break:break-word}
.ov-fields>div:nth-last-child(-n+2){border-bottom:none}
.ov-val.diff{color:var(--changed);font-weight:600}

/* â”€â”€ Diff table â”€â”€ */
.diff-controls{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.diff-search{
  background:var(--surface);border:1px solid var(--border2);color:var(--text);
  font-family:var(--mono);font-size:11px;padding:7px 12px;border-radius:6px;
  outline:none;width:280px;transition:border-color .15s;
}
.diff-search:focus{border-color:var(--a-color)}
.diff-search::placeholder{color:var(--muted)}
.diff-filter-btn{
  font-family:var(--mono);font-size:10px;font-weight:600;padding:6px 12px;
  border-radius:5px;border:1px solid var(--border2);background:transparent;
  color:var(--muted2);cursor:pointer;transition:all .15s;white-space:nowrap;
}
.diff-filter-btn:hover{color:var(--text);border-color:var(--text)}
.diff-filter-btn.active-changed{border-color:var(--changed);color:var(--changed);background:rgba(245,158,11,.08)}
.diff-filter-btn.active-added  {border-color:var(--added);  color:var(--added); background:rgba(34,197,94,.08)}
.diff-filter-btn.active-removed{border-color:var(--removed);color:var(--removed);background:rgba(239,68,68,.08)}
.diff-filter-btn.active-match  {border-color:var(--muted2); color:var(--muted2);background:rgba(100,116,139,.08)}
.diff-count{font-family:var(--mono);font-size:11px;color:var(--muted2);margin-left:auto}

.diff-table{width:100%;border-collapse:collapse;font-size:12px}
.diff-table thead th{
  font-family:var(--mono);font-size:10px;font-weight:600;text-transform:uppercase;
  letter-spacing:1px;padding:9px 12px;text-align:left;border-bottom:1px solid var(--border2);
  color:var(--muted2);white-space:nowrap;position:sticky;top:0;background:var(--bg);z-index:5;
}
.diff-table thead th.a{color:var(--a-color)}
.diff-table thead th.b{color:var(--b-color)}
.diff-table tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
.diff-table tbody tr:hover{background:var(--surface2)}
.diff-table td{padding:8px 12px;font-family:var(--mono);font-size:11px;vertical-align:middle}
.diff-table td.name-col{color:#fff;font-weight:500;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Row types */
tr.row-changed{background:rgba(245,158,11,.04)}
tr.row-added  {background:rgba(34,197,94,.04)}
tr.row-removed{background:rgba(239,68,68,.04)}
tr.row-match  {}

.badge-diff{font-family:var(--mono);font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;white-space:nowrap;display:inline-block}
.badge-changed{background:rgba(245,158,11,.15);color:var(--changed)}
.badge-added  {background:rgba(34,197,94,.12); color:var(--added)}
.badge-removed{background:rgba(239,68,68,.12); color:var(--removed)}
.badge-match  {background:rgba(51,65,85,.5);   color:var(--muted2)}

.val-a{color:var(--a-color)}
.val-b{color:var(--b-color)}
.val-missing{color:var(--muted);font-style:italic}
.val-match{color:var(--muted2)}

.no-diff-msg{text-align:center;padding:60px 0;font-family:var(--mono);font-size:13px;color:var(--muted2)}

/* â”€â”€ Loading overlay â”€â”€ */
#loadingOverlay{
  display:none;position:fixed;inset:0;background:rgba(8,11,16,.85);
  z-index:100;align-items:center;justify-content:center;flex-direction:column;gap:16px;
  backdrop-filter:blur(4px);
}
.spinner{width:32px;height:32px;border:2px solid var(--border2);border-top-color:var(--a-color);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:var(--mono);font-size:12px;color:var(--muted2)}
</style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Parsing SysInfo files...</div>
</div>

<!-- â”€â”€ Drop Screen â”€â”€ -->
<div id="dropScreen">
  <div class="drop-title">SysInfo<span class="slash">/</span>Diff</div>
  <div class="drop-subtitle">DROP TWO SYSINFOGRABBER HTML OR ZIP FILES TO COMPARE</div>

  <div class="drop-grid">
    <div class="drop-zone a" id="dropA" ondragover="onDragOver(event,'a')" ondragleave="onDragLeave('a')" ondrop="onDrop(event,'a')" onclick="document.getElementById('fileA').click()">
      <div class="drop-icon">ğŸ“„ğŸ“¦</div>
      <div class="drop-label">Machine A â€” Working</div>
      <div class="drop-hint" id="hintA">Drop HTML / ZIP or click to browse</div>
      <div class="drop-filename" id="filenameA"></div>
    </div>
    <input type="file" id="fileA" accept=".html,.zip" onchange="onFileSelect(event,'a')">

    <div class="vs-divider"><div class="vs-text">VS</div></div>

    <div class="drop-zone b" id="dropB" ondragover="onDragOver(event,'b')" ondragleave="onDragLeave('b')" ondrop="onDrop(event,'b')" onclick="document.getElementById('fileB').click()">
      <div class="drop-icon">ğŸ“„ğŸ“¦</div>
      <div class="drop-label">Machine B â€” Problem</div>
      <div class="drop-hint" id="hintB">Drop HTML / ZIP or click to browse</div>
      <div class="drop-filename" id="filenameB"></div>
    </div>
    <input type="file" id="fileB" accept=".html,.zip" onchange="onFileSelect(event,'b')">
  </div>

  <button class="compare-btn" id="compareBtn" onclick="runCompare()">Compare Machines â†’</button>
</div>

<!-- â”€â”€ Result Screen â”€â”€ -->
<div id="resultScreen">
  <div class="result-header">
    <div>
      <div class="machine-label a">MACHINE A â€” WORKING</div>
      <div class="machine-name" id="machineNameA">â€”</div>
      <div class="machine-os" id="machineOsA"></div>
    </div>
    <div class="summary-pills" id="summaryPills"></div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <button class="reset-btn" onclick="resetToDropScreen()">â† Load New HTML Files</button>
      <div style="text-align:right">
        <div class="machine-label b">MACHINE B â€” PROBLEM</div>
        <div class="machine-name" id="machineNameB">â€”</div>
        <div class="machine-os" id="machineOsB"></div>
      </div>
    </div>
  </div>

  <div class="result-tabs" id="resultTabs"></div>

  <div class="result-content">
    <!-- Overview -->
    <div class="rsection active" id="sec-overview">
      <div class="overview-grid" id="overviewGrid"></div>
    </div>
    <!-- Programs -->
    <div class="rsection" id="sec-programs">
      <div class="diff-controls">
        <input class="diff-search" placeholder="Search programs..." oninput="filterDiff('programs',this.value)" id="searchPrograms">
        <button class="diff-filter-btn" onclick="toggleFilter('programs','changed')">~ Diff Ver</button>
        <button class="diff-filter-btn" onclick="toggleFilter('programs','added')">ï¼‹ Only on B</button>
        <button class="diff-filter-btn" onclick="toggleFilter('programs','removed')">ï¼ Only on A</button>
        <button class="diff-filter-btn" onclick="toggleFilter('programs','match')">âœ“ Matching</button>
        <span class="diff-count" id="countPrograms"></span>
      </div>
      <table class="diff-table" id="tblPrograms">
        <thead><tr>
          <th>Status</th><th>Program Name</th>
          <th class="a">Version (A)</th><th class="b">Version (B)</th>
          <th class="a">Installed (A)</th><th class="b">Installed (B)</th>
        </tr></thead>
        <tbody id="bodyPrograms"></tbody>
      </table>
      <div class="no-diff-msg" id="nonePrograms" style="display:none">No programs match your filter.</div>
    </div>
    <!-- Drivers -->
    <div class="rsection" id="sec-drivers">
      <div class="diff-controls">
        <input class="diff-search" placeholder="Search drivers..." oninput="filterDiff('drivers',this.value)" id="searchDrivers">
        <button class="diff-filter-btn" onclick="toggleFilter('drivers','changed')">~ Diff Ver</button>
        <button class="diff-filter-btn" onclick="toggleFilter('drivers','added')">ï¼‹ Only on B</button>
        <button class="diff-filter-btn" onclick="toggleFilter('drivers','removed')">ï¼ Only on A</button>
        <button class="diff-filter-btn" onclick="toggleFilter('drivers','match')">âœ“ Matching</button>
        <span class="diff-count" id="countDrivers"></span>
      </div>
      <table class="diff-table" id="tblDrivers">
        <thead><tr>
          <th>Status</th><th>Device</th><th>Class</th>
          <th class="a">Version (A)</th><th class="b">Version (B)</th>
          <th class="a">Date (A)</th><th class="b">Date (B)</th>
          <th class="a">Status (A)</th><th class="b">Status (B)</th>
        </tr></thead>
        <tbody id="bodyDrivers"></tbody>
      </table>
      <div class="no-diff-msg" id="noneDrivers" style="display:none">No drivers match your filter.</div>
    </div>
    <!-- Updates -->
    <div class="rsection" id="sec-updates">
      <div class="diff-controls">
        <input class="diff-search" placeholder="Search KB number, description..." oninput="filterDiff('updates',this.value)" id="searchUpdates">
        <button class="diff-filter-btn" onclick="toggleFilter('updates','added')">ï¼‹ Only on B</button>
        <button class="diff-filter-btn" onclick="toggleFilter('updates','removed')">ï¼ Only on A</button>
        <button class="diff-filter-btn" onclick="toggleFilter('updates','match')">âœ“ On Both</button>
        <span class="diff-count" id="countUpdates"></span>
      </div>
      <table class="diff-table" id="tblUpdates">
        <thead><tr>
          <th>Status</th><th>KB Number</th><th>Description / Title</th>
          <th class="a">Installed (A)</th><th class="b">Installed (B)</th>
        </tr></thead>
        <tbody id="bodyUpdates"></tbody>
      </table>
      <div class="no-diff-msg" id="noneUpdates" style="display:none">No updates match your filter.</div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let files = {a: null, b: null};
let data  = {a: null, b: null};
let activeFilters = {programs:{}, drivers:{}, updates:{}};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DROP / FILE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onDragOver(e, side){ e.preventDefault(); document.getElementById('drop'+side.toUpperCase()).classList.add('drag-over'); }
function onDragLeave(side)  { document.getElementById('drop'+side.toUpperCase()).classList.remove('drag-over'); }
function onDrop(e, side)    { e.preventDefault(); onDragLeave(side); setFile(side, e.dataTransfer.files[0]); }
function onFileSelect(e, side){ setFile(side, e.target.files[0]); }

function setFile(side, file){
  if(!file || (!file.name.endsWith('.html') && !file.name.endsWith('.zip'))) return alert('Please select a SysInfoGrabber HTML or ZIP file.');
  files[side] = file;
  const S = side.toUpperCase();
  document.getElementById('drop'+S).classList.add('loaded');
  document.getElementById('hint'+S).style.display = 'none';
  document.getElementById('filename'+S).textContent = file.name;
  if(files.a && files.b) document.getElementById('compareBtn').classList.add('ready');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCSV(text){
  text = text.replace(/^\uFEFF/, '').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const lines = text.split('\n').filter(l=>l.trim());
  if(!lines.length) return [];
  const headers = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g,'').replace(/^\uFEFF/,'').trim());
  return lines.slice(1).map(l => {
    const vals = parseCSVLine(l);
    const obj = {};
    headers.forEach((h,i) => { obj[h] = (vals[i]||'').replace(/^"|"$/g,'').trim(); });
    return obj;
  });
}

function parseCSVLine(line){
  const result=[]; let cur='', inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){ if(inQ && line[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; }
    else if(c===',' && !inQ){ result.push(cur);cur=''; }
    else cur+=c;
  }
  result.push(cur);
  return result;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSER â€” handles both SysInfoGrabber HTML and ZIP files
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function parseZip(file){
  // If it's a ZIP, extract the HTML from inside it first
  let html;
  if(file.name.endsWith('.zip')){
    html = await extractHtmlFromZip(file);
  } else {
    html = await file.text();
  }

  const result = { programs:[], drivers:[], updates:[], meta:{} };

  // Extract meta fields from header
  result.meta = extractMetaFromHTML(html);

  // Extract base64-encoded CSVs from embedded download links
  // Pattern: <a class='dl-csv-btn' href='data:text/csv;base64,BASE64DATA' download='FILENAME.csv'>
  const csvRe = /href=['"](data:text\/csv;base64,([^'"]+))['"]\s+download=['"]([^'"]+)['"]/gi;
  let m;
  while((m = csvRe.exec(html)) !== null){
    const b64      = m[2];
    const filename = m[3].toLowerCase();
    const text     = decodeB64Csv(b64);
    if(filename === 'installedprograms.csv') result.programs = parseCSV(text);
    else if(filename === 'systemdrivers.csv')  result.drivers  = parseCSV(text);
    else if(filename === 'windowsupdates.csv') result.updates  = parseCSV(text);
  }
  return result;
}

async function extractHtmlFromZip(file){
  // Use the native DecompressionStream API (supported in all modern browsers)
  // to inflate the first HTML entry in the ZIP without an external library.
  const buf    = await file.arrayBuffer();
  const view   = new DataView(buf);
  const bytes  = new Uint8Array(buf);

  // Walk ZIP local file headers (signature 0x04034b50)
  let offset = 0;
  while(offset + 30 < bytes.length){
    const sig = view.getUint32(offset, true);
    if(sig !== 0x04034b50) break;                        // not a local file header

    const compression  = view.getUint16(offset + 8,  true);
    const compSize     = view.getUint32(offset + 18, true);
    const fnLen        = view.getUint16(offset + 26, true);
    const extraLen     = view.getUint16(offset + 28, true);
    const fnBytes      = bytes.slice(offset + 30, offset + 30 + fnLen);
    const entryName    = new TextDecoder().decode(fnBytes).toLowerCase();
    const dataStart    = offset + 30 + fnLen + extraLen;
    const compData     = bytes.slice(dataStart, dataStart + compSize);

    if(entryName.endsWith('.html')){
      if(compression === 0){
        // Stored (no compression)
        return new TextDecoder('utf-8').decode(compData);
      } else if(compression === 8){
        // Deflated â€” use DecompressionStream
        const ds     = new DecompressionStream('deflate-raw');
        const writer = ds.writable.getWriter();
        const reader = ds.readable.getReader();
        writer.write(compData);
        writer.close();
        const chunks = [];
        let   done   = false;
        while(!done){
          const { value, done: d } = await reader.read();
          if(value) chunks.push(value);
          done = d;
        }
        const total  = chunks.reduce((n,c)=>n+c.length, 0);
        const merged = new Uint8Array(total);
        let   pos    = 0;
        chunks.forEach(c=>{ merged.set(c, pos); pos += c.length; });
        return new TextDecoder('utf-8').decode(merged);
      }
    }
    offset = dataStart + compSize;
  }
  throw new Error('No HTML file found inside the ZIP.');
}

function decodeB64Csv(b64){
  // Decode base64 to binary string then convert bytes to UTF-8 text
  try {
    const binStr = atob(b64);
    const bytes  = new Uint8Array(binStr.length);
    for(let i=0;i<binStr.length;i++) bytes[i]=binStr.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
  } catch(e) {
    return '';
  }
}

function extractMetaFromHTML(html){
  const meta = {};
  // Extract meta-row label/value pairs
  const rowRe = /meta-label[^>]*>([^<]+)<\/span>\s*<span[^>]*meta-value[^>]*>([^<]+)<\/span>/g;
  let m;
  while((m = rowRe.exec(html)) !== null){
    const key = m[1].trim();
    const val = m[2].trim();
    meta[key] = val;
  }
  return meta;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN COMPARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runCompare(){
  document.getElementById('loadingOverlay').style.display='flex';
  try {
    data.a = await parseZip(files.a);
    data.b = await parseZip(files.b);
    buildResults();
    document.getElementById('dropScreen').style.display   = 'none';
    document.getElementById('resultScreen').style.display = 'flex';
  } catch(e){
    alert('Error parsing HTML files: '+e.message);
    console.error(e);
  }
  document.getElementById('loadingOverlay').style.display='none';
}

function resetToDropScreen(){
  files={a:null,b:null}; data={a:null,b:null};
  document.getElementById('resultScreen').style.display='none';
  document.getElementById('dropScreen').style.display='flex';
  ['A','B'].forEach(s=>{
    document.getElementById('drop'+s).classList.remove('loaded','drag-over');
    document.getElementById('hint'+s).style.display='';
    document.getElementById('filename'+s).textContent='';
    document.getElementById('file'+s).value='';
  });
  document.getElementById('compareBtn').classList.remove('ready');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildResults(){
  const ma = data.a.meta, mb = data.b.meta;

  // Header machine names
  document.getElementById('machineNameA').textContent = ma['Host'] || files.a.name;
  document.getElementById('machineNameB').textContent = mb['Host'] || files.b.name;
  document.getElementById('machineOsA').textContent   = ma['Windows'] || '';
  document.getElementById('machineOsB').textContent   = mb['Windows'] || '';

  buildOverview(ma, mb);
  const progStats   = buildProgramsDiff();
  const driverStats = buildDriversDiff();
  const updateStats = buildUpdatesDiff();
  buildTabs(progStats, driverStats, updateStats);
  buildSummaryPills(progStats, driverStats, updateStats);
}

// â”€â”€ Overview â”€â”€
function buildOverview(ma, mb){
  const fields = [
    ['Host',         'Host'],
    ['Manufacturer', 'Manufacturer'],
    ['Model',        'Model'],
    ['Serial',       'Serial'],
    ['BIOS',         'BIOS'],
    ['Windows',      'Windows'],
    ['Installed',    'Installed'],
    ['Generated',    'Generated'],
  ];

  const grid = document.getElementById('overviewGrid');
  grid.innerHTML = '';

  // Machine A card
  let aHtml = '<div class="ov-card a"><div class="ov-card-header">â–² Machine A â€” '+esc(ma['Host']||'Unknown')+'</div><div class="ov-fields">';
  let bHtml = '<div class="ov-card b"><div class="ov-card-header">â–² Machine B â€” '+esc(mb['Host']||'Unknown')+'</div><div class="ov-fields">';

  fields.forEach(([label, key])=>{
    const va = ma[key]||'â€”', vb = mb[key]||'â€”';
    const diff = va !== vb;
    aHtml += '<div class="ov-label">'+esc(label)+'</div><div class="ov-val'+(diff?' diff':'')+'">'+esc(va)+'</div>';
    bHtml += '<div class="ov-label">'+esc(label)+'</div><div class="ov-val'+(diff?' diff':'')+'">'+esc(vb)+'</div>';
  });

  aHtml += '</div></div>';
  bHtml += '</div></div>';
  grid.innerHTML = aHtml + bHtml;
}

// â”€â”€ Programs Diff â”€â”€
function buildProgramsDiff(){
  const pa = {}, pb = {};
  data.a.programs.forEach(p => { if(p.Name) pa[normName(p.Name)] = p; });
  data.b.programs.forEach(p => { if(p.Name) pb[normName(p.Name)] = p; });

  const allKeys = new Set([...Object.keys(pa), ...Object.keys(pb)]);
  const rows = [];

  allKeys.forEach(key=>{
    const a = pa[key], b = pb[key];
    let status;
    if(a && b){
      const verA = (a.Version||'').trim(), verB = (b.Version||'').trim();
      status = normVer(verA) === normVer(verB) ? 'match' : 'changed';
    } else if(a && !b){ status = 'removed'; }
    else               { status = 'added'; }
    rows.push({status, name: (a||b).Name, a, b});
  });

  rows.sort((x,y)=>{
    const order={changed:0,removed:1,added:2,match:3};
    return (order[x.status]??9)-(order[y.status]??9) || x.name.localeCompare(y.name);
  });

  const tbody = document.getElementById('bodyPrograms');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.className = 'row-'+r.status;
    tr.dataset.status = r.status;
    tr.dataset.name   = (r.name||'').toLowerCase();
    const verA = r.a?.Version||'', verB = r.b?.Version||'';
    const dateA = r.a?.InstallDate||'', dateB = r.b?.InstallDate||'';
    tr.innerHTML =
      '<td><span class="badge-diff badge-'+r.status+'">'+statusLabel(r.status)+'</span></td>'+
      '<td class="name-col" title="'+esc(r.name)+'">'+esc(r.name)+'</td>'+
      '<td class="'+(r.a?'val-a':'val-missing')+'">'+esc(verA||'â€”')+'</td>'+
      '<td class="'+(r.b?'val-b':'val-missing')+'">'+esc(verB||'â€”')+'</td>'+
      '<td class="'+(r.a?'val-a':'val-missing')+'">'+esc(dateA||'â€”')+'</td>'+
      '<td class="'+(r.b?'val-b':'val-missing')+'">'+esc(dateB||'â€”')+'</td>';
    tbody.appendChild(tr);
  });

  const stats = countStats(rows);
  document.getElementById('countPrograms').textContent = rows.length+' programs';
  return stats;
}

// â”€â”€ Drivers Diff â”€â”€
function buildDriversDiff(){
  const da = {}, db = {};
  // Key by DeviceName + DeviceClass for uniqueness
  data.a.drivers.forEach(d=>{ if(d.DeviceName){ const k=(d.DeviceName+'|'+(d.DeviceClass||'')).toLowerCase(); da[k]=d; }});
  data.b.drivers.forEach(d=>{ if(d.DeviceName){ const k=(d.DeviceName+'|'+(d.DeviceClass||'')).toLowerCase(); db[k]=d; }});

  const allKeys = new Set([...Object.keys(da), ...Object.keys(db)]);
  const rows = [];

  allKeys.forEach(key=>{
    const a = da[key], b = db[key];
    let status;
    if(a && b){
      const vA=(a.DriverVersion||'').trim(), vB=(b.DriverVersion||'').trim();
      const sA=(a.Status||'').trim(),        sB=(b.Status||'').trim();
      status = (normVer(vA)===normVer(vB) && sA===sB) ? 'match' : 'changed';
    } else if(a && !b){ status='removed'; }
    else               { status='added';   }
    rows.push({status, name:(a||b).DeviceName, cls:(a||b).DeviceClass||'', a, b});
  });

  rows.sort((x,y)=>{
    const order={changed:0,removed:1,added:2,match:3};
    return (order[x.status]??9)-(order[y.status]??9) || x.name.localeCompare(y.name);
  });

  const tbody = document.getElementById('bodyDrivers');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.className='row-'+r.status;
    tr.dataset.status=r.status;
    tr.dataset.name=(r.name||'').toLowerCase();
    const vA=r.a?.DriverVersion||'', vB=r.b?.DriverVersion||'';
    const dA=r.a?.DriverDate||'',    dB=r.b?.DriverDate||'';
    const sA=r.a?.Status||'',        sB=r.b?.Status||'';
    const vDiff = vA && vB && vA!==vB;
    const sDiff = sA && sB && sA!==sB;
    tr.innerHTML =
      '<td><span class="badge-diff badge-'+r.status+'">'+statusLabel(r.status)+'</span></td>'+
      '<td class="name-col" title="'+esc(r.name)+'">'+esc(r.name)+'</td>'+
      '<td style="color:var(--muted2)">'+esc(r.cls)+'</td>'+
      '<td class="'+(vDiff?'val-a':r.a?'val-match':'val-missing')+'">'+esc(vA||'â€”')+'</td>'+
      '<td class="'+(vDiff?'val-b':r.b?'val-match':'val-missing')+'">'+esc(vB||'â€”')+'</td>'+
      '<td class="'+(r.a?'val-a':'val-missing')+'">'+esc(dA||'â€”')+'</td>'+
      '<td class="'+(r.b?'val-b':'val-missing')+'">'+esc(dB||'â€”')+'</td>'+
      '<td class="'+(sDiff?'val-a':sA==='OK'?'val-match':'val-missing')+'">'+esc(sA||'â€”')+'</td>'+
      '<td class="'+(sDiff?'val-b':sB==='OK'?'val-match':'val-missing')+'">'+esc(sB||'â€”')+'</td>';
    tbody.appendChild(tr);
  });

  const stats = countStats(rows);
  document.getElementById('countDrivers').textContent = rows.length+' drivers';
  return stats;
}

// â”€â”€ Updates Diff â”€â”€
function buildUpdatesDiff(){
  const ua = {}, ub = {};
  // Key by KB number if available, else by normalized title
  const updKey = u => (u.KBNumber && u.KBNumber.trim()) ? u.KBNumber.trim().toLowerCase() : normName(u.Description||'');
  data.a.updates.forEach(u=>{ const k=updKey(u); if(k) ua[k]=u; });
  data.b.updates.forEach(u=>{ const k=updKey(u); if(k) ub[k]=u; });

  const allKeys = new Set([...Object.keys(ua), ...Object.keys(ub)]);
  const rows = [];

  allKeys.forEach(key=>{
    const a = ua[key], b = ub[key];
    let status;
    if(a && b)      { status = 'match';   }
    else if(a && !b){ status = 'removed'; }
    else             { status = 'added';  }
    rows.push({status, kb:(a||b).KBNumber||'', desc:(a||b).Description||'', a, b});
  });

  rows.sort((x,y)=>{
    const order={removed:0,added:1,match:2};
    return (order[x.status]??9)-(order[y.status]??9) || x.kb.localeCompare(y.kb) || x.desc.localeCompare(y.desc);
  });

  const tbody = document.getElementById('bodyUpdates');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.className = 'row-'+r.status;
    tr.dataset.status = r.status;
    tr.dataset.name   = (r.kb+' '+r.desc).toLowerCase();
    const dateA = r.a?.InstalledOn||'', dateB = r.b?.InstalledOn||'';
    tr.innerHTML =
      '<td><span class="badge-diff badge-'+r.status+'">'+updStatusLabel(r.status)+'</span></td>'+
      '<td style="font-family:var(--mono);font-size:11px;color:'+(r.status==='removed'?'var(--a-color)':r.status==='added'?'var(--b-color)':'var(--muted2)')+'">'+esc(r.kb||'â€”')+'</td>'+
      '<td class="name-col" title="'+esc(r.desc)+'">'+esc(r.desc)+'</td>'+
      '<td class="'+(r.a?'val-a':'val-missing')+'">'+esc(dateA||'â€”')+'</td>'+
      '<td class="'+(r.b?'val-b':'val-missing')+'">'+esc(dateB||'â€”')+'</td>';
    tbody.appendChild(tr);
  });

  const stats = countStats(rows);
  document.getElementById('countUpdates').textContent = rows.length+' updates';
  return stats;
}

// â”€â”€ Tabs â”€â”€
function buildTabs(progStats, driverStats, updateStats){
  const tabs = [
    {id:'overview', label:'System Overview', stats: null},
    {id:'programs', label:'Programs',        stats: progStats},
    {id:'drivers',  label:'Drivers',         stats: driverStats},
    {id:'updates',  label:'Windows Updates', stats: updateStats},
  ];
  const container = document.getElementById('resultTabs');
  container.innerHTML = '';
  tabs.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className = 'rtab'+(i===0?' active':'');
    btn.onclick = ()=>{
      document.querySelectorAll('.rtab').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.rsection').forEach(s=>s.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('sec-'+t.id).classList.add('active');
    };
    let countHtml = '';
    if(t.stats){
      const hasDiff = t.stats.changed+t.stats.added+t.stats.removed > 0;
      const total   = t.stats.changed+t.stats.added+t.stats.removed;
      countHtml = '<span class="rtab-count'+(hasDiff?' has-diff':'')+'">'+
        (hasDiff ? total+' diffs' : 'âœ“ match')+'</span>';
    }
    btn.innerHTML = t.label + countHtml;
    container.appendChild(btn);
  });
}

// â”€â”€ Summary Pills â”€â”€
function buildSummaryPills(pStats, dStats, uStats){
  const total = {
    changed: pStats.changed + dStats.changed + uStats.changed,
    added:   pStats.added   + dStats.added   + uStats.added,
    removed: pStats.removed + dStats.removed + uStats.removed,
    match:   pStats.match   + dStats.match   + uStats.match,
  };
  const pills = document.getElementById('summaryPills');
  pills.innerHTML = '';
  if(total.changed) pills.innerHTML += '<span class="pill pill-changed">âš¡ '+total.changed+' changed</span>';
  if(total.added)   pills.innerHTML += '<span class="pill pill-added">ï¼‹ '+total.added+' only on B</span>';
  if(total.removed) pills.innerHTML += '<span class="pill pill-removed">ï¼ '+total.removed+' only on A</span>';
  if(total.match)   pills.innerHTML += '<span class="pill pill-match">âœ“ '+total.match+' matching</span>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilter(section, type){
  const btn = event.currentTarget;
  const wasActive = activeFilters[section][type];
  activeFilters[section][type] = !wasActive;
  btn.classList.toggle('active-'+type, !wasActive);
  applyFilters(section);
}

function filterDiff(section, q){
  applyFilters(section, q);
}

function applyFilters(section, q){
  q = q ?? document.getElementById('search'+capitalize(section)).value.toLowerCase();
  const activeF = Object.entries(activeFilters[section]).filter(([,v])=>v).map(([k])=>k);
  const rows = document.getElementById('body'+capitalize(section)).querySelectorAll('tr');
  const noMsg = document.getElementById('none'+capitalize(section));
  let visible = 0;

  rows.forEach(tr=>{
    const statusMatch = activeF.length===0 || activeF.includes(tr.dataset.status);
    const textMatch   = !q || tr.dataset.name.includes(q) || tr.textContent.toLowerCase().includes(q);
    const show = statusMatch && textMatch;
    tr.style.display = show ? '' : 'none';
    if(show) visible++;
  });

  const countEl = document.getElementById('count'+capitalize(section));
  countEl.textContent = visible===rows.length ? rows.length+' '+section : visible+' of '+rows.length+' '+section;
  noMsg.style.display = visible===0 ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Normalize program name â€” strip trailing version numbers for matching
// e.g. "7-Zip 24.09" -> "7-zip", "Python 3.11.0" -> "python"
function normName(name){
  return name
    .toLowerCase()
    .replace(/\s+v?\d[\d._\-]*$/i, '')  // strip trailing version like "3.11.0" or "v2.1"
    .replace(/\s+\(\d[^)]*\)$/,'')       // strip trailing "(64-bit)" style suffixes with numbers
    .trim();
}

// Normalize version for comparison â€” strip trailing .0 segments
// e.g. "24.09.00.0" -> "24.09", "1.2.0.0" -> "1.2"
function normVer(v){
  if(!v) return '';
  // Split on dots, remove trailing zero segments
  const parts = v.split('.');
  while(parts.length > 1 && parts[parts.length-1].replace(/^0+$/,'') === '') parts.pop();
  // Also normalize each segment: strip leading zeros (e.g. "09" stays "09" for semver but collapse "00")
  return parts.join('.').toLowerCase();
}

function statusLabel(s){ return {changed:'DIFF VER',added:'ONLY B',removed:'ONLY A',match:'MATCH'}[s]||s.toUpperCase(); }
function updStatusLabel(s){ return {added:'ONLY B',removed:'ONLY A',match:'BOTH'}[s]||s.toUpperCase(); }
function countStats(rows){ return rows.reduce((acc,r)=>{ acc[r.status]=(acc[r.status]||0)+1; return acc; },{changed:0,added:0,removed:0,match:0}); }
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
