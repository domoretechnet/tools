<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Scanner Pro</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600;700&display=swap');

  :root {
    --bg: #0a0c10;
    --surface: #0f1318;
    --border: #1e2530;
    --accent: #00e5ff;
    --accent2: #39ff14;
    --warn: #ff6b35;
    --danger: #ff2d55;
    --text: #c8d6e5;
    --muted: #4a5568;
    --success-glow: 0 0 20px rgba(57,255,20,0.4);
    --error-glow: 0 0 20px rgba(255,45,85,0.4);
    --accent-glow: 0 0 20px rgba(0,229,255,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse at 20% 50%, rgba(0,229,255,0.03) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(57,255,20,0.03) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* Scanline effect */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 860px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  .header {
    text-align: center;
    margin-bottom: 40px;
  }

  .header h1 {
    font-family: 'Share Tech Mono', monospace;
    font-size: 2rem;
    color: var(--accent);
    text-shadow: 0 0 30px rgba(0,229,255,0.5);
    letter-spacing: 4px;
    text-transform: uppercase;
  }

  .header p {
    color: var(--muted);
    font-size: 0.8rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 6px;
  }

  /* Mode tabs */
  .mode-tabs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2px;
    margin-bottom: 32px;
    background: var(--border);
    border-radius: 8px;
    padding: 2px;
    border: 1px solid var(--border);
  }

  .tab-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.85rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 14px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .tab-btn.active {
    background: var(--surface);
    color: var(--accent);
    box-shadow: var(--accent-glow);
  }

  .tab-btn:hover:not(.active) {
    color: var(--text);
    background: rgba(255,255,255,0.03);
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 20px;
  }

  .card-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Status indicator */
  .status-bar {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 18px;
    border-radius: 8px;
    margin-top: 12px;
    margin-bottom: 0;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.3);
    min-height: 54px;
    transition: all 0.15s;
  }

  .status-icon {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    background: var(--muted);
    transition: all 0.15s;
  }

  .status-bar.ready .status-icon { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
  .status-bar.success .status-icon { background: var(--accent2); box-shadow: 0 0 12px var(--accent2); }
  .status-bar.error .status-icon { background: var(--danger); box-shadow: 0 0 12px var(--danger); }
  .status-bar.warn .status-icon { background: var(--warn); box-shadow: 0 0 12px var(--warn); }
  .status-bar.pair-ready .status-icon { background: #a855f7; box-shadow: 0 0 12px #a855f7; }

  .status-bar.success { border-color: rgba(57,255,20,0.3); box-shadow: var(--success-glow); }
  .status-bar.error { border-color: rgba(255,45,85,0.3); box-shadow: var(--error-glow); }
  .status-bar.warn { border-color: rgba(255,107,53,0.3); }
  .status-bar.pair-ready { border-color: rgba(168,85,247,0.3); }

  .status-text {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.88rem;
    color: var(--text);
  }

  /* Scan input */
  .scan-input-wrap {
    position: relative;
    margin-bottom: 16px;
  }

  .scan-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
    display: block;
  }

  .scan-input {
    width: 100%;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--accent);
    font-family: 'Share Tech Mono', monospace;
    font-size: 1.4rem;
    letter-spacing: 6px;
    padding: 16px 20px;
    outline: none;
    transition: all 0.15s;
    text-transform: uppercase;
  }

  .scan-input:focus {
    border-color: var(--accent);
    box-shadow: var(--accent-glow), inset 0 0 0 1px rgba(0,229,255,0.1);
  }

  .scan-input::placeholder { color: var(--muted); letter-spacing: 2px; font-size: 0.9rem; }

  .scan-input.flash-success {
    animation: flashSuccess 0.3s ease;
  }
  .scan-input.flash-error {
    animation: flashError 0.3s ease;
  }

  @keyframes flashSuccess {
    0% { border-color: var(--accent2); box-shadow: 0 0 30px rgba(57,255,20,0.6), inset 0 0 20px rgba(57,255,20,0.1); }
    100% { border-color: var(--accent); box-shadow: var(--accent-glow); }
  }

  @keyframes flashError {
    0% { border-color: var(--danger); box-shadow: 0 0 30px rgba(255,45,85,0.6), inset 0 0 20px rgba(255,45,85,0.1); }
    100% { border-color: var(--border); box-shadow: none; }
  }

  /* Stats row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-box {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    text-align: center;
  }

  .stat-num {
    font-family: 'Share Tech Mono', monospace;
    font-size: 1.8rem;
    color: var(--accent);
    line-height: 1;
  }

  .stat-label {
    font-size: 0.68rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Asset pair display */
  .pair-display {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }

  .pair-box {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
  }

  .pair-box.active {
    border-color: rgba(168,85,247,0.5);
    box-shadow: 0 0 15px rgba(168,85,247,0.2);
  }

  .pair-box.filled {
    border-color: rgba(0,229,255,0.4);
  }

  .pair-box-label {
    font-size: 0.65rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .pair-box-value {
    font-family: 'Share Tech Mono', monospace;
    font-size: 1rem;
    color: var(--text);
    min-height: 24px;
    letter-spacing: 2px;
  }

  .pair-box-value.has-value { color: var(--accent); }

  /* Scan log */
  .scan-log {
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 8px;
    height: 180px;
    overflow-y: auto;
    padding: 12px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
  }

  .scan-log::-webkit-scrollbar { width: 4px; }
  .scan-log::-webkit-scrollbar-track { background: transparent; }
  .scan-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .log-entry {
    display: flex;
    gap: 10px;
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    align-items: center;
  }

  .log-time { color: var(--muted); font-size: 0.7rem; flex-shrink: 0; }
  .log-ok { color: var(--accent2); }
  .log-err { color: var(--danger); }
  .log-warn { color: var(--warn); }
  .log-pair { color: #a855f7; }
  .log-code { color: var(--accent); }

  /* File export section */
  .export-section { }

  .export-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: end;
    margin-bottom: 12px;
  }

  .form-group label {
    display: block;
    font-size: 0.68rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .form-input {
    width: 100%;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 0.9rem;
    padding: 11px 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-input:focus { border-color: var(--accent); }
  .form-input.invalid { border-color: var(--danger); }

  .filename-preview {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    margin-top: 6px;
    min-height: 18px;
  }

  .filename-preview.valid { color: var(--accent2); }
  .filename-preview.invalid { color: var(--danger); }

  /* Buttons */
  .btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn:hover { border-color: var(--muted); color: var(--accent); }

  .btn-primary {
    border-color: var(--accent);
    color: var(--accent);
  }

  .btn-primary:hover {
    background: rgba(0,229,255,0.08);
    box-shadow: var(--accent-glow);
  }

  .btn-success {
    border-color: var(--accent2);
    color: var(--accent2);
  }

  .btn-success:hover {
    background: rgba(57,255,20,0.08);
    box-shadow: var(--success-glow);
  }

  .btn-danger {
    border-color: var(--danger);
    color: var(--danger);
  }

  .btn-danger:hover {
    background: rgba(255,45,85,0.08);
  }

  .btn-row {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 16px;
  }

  .btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  /* Mode panels */
  .mode-panel { display: none; }
  .mode-panel.active { display: block; }

  /* Responsive */
  @media (max-width: 600px) {
    .stats-row { grid-template-columns: 1fr 1fr; }
    .pair-display { grid-template-columns: 1fr; }
    .export-row { grid-template-columns: 1fr; }
  }

  /* ===================== AUDIT SESSION STYLES ===================== */
  .scan-input:disabled { opacity: 0.4; cursor: not-allowed; }

  .session-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .session-list::-webkit-scrollbar { width: 4px; }
  .session-list::-webkit-scrollbar-track { background: transparent; }
  .session-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .session-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.35);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    transition: border-color 0.15s;
  }
  .session-item:hover { border-color: rgba(0,229,255,0.25); }
  .session-item.active-session {
    border-color: rgba(0,229,255,0.5);
    background: rgba(0,229,255,0.04);
  }

  .session-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 6px var(--accent);
    flex-shrink: 0;
  }
  .session-dot.inactive { background: var(--muted); box-shadow: none; }

  .session-meta { flex: 1; min-width: 0; }
  .session-meta-clickable {
    cursor: pointer;
    border-radius: 4px;
    padding: 2px 4px;
    margin: -2px -4px;
    transition: background 0.15s;
  }
  .session-meta-clickable:hover { background: rgba(0,229,255,0.08); }
  .session-meta-clickable:hover .session-name { color: #fff; }
  .session-meta-clickable:hover .session-sub { color: var(--text); }
  .session-name {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.82rem;
    color: var(--accent);
    letter-spacing: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .session-sub { font-size: 0.68rem; color: var(--muted); letter-spacing: 1px; margin-top: 2px; }

  .session-badge {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.2);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 4px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .session-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .session-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 1px;
    padding: 5px 10px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .session-btn:hover { border-color: var(--accent); color: var(--accent); }
  .session-btn.del:hover { border-color: var(--danger); color: var(--danger); }
  .session-btn.active-label { color: var(--accent); border-color: rgba(0,229,255,0.3); cursor: default; }

  .session-empty {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    text-align: center;
    padding: 24px;
    letter-spacing: 2px;
  }

  .new-session-bar {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: end;
    margin-bottom: 16px;
  }

  .export-multi-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 4px;
  }
  .export-multi-row .btn { flex: 1; min-width: 130px; text-align: center; }

  .export-note {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 10px;
    letter-spacing: 1px;
  }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 22px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    color: var(--accent2);
    letter-spacing: 2px;
    z-index: 9999;
    transition: transform 0.3s cubic-bezier(.16,1,.3,1), opacity 0.3s;
    opacity: 0;
    white-space: nowrap;
    box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  .toast.toast-error { color: var(--danger); border-color: rgba(255,45,85,0.3); }

  .cross-dupe-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 240px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .cross-dupe-list::-webkit-scrollbar { width: 4px; }
  .cross-dupe-list::-webkit-scrollbar-track { background: transparent; }
  .cross-dupe-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .cross-dupe-item {
    display: flex;
    align-items: baseline;
    gap: 12px;
    background: rgba(255,107,53,0.06);
    border: 1px solid rgba(255,107,53,0.25);
    border-radius: 6px;
    padding: 8px 12px;
  }
  .cross-dupe-serial {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.85rem;
    color: var(--warn);
    letter-spacing: 2px;
    flex-shrink: 0;
    min-width: 80px;
  }
  .cross-dupe-sessions {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .log-toggle-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 7px 14px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
  }
  .log-toggle-btn:hover { border-color: var(--accent); color: var(--accent); }
  .log-toggle-btn.open { border-color: rgba(0,229,255,0.3); color: var(--accent); }
  #logToggleIcon { font-size: 0.7rem; transition: transform 0.2s; }
  .log-toggle-btn.open #logToggleIcon { transform: rotate(90deg); }

  @media (max-width: 600px) {
    .new-session-bar { grid-template-columns: 1fr; }
    .session-actions { flex-wrap: wrap; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>&#9671; Scanner Helper</h1>
    <p>Inventory Management Helper - Scanning made easy! </p>
  </div>

  <div class="mode-tabs">
    <button class="tab-btn active" onclick="switchMode('audit')">&#9632; Audit Mode</button>
    <button class="tab-btn" onclick="switchMode('newasset')">&#9670; New Asset Mode</button>
  </div>

  <!-- ==================== AUDIT MODE ==================== -->
  <div id="auditPanel" class="mode-panel active">

    <!-- Session Management Card (TOP) -->
    <div class="card">
      <div class="card-title">Scan Sessions</div>

      <div class="new-session-bar">
        <div class="form-group" style="margin:0">
          <label>New Session Label</label>
          <input type="text" class="form-input" id="newSessionLabel" placeholder="e.g. Laptops or Monitors" oninput="updateNewSessionPreview()" onkeydown="if(event.key==='Enter')createSession()">
          <div class="filename-preview" id="newSessionPreview">Enter a label to preview filename</div>
        </div>
        <button class="btn btn-primary" onclick="createSession()" style="margin-top:26px">+ New</button>
      </div>

      <div class="session-list" id="sessionList">
        <div class="session-empty">No sessions yet — create one above</div>
      </div>

      <div class="btn-row" style="margin-top:14px">
        <button class="btn btn-danger" onclick="clearAllSessions()">Clear All Sessions</button>
      </div>
    </div>

    <!-- Scan Input Card -->
    <div class="card">
      <div class="card-title">Barcode Input</div>

      <div class="scan-input-wrap">
        <input
          type="text"
          class="scan-input"
          id="auditInput"
          placeholder="Select a session first..."
          maxlength="20"
          autocomplete="off"
          autofocus
          disabled
        >
      </div>

      <div class="status-bar ready" id="auditStatus">
        <div class="status-icon"></div>
        <span class="status-text" id="auditStatusText">Create or select a scan session to begin</span>
      </div>
    </div>

    <!-- Stats + Scan Log Card (combined) -->
    <div class="card">
      <div class="card-title">Active Session Stats</div>
      <div class="stats-row" style="margin-bottom:0">
        <div class="stat-box">
          <div class="stat-num" id="auditCount">0</div>
          <div class="stat-label">Scanned</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="auditDupes" style="color:var(--warn)">0</div>
          <div class="stat-label">Duplicates</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="auditErrors" style="color:var(--danger)">0</div>
          <div class="stat-label">Invalid</div>
        </div>
      </div>

      <!-- Collapsible scan log -->
      <div style="margin-top:16px">
        <button class="log-toggle-btn" id="logToggleBtn" onclick="toggleScanLog()">
          <span id="logToggleIcon">&#9656;</span> Scan Log
        </button>
        <div id="auditLogWrap" style="display:none;margin-top:10px">
          <div class="scan-log" id="auditLog">
            <div class="session-empty">No active session</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Card -->
    <div class="card export-section">
      <div class="card-title">Export</div>
      <p style="font-size:0.78rem;color:var(--muted);letter-spacing:1px;margin-bottom:14px;font-family:'Share Tech Mono',monospace;">
        Export individual sessions as .txt, download all as a .zip, or copy the combined list.
      </p>
      <div class="export-multi-row">
        <button class="btn btn-primary" id="auditDownloadActiveBtn" onclick="downloadActiveSession()" disabled>&#8595; Active .txt</button>
        <button class="btn btn-success" id="auditZipBtn" onclick="downloadAllZip()" disabled>&#8595; All (.zip)</button>
        <button class="btn" id="auditCombinedBtn" onclick="copyCombined()" disabled>&#10697; Copy Combined</button>
      </div>
      <div class="export-note" id="exportSummaryNote">No sessions to export.</div>

      <!-- Cross-session duplicates (inline, hidden until dupes exist) -->
      <div id="crossDupeCard" style="display:none;margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
        <div style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;letter-spacing:2px;text-transform:uppercase;color:var(--warn);margin-bottom:10px;display:flex;align-items:center;gap:8px;">
          &#9888; Cross-Session Duplicates
          <span id="crossDupeCount" style="font-size:0.65rem;background:rgba(255,107,53,0.15);border:1px solid rgba(255,107,53,0.3);padding:1px 7px;border-radius:4px;"></span>
        </div>
        <p style="font-size:0.72rem;color:var(--muted);letter-spacing:1px;margin-bottom:10px;font-family:'Share Tech Mono',monospace;">
          These appear in multiple sessions — combined export includes each once.
        </p>
        <div id="crossDupeList" class="cross-dupe-list"></div>
      </div>
    </div>

  </div>

  <!-- ==================== NEW ASSET MODE ==================== -->
  <div id="newassetPanel" class="mode-panel">

    <div class="card">
      <div class="card-title">Asset Tag Input</div>

      <div class="pair-display">
        <div class="pair-box active" id="assetTagBox">
          <div class="pair-box-label">&#9670; Step 1 — Asset Tag (6 digits)</div>
          <div class="pair-box-value" id="assetTagValue">—</div>
        </div>
        <div class="pair-box" id="serialBox">
          <div class="pair-box-label">&#9632; Step 2 — Serial Number (7 chars)</div>
          <div class="pair-box-value" id="serialValue">—</div>
        </div>
      </div>

      <label class="scan-label" id="assetScanLabel">Asset Tag Input</label>
      <div class="scan-input-wrap">
        <input 
          type="text" 
          class="scan-input" 
          id="assetInput" 
          placeholder="Awaiting scan..."
          autocomplete="off"
        >
      </div>

      <div class="status-bar ready" id="assetStatus">
        <div class="status-icon"></div>
        <span class="status-text" id="assetStatusText">Ready — scan Asset Tag first</span>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Session Stats</div>
      <div class="stats-row" style="margin-bottom:0">
        <div class="stat-box">
          <div class="stat-num" id="assetCount">0</div>
          <div class="stat-label">Pairs Logged</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="assetDupes" style="color:var(--warn)">0</div>
          <div class="stat-label">Duplicates</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="assetErrors" style="color:var(--danger)">0</div>
          <div class="stat-label">Invalid</div>
        </div>
      </div>

      <!-- Collapsible scan log -->
      <div style="margin-top:16px">
        <button class="log-toggle-btn" id="assetLogToggleBtn" onclick="toggleAssetLog()">
          <span id="assetLogToggleIcon">&#9656;</span> Scan Log
        </button>
        <div id="assetLogWrap" style="display:none;margin-top:10px">
          <div class="scan-log" id="assetLog"></div>
        </div>
      </div>
    </div>

    <div class="card export-section">
      <div class="card-title">Export</div>
      <div class="export-row">
        <div class="form-group">
          <label>File Label (New_Assets_<em>label</em>_Date-Count.txt)</label>
          <input type="text" class="form-input" id="assetFileName" placeholder="e.g. Laptops" oninput="updateAssetPreview()">
          <div class="filename-preview" id="assetFilePreview">Enter a label to preview filename</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-danger" onclick="clearAssets()">Clear Session</button>
        <button class="btn btn-success" id="assetDownloadBtn" onclick="downloadAssets()" disabled>Download .txt</button>
      </div>
    </div>

  </div>
</div>

<!-- Toast notification -->
<div class="toast" id="auditToast"></div>

<script>
// ===================== AUDIO ENGINE =====================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx = null;

function getACtx() {
  if (!actx) actx = new AudioCtx();
  return actx;
}

function beep(type) {
  const ctx = getACtx();
  const g = ctx.createGain();
  g.connect(ctx.destination);

  const configs = {
    success:    [{ f: 880, t: 0.08, v: 0.4 }],
    error:      [{ f: 180, t: 0.18, v: 0.5 }],
    duplicate:  [{ f: 440, t: 0.07 }, { f: 300, t: 0.07 }],
    pairReady:  [{ f: 660, t: 0.07 }, { f: 880, t: 0.07 }],
    complete:   [{ f: 660, t: 0.07 }, { f: 880, t: 0.07 }, { f: 1100, t: 0.1 }],
  };

  const notes = configs[type] || configs.success;
  let time = ctx.currentTime;

  notes.forEach(n => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = n.f;
    osc.type = type === 'error' ? 'sawtooth' : 'sine';
    gain.gain.setValueAtTime(n.v || 0.35, time);
    gain.gain.exponentialRampToValueAtTime(0.001, time + n.t);
    osc.start(time);
    osc.stop(time + n.t);
    time += n.t + 0.02;
  });
}

// ===================== HELPERS =====================
const ILLEGAL_WIN_CHARS = /[<>:"/\\|?*\x00-\x1f]/;
const RESERVED_NAMES = /^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])$/i;

function sanitizeLabel(label) {
  return label.trim();
}

function validateLabel(label) {
  if (!label) return { valid: false, reason: 'Label cannot be empty' };
  if (ILLEGAL_WIN_CHARS.test(label)) return { valid: false, reason: 'Contains illegal Windows filename characters: < > : " / \\ | ? *' };
  if (RESERVED_NAMES.test(label)) return { valid: false, reason: 'Reserved Windows filename' };
  if (label.length > 50) return { valid: false, reason: 'Label too long (max 50 chars)' };
  return { valid: true };
}

function getDateStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${m}-${day}-${y}`;
}

function logEntry(logId, type, message) {
  const log = document.getElementById(logId);
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  const now = new Date();
  const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  const cls = { ok:'log-ok', error:'log-err', warn:'log-warn', pair:'log-pair', code:'log-code' };
  entry.innerHTML = `<span class="log-time">${ts}</span><span class="${cls[type] || ''}">${message}</span>`;
  log.prepend(entry);
}

function setStatus(elId, textId, state, msg) {
  const el = document.getElementById(elId);
  el.className = `status-bar ${state}`;
  document.getElementById(textId).textContent = msg;
}

function flashInput(id, type) {
  const el = document.getElementById(id);
  el.classList.remove('flash-success', 'flash-error');
  void el.offsetWidth;
  el.classList.add(type === 'success' ? 'flash-success' : 'flash-error');
}

// ===================== AUDIT MODE — MULTI-SESSION =====================
let auditSessions = [];
let activeSessionId = null;
let auditDupeCount = 0;
let auditErrorCount = 0;

function isValidBarcode(val) {
  if (!/^[A-Z0-9]{7}$/i.test(val)) return false;
  if (!/[A-Z]/i.test(val)) return false;  // must have at least one letter
  if (!/[0-9]/.test(val)) return false;   // must have at least one number
  return true;
}

function getActiveSession() {
  return auditSessions.find(s => s.id === activeSessionId) || null;
}

// ---- Toast ----
let _toastTimer = null;
function showToast(msg, type) {
  const t = document.getElementById('auditToast');
  t.textContent = msg;
  t.className = 'toast' + (type === 'error' ? ' toast-error' : '') + ' show';
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => {
    t.className = 'toast' + (type === 'error' ? ' toast-error' : '');
  }, 2400);
}

// ---- Session management ----
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
}

function updateNewSessionPreview() {
  const label = document.getElementById('newSessionLabel').value.trim();
  const preview = document.getElementById('newSessionPreview');
  if (!label) { preview.textContent = 'Enter a label to preview filename'; preview.className = 'filename-preview'; return; }
  const v = validateLabel(label);
  if (!v.valid) { preview.textContent = '✗ ' + v.reason; preview.className = 'filename-preview invalid'; return; }
  preview.textContent = `Audit_${label}_${getDateStr()}-C0.txt`;
  preview.className = 'filename-preview valid';
}

function createSession() {
  const label = document.getElementById('newSessionLabel').value.trim();
  const v = validateLabel(label);
  if (!v.valid) { showToast('Invalid label: ' + v.reason, 'error'); return; }

  const session = { id: generateId(), label, scanned: new Set(), dupeCount: 0, errorCount: 0, createdAt: new Date(), logEntries: [] };
  auditSessions.push(session);
  document.getElementById('newSessionLabel').value = '';
  updateNewSessionPreview();
  renderSessionList();
  activateSession(session.id);
  showToast('Session "' + label + '" created');
}

function activateSession(id) {
  // If already active, do nothing
  if (activeSessionId === id) return;

  activeSessionId = id;
  const session = getActiveSession();
  if (!session) return;

  auditDupeCount = session.dupeCount;
  auditErrorCount = session.errorCount;

  document.getElementById('auditCount').textContent = session.scanned.size;
  document.getElementById('auditDupes').textContent = session.dupeCount;
  document.getElementById('auditErrors').textContent = session.errorCount;

  // Rebuild log from session's stored log entries
  const log = document.getElementById('auditLog');
  log.innerHTML = '';
  if (session.logEntries && session.logEntries.length > 0) {
    // Entries are stored oldest-first; prepend so newest shows at top
    session.logEntries.forEach(entry => {
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.innerHTML = entry;
      log.appendChild(div);
    });
  } else {
    logEntry('auditLog', 'code', 'SESSION: ' + session.label + ' — ' + session.scanned.size + ' items loaded');
  }

  const inp = document.getElementById('auditInput');
  inp.disabled = false;
  inp.placeholder = 'Awaiting scan...';
  inp.focus();

  setStatus('auditStatus', 'auditStatusText', 'ready', 'Session "' + session.label + '" active — scan a barcode');
  renderSessionList();
  updateExportButtons();
}

function fmtDate(d) {
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'00');
  return mm + '-' + dd + '-' + yyyy + '_' + hh + '-' + min + '-' + ss;
}

function buildSessionFilename(session) {
  return 'Audit_' + session.label + '_' + fmtDate(session.createdAt) + '-C' + session.scanned.size + '.txt';
}

function buildSessionContent(session) {
  return [...session.scanned].join('\n');
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderSessionList() {
  const list = document.getElementById('sessionList');
  if (auditSessions.length === 0) {
    list.innerHTML = '<div class="session-empty">No sessions yet — create one above</div>';
    return;
  }
  list.innerHTML = auditSessions.map(s => {
    const isActive = s.id === activeSessionId;
    const fname = buildSessionFilename(s);
    return '<div class="session-item' + (isActive ? ' active-session' : '') + '">' +
      '<div class="session-dot' + (isActive ? '' : ' inactive') + '"></div>' +
      '<div class="session-meta' + (!isActive ? ' session-meta-clickable' : '') + '"' +
        (!isActive ? ' onclick="activateSession(\'' + s.id + '\')" title="Click to switch to this session"' : '') + '>' +
        '<div class="session-name">' + escHtml(s.label) + '</div>' +
        '<div class="session-sub">' + escHtml(fname) + '</div>' +
      '</div>' +
      '<span class="session-badge">' + s.scanned.size + ' items</span>' +
      '<div class="session-actions">' +
        (isActive
          ? '<span class="session-btn active-label">Active</span>'
          : '<button class="session-btn" onclick="activateSession(\'' + s.id + '\')">Select</button>') +
        '<button class="session-btn" onclick="downloadSession(\'' + s.id + '\')">&#8595; .txt</button>' +
        '<button class="session-btn del" onclick="deleteSession(\'' + s.id + '\')">&#10005;</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function deleteSession(id) {
  if (!confirm('Delete this session? Data cannot be recovered.')) return;
  auditSessions = auditSessions.filter(s => s.id !== id);
  if (activeSessionId === id) {
    activeSessionId = null;
    auditDupeCount = 0;
    auditErrorCount = 0;
    document.getElementById('auditCount').textContent = '0';
    document.getElementById('auditDupes').textContent = '0';
    document.getElementById('auditErrors').textContent = '0';
    document.getElementById('auditLog').innerHTML = '<div class="session-empty">No active session</div>';
    const inp = document.getElementById('auditInput');
    inp.disabled = true;
    inp.placeholder = 'Select a session first...';
    setStatus('auditStatus', 'auditStatusText', 'ready', 'Create or select a scan session to begin');
  }
  renderSessionList();
  updateExportButtons();
  showToast('Session deleted', 'error');
}

function clearAllSessions() {
  if (auditSessions.length === 0) return;
  if (!confirm('Clear ALL sessions? This cannot be undone.')) return;
  auditSessions = [];
  activeSessionId = null;
  auditDupeCount = 0;
  auditErrorCount = 0;
  document.getElementById('auditCount').textContent = '0';
  document.getElementById('auditDupes').textContent = '0';
  document.getElementById('auditErrors').textContent = '0';
  document.getElementById('auditLog').innerHTML = '<div class="session-empty">No active session</div>';
  const inp = document.getElementById('auditInput');
  inp.disabled = true;
  inp.placeholder = 'Select a session first...';
  setStatus('auditStatus', 'auditStatusText', 'ready', 'Create or select a scan session to begin');
  renderSessionList();
  updateExportButtons();
  showToast('All sessions cleared', 'error');
}

// ---- Scan input ----
// ---- Scan input ----
function auditLogEntry(session, type, message) {
  // Write to visible log
  logEntry('auditLog', type, message);
  // Persist to session (grab the just-prepended element's innerHTML for replay)
  const log = document.getElementById('auditLog');
  if (log.firstChild) {
    if (!session.logEntries) session.logEntries = [];
    // Store at start so array[0] = newest; on restore we append in order so newest ends at top
    session.logEntries.unshift(log.firstChild.innerHTML);
  }
}

document.getElementById('auditInput').addEventListener('keydown', (e) => {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  const session = getActiveSession();
  if (!session) return;

  const val = e.target.value.trim().toUpperCase();
  e.target.value = '';
  if (!val) return;

  if (!isValidBarcode(val)) {
    auditErrorCount++;
    session.errorCount++;
    document.getElementById('auditErrors').textContent = auditErrorCount;
    setStatus('auditStatus', 'auditStatusText', 'error', 'INVALID — "' + val + '" must be exactly 7 alphanumeric chars with both letters and numbers');
    auditLogEntry(session, 'error', 'INVALID: ' + val);
    beep('error');
    flashInput('auditInput', 'error');
    return;
  }

  if (session.scanned.has(val)) {
    auditDupeCount++;
    session.dupeCount++;
    document.getElementById('auditDupes').textContent = auditDupeCount;
    setStatus('auditStatus', 'auditStatusText', 'warn', 'DUPLICATE — "' + val + '" already scanned in this session');
    auditLogEntry(session, 'warn', 'DUPE: ' + val);
    beep('duplicate');
    flashInput('auditInput', 'error');
    return;
  }

  session.scanned.add(val);
  document.getElementById('auditCount').textContent = session.scanned.size;
  setStatus('auditStatus', 'auditStatusText', 'success', 'OK — "' + val + '" logged to "' + session.label + '"');
  auditLogEntry(session, 'ok', 'OK: ' + val);
  beep('success');
  flashInput('auditInput', 'success');
  renderSessionList();
  updateExportButtons();
});

function toggleScanLog() {
  const wrap = document.getElementById('auditLogWrap');
  const btn = document.getElementById('logToggleBtn');
  const isOpen = wrap.style.display !== 'none';
  wrap.style.display = isOpen ? 'none' : 'block';
  btn.classList.toggle('open', !isOpen);
}

function toggleAssetLog() {
  const wrap = document.getElementById('assetLogWrap');
  const btn = document.getElementById('assetLogToggleBtn');
  const isOpen = wrap.style.display !== 'none';
  wrap.style.display = isOpen ? 'none' : 'block';
  btn.classList.toggle('open', !isOpen);
}

// ---- Export ----
function getUniqueCount() {
  const seen = new Set();
  auditSessions.forEach(s => s.scanned.forEach(v => seen.add(v)));
  return seen.size;
}

function updateExportButtons() {
  const total = auditSessions.length;
  const totalItems = auditSessions.reduce((n, s) => n + s.scanned.size, 0);
  const activeHasItems = (getActiveSession()?.scanned.size || 0) > 0;

  document.getElementById('auditDownloadActiveBtn').disabled = !activeHasItems;
  document.getElementById('auditZipBtn').disabled = total === 0;
  document.getElementById('auditCombinedBtn').disabled = totalItems === 0;

  const uniqueCount = getUniqueCount();
  const combinedBtn = document.getElementById('auditCombinedBtn');
  combinedBtn.textContent = uniqueCount > 0 ? '\u29d7 Copy ' + uniqueCount + ' Combined' : '\u29d7 Copy Combined';

  const note = document.getElementById('exportSummaryNote');
  note.textContent = total === 0
    ? 'No sessions to export.'
    : total + ' session' + (total !== 1 ? 's' : '') + ' · ' + totalItems + ' total item' + (totalItems !== 1 ? 's' : '');

  renderCrossDupes();
}

function triggerDownload(filename, content) {
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function downloadSession(id) {
  const session = auditSessions.find(s => s.id === id);
  if (!session || session.scanned.size === 0) { showToast('No scans in this session', 'error'); return; }
  triggerDownload(buildSessionFilename(session), buildSessionContent(session));
  showToast('Downloaded: ' + buildSessionFilename(session));
}

function downloadActiveSession() {
  const session = getActiveSession();
  if (session) downloadSession(session.id);
}

function downloadAllZip() {
  if (auditSessions.length === 0) return;
  const files = auditSessions.map(s => ({ name: buildSessionFilename(s), content: buildSessionContent(s) }));
  const zip = buildZip(files);
  const blob = new Blob([zip], { type: 'application/zip' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'AuditSessions_' + getDateStr() + '.zip';
  a.click();
  showToast('Downloaded ' + files.length + ' sessions as .zip');
}

// ---- Cross-session duplicate detection ----
function getCrossSessionDupes() {
  // Returns Map: serial -> [sessionLabels]
  const seen = new Map(); // serial -> [label, ...]
  auditSessions.forEach(s => {
    s.scanned.forEach(serial => {
      if (!seen.has(serial)) seen.set(serial, []);
      seen.get(serial).push(s.label);
    });
  });
  const dupes = new Map();
  seen.forEach((labels, serial) => {
    if (labels.length > 1) dupes.set(serial, labels);
  });
  return dupes;
}

function renderCrossDupes() {
  const dupes = getCrossSessionDupes();
  const card = document.getElementById('crossDupeCard');
  const list = document.getElementById('crossDupeList');

  if (dupes.size === 0) {
    card.style.display = 'none';
    return;
  }

  card.style.display = 'block';
  document.getElementById('crossDupeCount').textContent = dupes.size + ' found';
  list.innerHTML = '';
  dupes.forEach((labels, serial) => {
    const item = document.createElement('div');
    item.className = 'cross-dupe-item';
    item.innerHTML =
      '<span class="cross-dupe-serial">' + escHtml(serial) + '</span>' +
      '<span class="cross-dupe-sessions">Found in: ' + labels.map(escHtml).join(', ') + '</span>';
    list.appendChild(item);
  });
}

function copyCombined() {
  if (auditSessions.length === 0) return;

  // Deduplicate across sessions — first occurrence wins
  const seen = new Set();
  const lines = [];
  auditSessions.forEach(s => {
    s.scanned.forEach(serial => {
      if (!seen.has(serial)) {
        seen.add(serial);
        lines.push(serial);
      }
    });
  });
  const combined = lines.join('\n');

  navigator.clipboard.writeText(combined).then(() => {
    showToast('Copied ' + lines.length + ' unique items from ' + auditSessions.length + ' sessions');
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = combined;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Combined list copied!');
  });
}

// ---- Pure-JS Zip builder (store, no compression) ----
function buildZip(files) {
  const enc = new TextEncoder();
  const centralDir = [];
  const parts = [];
  let offset = 0;

  files.forEach(file => {
    const nameBytes = enc.encode(file.name);
    const dataBytes = enc.encode(file.content);
    const crc = crc32(dataBytes);
    const now = new Date();
    const dosDate = ((now.getFullYear() - 1980) << 9) | ((now.getMonth() + 1) << 5) | now.getDate();
    const dosTime = (now.getHours() << 11) | (now.getMinutes() << 5) | Math.floor(now.getSeconds() / 2);

    const lhSize = 30 + nameBytes.length;
    const lh = new Uint8Array(lhSize);
    const lhv = new DataView(lh.buffer);
    lhv.setUint32(0, 0x04034b50, true);
    lhv.setUint16(4, 20, true); lhv.setUint16(6, 0, true); lhv.setUint16(8, 0, true);
    lhv.setUint16(10, dosTime, true); lhv.setUint16(12, dosDate, true);
    lhv.setUint32(14, crc, true); lhv.setUint32(18, dataBytes.length, true); lhv.setUint32(22, dataBytes.length, true);
    lhv.setUint16(26, nameBytes.length, true); lhv.setUint16(28, 0, true);
    lh.set(nameBytes, 30);
    parts.push(lh, dataBytes);

    const cdSize = 46 + nameBytes.length;
    const cd = new Uint8Array(cdSize);
    const cdv = new DataView(cd.buffer);
    cdv.setUint32(0, 0x02014b50, true);
    cdv.setUint16(4, 20, true); cdv.setUint16(6, 20, true); cdv.setUint16(8, 0, true); cdv.setUint16(10, 0, true);
    cdv.setUint16(12, dosTime, true); cdv.setUint16(14, dosDate, true);
    cdv.setUint32(16, crc, true); cdv.setUint32(20, dataBytes.length, true); cdv.setUint32(24, dataBytes.length, true);
    cdv.setUint16(28, nameBytes.length, true); cdv.setUint16(30, 0, true); cdv.setUint16(32, 0, true);
    cdv.setUint16(34, 0, true); cdv.setUint16(36, 0, true); cdv.setUint32(38, 0, true);
    cdv.setUint32(42, offset, true);
    cd.set(nameBytes, 46);
    centralDir.push(cd);
    offset += lhSize + dataBytes.length;
  });

  const cdBytes = concatArrays(centralDir);
  const eocd = new Uint8Array(22);
  const ev = new DataView(eocd.buffer);
  ev.setUint32(0, 0x06054b50, true); ev.setUint16(4, 0, true); ev.setUint16(6, 0, true);
  ev.setUint16(8, files.length, true); ev.setUint16(10, files.length, true);
  ev.setUint32(12, cdBytes.length, true); ev.setUint32(16, offset, true); ev.setUint16(20, 0, true);

  return concatArrays([...parts, cdBytes, eocd]);
}

function concatArrays(arrays) {
  let total = 0;
  arrays.forEach(a => total += a.length);
  const out = new Uint8Array(total);
  let pos = 0;
  arrays.forEach(a => { out.set(a, pos); pos += a.length; });
  return out;
}

function crc32(data) {
  let crc = 0xFFFFFFFF;
  for (let i = 0; i < data.length; i++) {
    crc ^= data[i];
    for (let j = 0; j < 8; j++) crc = (crc >>> 1) ^ (crc & 1 ? 0xEDB88320 : 0);
  }
  return (crc ^ 0xFFFFFFFF) >>> 0;
}

// Init export button state
updateExportButtons();

// ===================== NEW ASSET MODE =====================
let assetPairs = [];      // [{asset, serial}, ...]
let assetTagSet = new Set();
let serialSet = new Set();
let assetDupeCount = 0;
let assetErrorCount = 0;

let pendingAssetTag = null; // waiting for serial after asset tag scanned

const assetInput = document.getElementById('assetInput');

function isValidAssetTag(val) {
  return /^[A-Z0-9]{6}$/i.test(val);
}

function isValidSerial(val) {
  if (!/^[A-Z0-9]{7}$/i.test(val)) return false;
  if (!/[A-Z]/i.test(val)) return false;
  if (!/[0-9]/.test(val)) return false;
  return true;
}

function updatePairBoxes() {
  const tagBox = document.getElementById('assetTagBox');
  const serialBoxEl = document.getElementById('serialBox');
  const tagVal = document.getElementById('assetTagValue');
  const serVal = document.getElementById('serialValue');
  const lbl = document.getElementById('assetScanLabel');

  if (!pendingAssetTag) {
    tagBox.className = 'pair-box active';
    serialBoxEl.className = 'pair-box';
    tagVal.className = 'pair-box-value';
    tagVal.textContent = '—';
    serVal.className = 'pair-box-value';
    serVal.textContent = '—';
    lbl.textContent = 'Asset Tag Input';
    assetInput.placeholder = 'Scan 6-digit asset tag...';
  } else {
    tagBox.className = 'pair-box filled';
    serialBoxEl.className = 'pair-box active';
    tagVal.className = 'pair-box-value has-value';
    tagVal.textContent = pendingAssetTag;
    serVal.className = 'pair-box-value';
    serVal.textContent = '—';
    lbl.textContent = 'Serial Number Input';
    assetInput.placeholder = 'Scan 7-char serial number...';
  }
}

assetInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const val = assetInput.value.trim().toUpperCase();
    assetInput.value = '';

    if (!val) return;

    // Step 1: expecting asset tag
    if (!pendingAssetTag) {
      if (!isValidAssetTag(val)) {
        assetErrorCount++;
        document.getElementById('assetErrors').textContent = assetErrorCount;
        setStatus('assetStatus', 'assetStatusText', 'error', `INVALID — "${val}" is not a valid 6-digit asset tag`);
        logEntry('assetLog', 'error', `INVALID ASSET TAG: ${val}`);
        beep('error');
        flashInput('assetInput', 'error');
        return;
      }

      if (assetTagSet.has(val)) {
        assetDupeCount++;
        document.getElementById('assetDupes').textContent = assetDupeCount;
        setStatus('assetStatus', 'assetStatusText', 'warn', `DUPLICATE — Asset tag "${val}" already logged`);
        logEntry('assetLog', 'warn', `DUPE ASSET TAG: ${val}`);
        beep('duplicate');
        flashInput('assetInput', 'error');
        return;
      }

      pendingAssetTag = val;
      setStatus('assetStatus', 'assetStatusText', 'pair-ready', `Asset tag "${val}" captured — now scan serial number`);
      logEntry('assetLog', 'pair', `ASSET TAG: ${val} — awaiting serial`);
      beep('pairReady');
      flashInput('assetInput', 'success');
      updatePairBoxes();
      return;
    }

    // Step 2: expecting serial
    if (!isValidSerial(val)) {
      assetErrorCount++;
      document.getElementById('assetErrors').textContent = assetErrorCount;
      setStatus('assetStatus', 'assetStatusText', 'error', `INVALID — "${val}" must be exactly 7 alphanumeric chars with both letters and numbers`);
      logEntry('assetLog', 'error', `INVALID SERIAL: ${val}`);
      beep('error');
      flashInput('assetInput', 'error');
      return;
    }

    if (serialSet.has(val)) {
      assetDupeCount++;
      document.getElementById('assetDupes').textContent = assetDupeCount;
      setStatus('assetStatus', 'assetStatusText', 'warn', `DUPLICATE — Serial "${val}" already logged`);
      logEntry('assetLog', 'warn', `DUPE SERIAL: ${val}`);
      beep('duplicate');
      flashInput('assetInput', 'error');
      return;
    }

    // Both valid! Log the pair.
    assetTagSet.add(pendingAssetTag);
    serialSet.add(val);
    assetPairs.push({ asset: pendingAssetTag, serial: val });
    document.getElementById('assetCount').textContent = assetPairs.length;

    setStatus('assetStatus', 'assetStatusText', 'success', `PAIR LOGGED — ${pendingAssetTag} / ${val}`);
    logEntry('assetLog', 'ok', `PAIR: ${pendingAssetTag} → ${val}`);
    beep('complete');
    flashInput('assetInput', 'success');

    pendingAssetTag = null;
    updatePairBoxes();
    document.getElementById('assetDownloadBtn').disabled = false;
    updateAssetPreview();
  }
});

function updateAssetPreview() {
  const label = document.getElementById('assetFileName').value;
  const preview = document.getElementById('assetFilePreview');
  const inp = document.getElementById('assetFileName');

  if (!label) {
    preview.textContent = 'Enter a label to preview filename';
    preview.className = 'filename-preview';
    inp.classList.remove('invalid');
    return;
  }

  const v = validateLabel(label);
  if (!v.valid) {
    preview.textContent = '✗ ' + v.reason;
    preview.className = 'filename-preview invalid';
    inp.classList.add('invalid');
    return;
  }

  inp.classList.remove('invalid');
  const count = assetPairs.length;
  const fname = `New_Assets_${label}_${fmtDate(new Date())}-C${count}.txt`;
  preview.textContent = fname;
  preview.className = 'filename-preview valid';
}

function downloadAssets() {
  const label = document.getElementById('assetFileName').value;
  const v = validateLabel(label);
  if (!v.valid) {
    alert('Please fix the filename label: ' + v.reason);
    return;
  }
  if (assetPairs.length === 0) {
    alert('No asset pairs to export.');
    return;
  }

  const count = assetPairs.length;
  const fname = `New_Assets_${label}_${fmtDate(new Date())}-C${count}.txt`;
  const lines = assetPairs.map(p => `${p.asset}\n${p.serial}`).join('\n');
  const content = lines;

  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fname;
  a.click();
}

function clearAssets() {
  if (assetPairs.length > 0 && !confirm('Clear all asset pairs? This cannot be undone.')) return;
  assetPairs = [];
  assetTagSet.clear();
  serialSet.clear();
  assetDupeCount = 0;
  assetErrorCount = 0;
  pendingAssetTag = null;
  document.getElementById('assetCount').textContent = '0';
  document.getElementById('assetDupes').textContent = '0';
  document.getElementById('assetErrors').textContent = '0';
  document.getElementById('assetLog').innerHTML = '';
  document.getElementById('assetDownloadBtn').disabled = true;
  setStatus('assetStatus', 'assetStatusText', 'ready', 'Ready — scan Asset Tag first');
  updatePairBoxes();
  updateAssetPreview();
}

// ===================== MODE SWITCH =====================
function switchMode(mode) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.mode-panel').forEach(p => p.classList.remove('active'));

  if (mode === 'audit') {
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('auditPanel').classList.add('active');
    const inp = document.getElementById('auditInput');
    if (!inp.disabled) setTimeout(() => inp.focus(), 50);
  } else {
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('newassetPanel').classList.add('active');
    setTimeout(() => document.getElementById('assetInput').focus(), 50);
  }
}

// Init focus
window.addEventListener('load', () => {
  // Don't autofocus audit input since it starts disabled
});

// Re-focus scan input when clicking anywhere in the panel
document.getElementById('auditPanel').addEventListener('click', (e) => {
  const skipIds = ['newSessionLabel', 'auditFileName'];
  if (!skipIds.includes(e.target.id) && !e.target.closest('.session-btn') && !e.target.closest('.btn')) {
    const inp = document.getElementById('auditInput');
    if (!inp.disabled) inp.focus();
  }
});

document.getElementById('newassetPanel').addEventListener('click', (e) => {
  if (!['assetFileName'].includes(e.target.id)) {
    document.getElementById('assetInput').focus();
  }
});
</script>
</body>
</html>
